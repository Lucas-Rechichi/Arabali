{% extends 'main/template.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load main_filters %}

<!-- Title of the page -->
{% block title %}
    {{username}}
{% endblock %}

<!-- For the sidebar -->
{% block topsidebar %}
    <li class="custom-icon"><div class="fs-4"><i class="bi bi-person" style="color: #787878;"></i></div> <a href="/profile/{{username}}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Profile</p></a></li>
{% endblock %}

{% block middlesidebar %}
    <li class="custom-icon"><div class="fs-4"><i class="bi bi-gear-wide-connected" style="color: #787878;"></i></div> <a href="/settings/{{username}}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Settings</p></a></li>
{% endblock %}

<!-- For the search bar -->
{% block searchBar %}
    {{search_bar| crispy}}
{% endblock %}

<!-- For page specific CDN's -->
{% block cdns %}
    <script src="https://unpkg.com/culori"></script>
{% endblock %}

<!-- For page specific scripts -->
{% block scripts %}
    <script type="module" src="{% static 'main/add_post_page/add_post.js'%}"></script>
    <script type="module" src="{% static 'main/add_post_page/functions.js'%}"></script>
    <script type="module" src="{% static 'forms/colour-picker.js'%}"></script>
    <script type="text/javascript" src="{% static 'universal/notifications.js'%}"></script>
    <script type="text/javascript" src="{% static 'websockets/post_socket.js' %}"></script>
    <script type="text/javascript" src="{% static 'websockets/notification_socket.js' %}"></script>
{% endblock %}

<!-- For page specific css styles -->
{% block styles %}
    <link rel="stylesheet" href="{% static 'main/posts.css' %}">
    <link rel="stylesheet" href="{% static 'main/add_post.css' %}">
    <link rel="stylesheet" href="{% static 'forms/drag_and_drop.css' %}">
    <link rel="stylesheet" href="{% static 'forms/validation.css' %}">
    <link rel="stylesheet" href="{% static 'forms/colour-picker.css'%}">
{% endblock %}

<!-- Notifications -->
{% block notifications %}
    <!-- loops though all notifications sent to the document -->
    {% for notification in notifications.values %}
        <div id="notification-{{notification.notification_object.pk}}" class="card mb-2" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
            <div class="card-header">
                <button class="btn p-0" onclick='location.href="/chat/{{notification.notification_object.source.name}}/{{notification.notification_object.source.pk}}"' id="read-notification-{{notification.notification_object.pk}}">
                    <img src="{{notification.notification_object.source.icon.url}}" class="rounded me-2" alt="" style="height: 2.5rem; width: 2.5rem">
                </button>
                <button class="btn p-0 pe-2" onclick="location.href='/chat/{{notification.notification_object.source.name}}/{{notification.notification_object.source.pk}}'" id="read-notification-{{notification.notification_object.pk}}">
                    <strong class="me-auto">{{notification.notification_object.source.name}}</strong>
                </button>
                <small class="text-muted pe-2">{{notification.notification_object.timestamp}}</small>
                <button type="button ms-2" class="btn-close" id="close-notification-{{notification.notification_object.pk}}" aria-label="Close"></button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <img src="{{notification.sender_pfp_url}}" class="rounded me-2" alt="" style="height: 2.5rem; width: 2.5rem">
                        <em>{{notification.notification_object.sender}}</em>
                    </div>
                </div>
                <div class="row">
                    <div class="col mt-2">
                        {% if notification.notification_object.relevant_message.text %}
                            <p class="text-truncate">{{notification.notification_object.contents}}</p>
                        {% elif notification.notification_object.relevant_poll %}
                            <p class="text-truncate"><strong>Poll: </strong>{{notification.notification_object.contents}}</p>
                        {% else %}
                            {% if notification.notification_object.relevant_message.reply %}
                                {% if notification.notification_object.relevant_message.image %}
                                    <p class="text-truncate">({{notification.notification_object.relevant_message.sender.user.username}} Replied to You): <strong>Image</strong></p>
                                {% elif notification.notification_object.relevent_message.video %}
                                    <p class="text-truncate">({{notification.notification_object.relevant_message.sender.user.username}} Replied to You): <strong>Video</strong></p>
                                {% elif notification.notification_object.relvevant_message.audio %}
                                    <p class="text-truncate">({{notification.notification_object.relevant_message.sender.user.username}} Replied to You): <strong>Audio</strong></p>
                                {% else %}
                                {% endif %}
                            {% else %}
                            <p class="text-truncate"><strong>{{notification.notification_object.contents}}</strong></p>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
{% endblock %}

<!-- For the notification counter -->
{% block notification_count %} 
    {{ notification_count }}
{% endblock %}

<!-- Main segment of HTML document -->
{% block body %}
<div class="container">
  <div class="card">
    <img src="{{ userstats.banner.url }}" class="card-img-top" alt="{{userstats.user.username|correct_apostrophe}} banner image"/>
    <br>
    <div class="card-body">
      <div class="row">
        <div class="col-6">
          <h6 class="display-6 text-center m-2">Posts:</h6>
          <hr>
          <div class="row d-flex justify-content-center">
            {% for user_post in user_posts_data %}
              <div class="col-5 m-2">
                <div class="card">
                  <button class="btn p-0 m-0", onclick='location.href = "/posts/{{user_post.post_id}}"'>
                    <img src="{{user_post.post_media_url}}" style="max-width: 100%; max-height: 100%; border-radius: 3%;">
                    <div class="card-body">
                      <h5>{{user_post.post_title}}</h5>
                    </div>
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
        <div class="col-6">
          <h5 class="display-5 text-center">{{user.username}}</h5>
          <hr>
          <div class="row">
            <div class="col d-flex justify-content-center">
              <img src="{{ userstats.pfp.url }}" alt="" class="border border-success rounded-circle border-2 mb-2" style="max-width: 8rem; max-height: 8rem;"/>
            </div>
            <div class="col">
              <div class="row">
                <div class="col">
                  <button class="btn btn-outline-success border border-success mt-4" data-bs-toggle="modal" data-bs-target="#followers"><div class="fs-4"><i class="bi bi-people"></i></div> Followers: {{userstats.followers}}</button>
                  <div class="modal fade" id="followers">
                    <div class="modal-dialog modal-dialog-scrollable">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h3>Followers:</h3>
                          <button class="btn-close" data-bs-dismiss="modal" data-bs-target="#followers"></button>
                        </div>
                        <div class="modal-body">
                          {% for follower in followed_users %}
                            {% for x in follower %}
                              <button class="invis" style="width: 300px;" onclick='location.href = "/profile/{{x.user}}"'>
                                <div class="row">
                                  <div class="column col-3">
                                    <img src="{{x.pfp.url}}" alt="{{x.user}}'s pfp" style="height: 50px; width: 50px;" class="border border-success rounded-circle border-2">
                                  </div>
                                  <div class="column col-6 pt-2">
                                    {{x.user}}
                                  </div>  
                                </div>
                              </button>
                            {% endfor %}
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col">
                  {% if self_profile %}
                  {% else %}
                    <form action="" method="post">
                      {% csrf_token %} 
                      {% if is_following %}
                        <button type="submit" name="follow" value="unfollow" class="btn btn-outline-success mt-4">
                          <div class="fs-4"><i class="bi bi-person-dash"></i></div>
                          Unfollow
                        </button>
                      {% else %}
                        <button type="submit" name="follow" value="follow" class="btn btn-outline-success mt-4">
                          <div class="fs-4"><i class="bi bi-person-plus"></i></div>
                          Follow
                        </button>
                      {% endif %}
                    </form>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Websockets for recieving notifications -->
<script type="text/javascript">
  let notificationSocket;
  let reconnectionTime = 5000; // time between disconnection and an attempt to reconnect to the websocket

  function connectNotificationSocket() { // function for connecting to the websocket.
      notificationSocket = new WebSocket(
          'ws://' + window.location.host + '/ws/brodcast-message/'
      ); // connect to the relevant consumer class: NotificationConsumer

      notificationSocket.onopen = function(e) {
          console.log('connected', e);
      };

      notificationSocket.onmessage = function(e) { // when the consumer class sends a message through
          console.log('Message coming through!');
          const data = JSON.parse(e.data); // reconfigures the data so that it can be used within our function.

          if (data.receiver === '{{user.username}}') { // if the data belongs to this specific user
              $('#inbox').append(data.html_notification_popup); // adds HTML to the inbox div, which stores notification toasts
              $('#notification-inbox').prepend(data.stored_html_notification); // adds HTML to the notification div that houses the notifications in the off-canvas
              
              // Update notification count
              var notificationCounter = $('#notification-counter');
              var newCount = parseInt(notificationCounter.text()) || 0;
              notificationCounter.text(newCount + 1).show();
              
              if ($('#bell-icon').hasClass('bi-bell')) { // if the bell looks like it has 0 notifications
                  $('#bell-icon').removeClass('bi-bell');
                  $('#bell-icon').addClass('bi-bell-fill');
              }

              var notificationElement = document.getElementById('popup-notification-' + data.notification_id); // gets the newly created popup notification toast

              if (notificationElement) {
                  var notification = new bootstrap.Toast(notificationElement); // creates a bootstrap toast
                  // Show the toast
                  notification.show();
              } else {
                  console.error('Notification element not found:', 'notification-' + data.notification_id);
              }

              // Attach event handlers to the newly added notification
              attachNotificationEventHandlers(data.notification_id, data.receiver);
          } else {
              console.log('incorrect user');
          }
      };

      notificationSocket.onerror = function(e) {
          console.error('WebSocket encountered an error:', e);
      };

      notificationSocket.onclose = function(e) {
          console.error('WebSocket closed unexpectedly:', e);
          setTimeout(connectNotificationSocket, reconnectionTime); // attempt a reconnection to this websocket
      };
  }

  function attachNotificationEventHandlers(notificationId, receiver) {
      $(`#close-notification-${notificationId}`).click(function() {
          $.ajax({
              type: 'POST',
              url: '/universal/remove-notification/',
              data: {
                  'receiver': receiver,
                  'type': 'notification-id',
                  'csrfmiddlewaretoken': '{{ csrf_token }}',
                  'notification_id': notificationId,
              },
              success: function(response) {
                  console.log(response.message);
                  var notification = $(`#stored-notification-${notificationId}`);
                  notification.remove();
                  var notificationCounter = $('#notification-counter');
                  var newCount = parseInt(notificationCounter.text()) - 1;

                  if (newCount <= 0) {
                      notificationCounter.text('').hide();
                      $('#bell-icon').removeClass('bi-bell-fill').addClass('bi-bell');
                  } else {
                      notificationCounter.text(newCount);
                  }
              }
          });
      });

      $(`#read-notification-${notificationId}`).click(function() {
          $.ajax({
              type: 'POST',
              url: '/universal/remove-notification/',
              data: {
                  'receiver': receiver,
                  'type': 'notification-id',
                  'csrfmiddlewaretoken': '{{ csrf_token }}',
                  'notification_id': notificationId,
              },
              success: function(response) {
                  console.log(response.message);
              }
          });
      });
  }

  $(document).ready(function() {
      if ('{{ notification_count }}' == '0') {
          var notification_counter = $('#notification-counter');
          notification_counter.text('').hide();
          var notification_bell = $('#bell-icon');
          notification_bell.removeClass('bi-bell-fill').addClass('bi-bell');
      } else {
          var notificationCounter = $('#notification-counter');
          notificationCounter.text('{{ notification_count }}').show();
          $('#bell-icon').removeClass('bi-bell').addClass('bi-bell-fill');
      }
  });

  connectNotificationSocket(); // connect to the relevant websocket
</script>
<!-- To store notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="inbox">

</div>
{% endblock %}
{% extends 'main/template.html' %}
{% load crispy_forms_tags %}
{% block title %}Search Results for: {{query}}{% endblock %}
{% block topsidebar %}
<li class="custom-icon"><div class="fs-4"><i class="bi bi-person" style="color: #787878;"></i></div> <a href="/profile/{{username}}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Profile</p></a></li>
{% endblock %}
{% block middlesidebar %}
<li class="custom-icon"><div class="fs-4"><i class="bi bi-gear-wide-connected" style="color: #787878;"></i></div> <a href="/settings/{{username}}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Settings</p></a></li>
{% endblock %}
{% block searchBar %}
{{search_bar| crispy}}
{% endblock %}
{% block notifications %}
    <!-- loops though all notifications sent to the document -->
    {% for notification in notifications.values %}
        <div id="notification-{{notification.notification_object.pk}}" class="card mb-2" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
            <div class="card-header">
                <button class="btn p-0" onclick='location.href="/chat/{{notification.notification_object.source.name}}/{{notification.notification_object.source.pk}}"' id="read-notification-{{notification.notification_object.pk}}">
                    <img src="{{notification.notification_object.source.icon.url}}" class="rounded me-2" alt="" style="height: 2.5rem; width: 2.5rem">
                </button>
                <button class="btn p-0 pe-2" onclick="location.href='/chat/{{notification.notification_object.source.name}}/{{notification.notification_object.source.pk}}'" id="read-notification-{{notification.notification_object.pk}}">
                    <strong class="me-auto">{{notification.notification_object.source.name}}</strong>
                </button>
                <small class="text-muted pe-2">{{notification.notification_object.timestamp}}</small>
                <button type="button ms-2" class="btn-close" id="close-notification-{{notification.notification_object.pk}}" aria-label="Close"></button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <img src="{{notification.sender_pfp_url}}" class="rounded me-2" alt="" style="height: 2.5rem; width: 2.5rem">
                        <em>{{notification.notification_object.sender}}</em>
                    </div>
                </div>
                <div class="row">
                    <div class="col mt-2">
                        <p class="text-truncate ">{{notification.notification_object.contents}}</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- script for removing notifications if a user dismisses the notification or chjecks out the notification. -->
        <script> 
            $(document).ready(function () {
                $('#close-notification-{{notification.notification_object.pk}}').click(function () {
                    $.ajax({
                        type: 'POST',
                        url: '/universal/remove-notification/',
                        data: {
                            'receiver': '{{user.username}}',
                            'type': 'notification-id',
                            'csrfmiddlewaretoken': '{{ csrf_token }}',
                            'notification_id': '{{notification.notification_object.pk}}'
                        },
                        success: function(response) {
                            console.log(response.notification_count, response.notification_counter)
                            var notification = $("#notification-{{notification.notification_object.pk}}")
                            notification.remove();
                            $('#notification-counter').text('');
                            $('#notification-counter').text(response.notification_count);
                                if (response.notification_count == 0) {
                                    $('#notification-counter').text(response.notification_count).hide();
                                    $('#notification-counter').remove();
                                    $('#bell-icon').removeClass('bi-bell-fill');
                                    $('#bell-icon').addClass('bi-bell');
                                }
                        }
                    })
                })
                $('#read-notification-{{notification.notification_object.pk}}').click(function () {
                    $.ajax({
                        type: 'POST',
                        url: '/universal/remove-notification/',
                        data: {
                            'receiver': '{{user.username}}',
                            'type': 'notification-id',
                            'csrfmiddlewaretoken': '{{ csrf_token }}',
                            'notification_id': '{{notification.notification_object.pk}}'
                        },
                        success: function(response) {
                            console.log(response.message)
                        }
                    })
                })
            })
        </script>
    {% endfor %}
{% endblock %}
<!-- for the notification counter -->
{% block notification_count %} 
    {{ notification_count }}
{% endblock %}
{% block body %}
<div class="container">
    <div class="row">
        <div class="col">
            <br>
            <div class="card">
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <em><p class="lead text-center">You searched for: '{{query}}'</p></em>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-4">
                            <h6 class="display-6 text-center">Posts</h6>
                            <hr>
                            <!-- loops though all Exact post solutions -->
                            {% for id, result in feed.exact.posts.items %}
                                <div class="row">
                                    <div class="col">
                                        <!-- redirects users to that specific post -->
                                        <a href="/posts/{{result.id}}" role="button" class="link-success link-offset-2 link-underline-opacity-0"><p class="lead text-center">{{result.name}}</p></a>    
                                    </div>
                                </div>
                                <hr>
                            {% endfor %}
                            <!-- same for approx solutions -->
                            {% for id, result in feed.approx.posts.items %}
                                <div class="row">
                                    <div class="col">
                                        <a href="/posts/{{result.id}}" role="button" class="link-success link-offset-2 link-underline-opacity-0"><p class="lead text-center">{{result.name}}</p></a>
                                    </div>
                                </div>
                                <hr>
                            {% endfor %}
                            <!-- Pageination -->
                            <div class="col d-flex justify-content-center">
                                {% if post_increment.previous == 0 %}
                                    <button class="btn btn-outline-success" disabled><i class="bi bi-arrow-left-circle"></i> Previous</button>
                                {% else %}
                                    <button class="btn btn-outline-success" onclick='location.href = "/search/{{query}}/{{post_increment.previous}}/{{user_increment.current}}/{{category_increment.current}}"'><i class="bi bi-arrow-left-circle"></i> Previous</button>
                                {% endif %}
                                <p class="lead ps-2 pe-2 mt-2">Page No. {{post_increment.current}} </p>
                                <button class="btn btn-outline-success" onclick='location.href = "/search/{{query}}/{{post_increment.next}}/{{user_increment.current}}/{{category_increment.current}}"'>Next <i class="bi bi-arrow-right-circle"></i></button>
                            </div>
                        </div>
                        <div class="col-4">
                            <h6 class="display-6 text-center">Users</h6>
                            <hr>
                            {% for id, result in feed.exact.users.items %}
                                <div class="row">
                                    <div class="col">
                                        <a href="/profile/{{result.name}}" role="button" class="link-success link-offset-2 link-underline-opacity-0"><p class="lead text-center">{{result.name}}</p></a>      
                                    </div>
                                </div>
                                <hr>
                            {% endfor %}
                            {% for id, result in feed.approx.users.items %}
                                <div class="row">
                                    <div class="col">
                                        <a href="/profile/{{result.name}}" role="button" class="link-success link-offset-2 link-underline-opacity-0"><p class="lead text-center">{{result.name}}</p></a>      
                                    </div>
                                </div>
                                <hr>
                            {% endfor %}
                            <div class="col d-flex justify-content-center">
                                {% if user_increment.previous == 0 %}
                                    <button class="btn btn-outline-success" disabled><i class="bi bi-arrow-left-circle"></i> Previous</button>
                                {% else %}
                                    <button class="btn btn-outline-success" onclick='location.href = "/search/{{query}}/{{post_increment.current}}/{{user_increment.previous}}/{{category_increment.current}}"'><i class="bi bi-arrow-left-circle"></i> Previous</button>
                                {% endif %}
                                <p class="lead ps-2 pe-2 mt-2">Page No. {{user_increment.current}} </p>
                                <button class="btn btn-outline-success" onclick='location.href = "/search/{{query}}/{{post_increment.current}}/{{user_increment.next}}/{{category_increment.current}}"'>Next <i class="bi bi-arrow-right-circle"></i></button>
                            </div>
                        </div>
                        <div class="col-4">
                            <h6 class="display-6 text-center">Catergories</h6>
                            <hr>
                            {% for id, result in feed.exact.tags.items %}
                                <div class="row">
                                    <div class="col">
                                        <a href="/page/popular|{{result.name}}/1" role="button" class="link-success link-offset-2 link-underline-opacity-0"><p class="lead text-center">{{result.name}}</p></a>      
                                    </div>
                                </div>
                                <hr>
                            {% endfor %}
                            {% for id, result in feed.approx.tags.items %}
                                <div class="row">
                                    <div class="col">
                                        <a href="/page/popular|{{result.name}}/1" role="button" class="link-success link-offset-2 link-underline-opacity-0"><p class="lead text-center">{{result.name}}</p></a>  
                                    </div>
                                </div>
                                <hr>
                            {% endfor %}
                            <div class="col d-flex justify-content-center">
                                {% if category_increment.previous == 0 %}
                                    <button class="btn btn-outline-success" disabled><i class="bi bi-arrow-left-circle"></i> Previous</button>
                                {% else %}
                                    <button class="btn btn-outline-success" onclick='location.href = "/search/{{query}}/{{post_increment.current}}/{{user_increment.current}}/{{category_increment.previous}}"'><i class="bi bi-arrow-left-circle"></i> Previous</button>
                                {% endif %}
                                <p class="lead ps-2 pe-2 mt-2">Page No. {{category_increment.current}} </p>
                                <button class="btn btn-outline-success" onclick='location.href = "/search/{{query}}/{{post_increment.current}}/{{user_increment.current}}/{{category_increment.next}}"'>Next <i class="bi bi-arrow-right-circle"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Websockets for recieving notifications -->
<script type="text/javascript">
    const notificationSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/brordcast-message/'
    );
    notificationSocket.onopen = function() {
        
    };

    notificationSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log(data)
        $('#inbox').append(data.html_notification_popup);
        $('#notification-inbox').append(data.stored_html_notification);
        $('#inbox').append(data.script)
        if ($('#bell-icon').hasClass('bi-bell')) {
            $('#bell-icon').removeClass('bi-bell')
            $('#bell-icon').addClass('bi-bell-fill')
        }
        $('#notification-indicatior').append(`<span class="top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notification-counter">` + data.notification_count + ``)
        var notificationElement = document.getElementById('notification-' + data.notification_id);
        var notification = new bootstrap.Toast(notificationElement);

        // Show the toast
        notification.show();


    };

    notificationSocket.onerror = function(e) {
        console.error('WebSocket encountered an error:', e);
    };

    notificationSocket.onclose = function(e) {
        console.error('WebSocket closed unexpectedly:', e);
    };
</script>
<!-- To store notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="inbox">

</div>
{% endblock %}
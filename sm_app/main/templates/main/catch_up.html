{% load crispy_forms_tags %}
{% load static  %}
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="csrf-token" content="{{ csrf_token }}">
        <meta name="username" content="{{ username }}">
        <meta name="notification-count" content="{{ notification_count }}">
        <title>Feed | Arabali</title>
        <!-- CDN's -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <!-- SCRIPTS -->
        <script type="text/javascript" src="{% static 'main/posts.js' %}"></script>
        <script type="text/javascript" src="{% static 'main/location_permissions.js'%}"></script>
        <script type="text/javascript" src="{% static 'algorithum/scrolled_by.js'%}"></script>
        <script type="text/javascript" src="{% static 'algorithum/load_posts.js'%}"></script>
        <script type="text/javascript" src="{% static 'universal/notifications.js'%}"></script>
        <script type="text/javascript" src="{% static 'websockets/post_socket.js' %}"></script>
        <script type="text/javascript" src="{% static 'websockets/notification_socket.js' %}"></script>
        <!-- STYLES -->
        <link rel="stylesheet" href="{% static 'universal/sidebar.css' %}">
    </head>
    <body>
        <nav class="navbar navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
                <div class="container">
                    <div class="row">
                        <div class="col-4">
                            <a href="/page/recommended|All/1" role="button" class="display-6 link-success link-offset-2 link-underline-opacity-0">Arabali</a>
                        </div>
                        <div class="col-4">
                            <form action="/search/q/1/1/1" method="post">
                                {% csrf_token %}
                                <div class="container">
                                    <div class="row">
                                        <div class="col-3">
                                        </div>
                                        <div class="col-6">
                                            {{search_bar|crispy}}
                                        </div>
                                        <div class="col-3">
                                            <button type="submit" class="btn btn-outline-success"><i class="bi bi-search"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="col-4 d-flex justify-content-end">
                            <div class="row">
                                <div class="col-6">
                                    <button class="btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasnav" aria-controls="offcanvasnav" style="height: 40px; width: fit-content;">
                                        <div class="fs-2"><i class="bi bi-list" style="color: #198754;"></i></div>
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasnotify" aria-controls="staticBackdrop">
                                        <div class="fs-2"><i class="bi bi-bell-fill" id="bell-icon" style="color: #198754;"></i></div>
                                        <span class="top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notification-counter">{{ notification_count }}</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> 
        </nav>
        <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasnav" aria-labelledby="offcanvasnav">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasExampleLabel"><p class="lead">More</p></h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <div class="container">
                    <div class="row">
                        <div class="col-12 p-2">
                            <ul>
                                <li class="custom-icon"><div class="fs-4"><i class="bi bi-person" style="color: #787878;"></i></div> <a href="/profile/{{username}}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Profile</p></a></li>
                                <li class="custom-icon"><div class="fs-4"><i class="bi bi-rss-fill" style="color: #787878;"></i></div> <a href="/page/recommended|All/1" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Feed</p></a></li>
                                <li class="custom-icon"><div class="fs-4"><i class="bi bi-chat-text" style="color: #787878;"></i></div> <a href="/chat/" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Messages</p></a></li>
                                <li class="custom-icon"><div class="fs-4"><i class="bi bi-gear-wide-connected" style="color: #787878;"></i></div> <a href="/settings/{{username}}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Settings</p></a></li>
                                <li class="custom-icon"><div class="fs-4"><i class="bi bi-box-arrow-right" style="color: #787878;" ></i></div> <a href="/logout/" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Logout</p></a></li>                       
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="offcanvas offcanvas-end" data-bs-backdrop="static" tabindex="-1" id="offcanvasnotify" aria-labelledby="staticBackdropLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title">Notifications</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <div id="notification-inbox" style="overflow-y: auto;">
                    <!-- loops though all notifications sent to the document -->
                    {% for notification in notifications.values %}
                        <div id="notification-{{notification.notification_object.pk}}" class="card mb-2" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
                            <div class="card-header">
                                <button class="btn p-0" onclick='location.href="/chat/{{notification.notification_object.source.name}}/{{notification.notification_object.source.pk}}"' id="read-notification-{{notification.notification_object.pk}}">
                                    <img src="{{notification.notification_object.source.icon.url}}" class="rounded me-2" alt="" style="height: 2.5rem; width: 2.5rem">
                                </button>
                                <button class="btn p-0 pe-2" onclick="location.href='/chat/{{notification.notification_object.source.name}}/{{notification.notification_object.source.pk}}'" id="read-notification-{{notification.notification_object.pk}}">
                                    <strong class="me-auto">{{notification.notification_object.source.name}}</strong>
                                </button>
                                <small class="text-muted pe-2">{{notification.notification_object.timestamp}}</small>
                                <button type="button ms-2" class="btn-close" id="close-notification-{{notification.notification_object.pk}}" aria-label="Close"></button>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col">
                                        <img src="{{notification.sender_pfp_url}}" class="rounded me-2" alt="" style="height: 2.5rem; width: 2.5rem">
                                        <em>{{notification.notification_object.sender}}</em>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col mt-2">
                                        {% if notification.notification_object.relevant_message.text %}
                                            <p class="text-truncate">{{notification.notification_object.contents}}</p>
                                        {% elif notification.notification_object.relevant_poll %}
                                            <p class="text-truncate"><strong>Poll: </strong>{{notification.notification_object.contents}}</p>
                                        {% else %}
                                            {% if notification.notification_object.relevant_message.reply %}
                                                {% if notification.notification_object.relevant_message.image %}
                                                    <p class="text-truncate">({{notification.notification_object.relevant_message.sender.user.username}} Replied to You): <strong>Image</strong></p>
                                                {% elif notification.notification_object.relevent_message.video %}
                                                    <p class="text-truncate">({{notification.notification_object.relevant_message.sender.user.username}} Replied to You): <strong>Video</strong></p>
                                                {% elif notification.notification_object.relvevant_message.audio %}
                                                    <p class="text-truncate">({{notification.notification_object.relevant_message.sender.user.username}} Replied to You): <strong>Audio</strong></p>
                                                {% else %}
                                                {% endif %}
                                            {% else %}
                                            <p class="text-truncate"><strong>{{notification.notification_object.contents}}</strong></p>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <br>
        <br>
        <input type="hidden" id="locationModalActivation" data-location="{{location_pop_up}}">
        <!-- Modal for getting user's location access -->
        <div class="modal fade" id="LPModal" tabindex="-1" aria-hidden="true" aria-modal="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Location Premissions</h5>
                    </div>
                    <div class="modal-body">
                        <p class="lead text-center"> To be able to optimise the algorithum to show you the best of your the people that you follow, location permissions must be allowed. </p>
                        <p class="text-center"><strong> If you deside not to allow permisssions, this page is still accessible, and your last recorded location will be used instead.</strong></p>
                        <div class="d-flex justify-content-center">
                            <button id="allowedLP" type="button" class="btn btn-success m-1">Allow</button>
                            <button id="deniedLP" type="button" class="btn btn-outline-success m-1" data-bs-dismiss="modal">Deny</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- LP allowed modal -->
        <div class="modal fade" id="LPModalAllow" tabindex="-1" aria-hidden="true" aria-modal="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" >Success</h5>
                    </div>
                    <div class="modal-body">
                        <p class="lead text-center"> Location Permissions Accessed. </p>
                        <div class="d-flex justify-content-center">
                            <div class="fs-2"><i class="bi bi-patch-check-fill" style="color: #198754;"></i></div>
                        </div>
                        <br>
                        <div class="d-flex justify-content-center">
                            <button type="button" class="btn btn-success m-1" data-bs-dismiss="modal" id="">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-6">
                    <div class="card" id="post-card">
                        <div class="row">
                            <div class="col-12 d-flex justify-content-evenly mt-4">
                                <button class="btn mt-3" onclick='location.href = "/add/"' style="height: 40px; width: fit-content;"><div class="fs-2"><i class="bi bi-file-earmark-plus" style="color: #198754;"></i></div></button>
                                <h2 class="display-4"> Hello {{username}} </h2>
                                <p></p>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            {% for dailyPost in daily_posts %}
                                <div class="col-12">
                                    <div class="card m-5">
                                        <div class="row">
                                            <div class="col m-2">
                                                {% for key, value in post_users.items %}
                                                    {% if key|stringformat:"%s%s" == dailyPost.user|stringformat:"%s%s" %}
                                                        <button class="btn btn-light"><img src="{{ value }}" alt="{{dailyPost.user}}'s Profile Picture" onclick='location.href = "/profile/{{dailyPost.user}}"' style="width: 30px; height: 30px;"></button>
                                                    {% else %}
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col m-2">
                                                <h6 class="display-6">{{dailyPost.user}}</h6>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col m-2">
                                                <img src="{{dailyPost.media.url}}" alt="Post: {{dailyPost.title}}'s Media" class="post-no-{{dailyPost.id}}" style="height: 248px; width: 100%;" id="post-{{dailyPost.id}}" data-post-id="{{dailyPost.id}}">
                                            </div>
                                        </div>
                                        <div class="row m-2">
                                            <div class="col">
                                                <h3 class="display-6">{{dailyPost.title}}</h3>
                                            </div>
                                        </div>
                                            <div class="row m-1">
                                                <div class="col">
                                                    <p class="lead">{{dailyPost.contents}}</p>
                                                </div>
                                            </div>
                                            <div class="row m-1">
                                                <div class="col-6 d-flex justify-content-start">
                                                    <button type="button" class="btn" data-bs-target="#expand-{{dailyPost.id}}" data-bs-toggle="modal"><i class="bi bi-three-dots"></i></button>
                                                </div>
                                                <div class="col-6 d-flex justify-content-end">
                                                    {% if user_liked_by in dailyPost.liked_by.all %}
                                                        <button type="button" class="btn btn-success border border-success like-button like-button-{{dailyPost.id}} d-flex align-items-center pb-3 pt-2" data-post-id="{{dailyPost.id}}" style="height: 25px;">
                                                            <div class="row align-items-center">
                                                                <div class="col mt-1 d-flex justify-content-end">
                                                                    <i class="bi bi-hand-thumbs-up-fill" id="page-like-icon-{{dailyPost.id}}" style="color: #ffffff;"></i>
                                                                </div>
                                                                <div class="col mt-4">
                                                                    <p class="text-white" id="page-like-text-{{dailyPost.id}}">{{dailyPost.likes}}</p>
                                                                </div>
                                                            </div>
                                                        </button>
                                                    {% else %}
                                                        <button type="button" class="btn border border-success like-button like-button-{{dailyPost.id}} d-flex align-items-center pb-3 pt-2" data-post-id="{{dailyPost.id}}" style="height: 25px;">
                                                            <div class="row align-items-center">
                                                                <div class="col mt-1 d-flex justify-content-end">
                                                                    <i class="bi bi-hand-thumbs-up" id="page-like-icon-{{dailyPost.id}}" style="color: #198754;"></i>
                                                                </div>
                                                                <div class="col mt-4">
                                                                    <p class="text-success" id="page-like-text-{{dailyPost.id}}">{{dailyPost.likes}}</p>
                                                                </div>
                                                            </div>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </div>    
                                        </div>
                                    </div>
                                    <!-- modal -->
                                    <div id="expand-{{dailyPost.id}}" class="modal fade">
                                        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    Post
                                                    <button class="btn btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <div class="col m-2">
                                                            {% for key, value in post_users.items %}
                                                                {% if key|stringformat:"%s%s" == dailyPost.user|stringformat:"%s%s" %}
                                                                    <button class="btn btn-light" style="border-radius: 15px; width: fit-content; height: fit-content;"><img src="{{ value }}" alt="{{dailyPost.user}}'s Profile Picture" onclick='location.href = "/profile/{{dailyPost.user}}"' style="width: 30px; height: 30px;"></button>
                                                                {% else %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col m-2">
                                                            <h6 class="display-6">{{dailyPost.user}}</h6>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col m-2">
                                                            <img src="{{dailyPost.media.url}}" alt="Post: {{dailyPost.title}}'s Media" style="height: 248px; width: 100%;">
                                                        </div>
                                                    </div>
                                                    <div class="row m-2">
                                                        <div class="col">
                                                            <h3 class="display-6">{{dailyPost.title}}</h3>
                                                        </div>
                                                    </div>
                                                    <div class="row m-1">
                                                        <div class="col">
                                                            <p class="lead">{{dailyPost.contents}}</p>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-4">
                                                            <a class="btn btn-success" data-bs-toggle="collapse" href="#liked-by-{{dailyPost.id}}" role="button" aria-expanded="false" aria-controls="liked-by-{{dailyPost.id}}">Liked By</a> 
                                                        </div>
                                                        <div class="col-8 d-flex justify-content-end">
                                                            {% if user_liked_by in dailyPost.liked_by.all %}
                                                                <button type="button" class="btn btn-success border border-success like-button like-button-{{dailyPost.id}} d-flex align-items-center pb-3 pt-2" data-post-id="{{dailyPost.id}}" style="height: 25px;">
                                                                    <div class="row align-items-center">
                                                                        <div class="col mt-1 d-flex justify-content-end">
                                                                            <i class="bi bi-hand-thumbs-up-fill" id="modal-like-icon-{{dailyPost.id}}" style="color: #ffffff;"></i>
                                                                        </div>
                                                                        <div class="col mt-4">
                                                                            <p class="text-white" id="modal-like-text-{{dailyPost.id}}">{{dailyPost.likes}}</p>
                                                                        </div>
                                                                    </div>
                                                                </button>
                                                            {% else %}
                                                                <button type="button" class="btn border border-success like-button like-button-{{dailyPost.id}} d-flex align-items-center pb-3 pt-2" data-post-id="{{dailyPost.id}}" style="height: 25px;">
                                                                    <div class="row align-items-center">
                                                                        <div class="col mt-1 d-flex justify-content-end">
                                                                            <i class="bi bi-hand-thumbs-up" id="modal-like-icon-{{dailyPost.id}}" style="color: #198754;"></i>
                                                                        </div>
                                                                        <div class="col mt-4">
                                                                            <p class="text-success" id="modal-like-text-{{dailyPost.id}}">{{dailyPost.likes}}</p>
                                                                        </div>
                                                                    </div>
                                                                </button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col">
                                                            <div class="collapse card m-1" id="liked-by-{{dailyPost.id}}">
                                                                <ul class="list-group list-group-flush">
                                                                    {% for likedby in dailyPost.liked_by.all %}
                                                                        <button type="button" class="btn mb-2 d-inline-flex">
                                                                            <!-- adding profile pictures -->
                                                                            <img src=""  style="width: 30px; height: 30px;">
                                                                            <p class="p-0 m-0 ms-2">{{likedby}}</p>
                                                                        </button>
                                                                    {% endfor %}
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col text-center">
                                                            <p class="lead">Date Created: {{dailyPost.created_at}}</p>
                                                        </div>
                                                    </div>
                                                    <br>
                                                    <div class="row">
                                                        <div class="col">
                                                            <p class="lead text-center">Comments:</p>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col d-flex justify-content-center">
                                                            <!-- Comments form -->
                                                            <div class="row">
                                                                <div class="col-8">
                                                                    <div class="mb-3">
                                                                        <label for="comment-text-{{dailyPost.id}}" class="form-label">Comment</label>
                                                                        <input type="text" class="form-control" id="comment-text-{{dailyPost.id}}" placeholder="Add Comment...">
                                                                    </div>   
                                                                </div>
                                                                <div class="col-4">
                                                                    <br>
                                                                    <button type="button" class="btn btn-success mt-2 ms-5 add-comment" data-post-id="{{dailyPost.id}}">Add</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- comments -->
                                                    <div id="comments-container-{{dailyPost.id}}">
                                                        {% for commentPk, commentData  in post_comments.items %}
                                                            {% if commentData.post_id|stringformat:"%s%s" == dailyPost.id|stringformat:"%s%s" %}
                                                                <div class="row">
                                                                    <div class="col">
                                                                        <div class="card p-3 m-2">
                                                                            <div class="row">
                                                                                <div class="col">
                                                                                    {% for user_key, user_value in post_users.items %}
                                                                                        {% if user_key|stringformat:"%s%s" == commentData.user|stringformat:"%s%s" %}
                                                                                            <img class="border border-success" src="{{user_value}}"  alt="{{commentData.user}}'s Profile Picture" style="height:20px; width: 20px; border-radius: 10px;">
                                                                                            <strong>{{commentData.user}}</strong>
                                                                                        {% endif %}
                                                                                    {% endfor %}
                                                                                </div>
                                                                            </div>
                                                                            <div class="row">
                                                                                <div class="col">
                                                                                    {{ commentData.text }} 
                                                                                </div>
                                                                            </div>
                                                                            <div class="row">
                                                                                <div class="col-8">
                                                                                    <a href="#nested-comments-{{commentPk}}" data-bs-toggle="collapse" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover">Replies</a>
                                                                                </div>
                                                                                <div class="col-4 d-flex justify-content-end">
                                                                                    {% if user_liked_by in subCommentData.liked__by.all %}
                                                                                        <button type="button" class="btn btn-success border border-success commnet-like-button comment-like-button-{{commentPk}} d-flex align-items-center pb-3 pt-2" data-comment-id="{{commentPk}}" style="height: 25px;">
                                                                                            <div class="row align-items-center">
                                                                                                <div class="col mt-1 d-flex justify-content-end">
                                                                                                    <i class="bi bi-hand-thumbs-up-fill" id="comment-like-icon-{{commentPk}}" style="color: #ffffff;"></i>
                                                                                                </div>
                                                                                                <div class="col mt-4">
                                                                                                    <p class="text-white" id="comment-like-text-{{commentPk}}">{{commentData.likes}}</p>
                                                                                                </div>
                                                                                            </div>
                                                                                        </button>
                                                                                    {% else %}
                                                                                        <button type="button" class="btn border border-success commnet-like-button comment-like-button-{{commentPk}} d-flex align-items-center pb-3 pt-2" data-comment-id="{{commentPk}}" style="height: 25px;">
                                                                                            <div class="row align-items-center">
                                                                                                <div class="col mt-1 d-flex justify-content-end">
                                                                                                    <i class="bi bi-hand-thumbs-up" id="comment-like-icon-{{commentPk}}" style="color: #198754;"></i>
                                                                                                </div>
                                                                                                <div class="col mt-4">
                                                                                                    <p class="text-success" id="comment-like-text-{{commentPk}}">{{commentData.likes}}</p>
                                                                                                </div>
                                                                                            </div>
                                                                                        </button>
                                                                                    {% endif %}
                                                                                </div>
                                                                            </div>
                                                                            <div class="collapse" id="nested-comments-{{commentPk}}">
                                                                                <div class="row">
                                                                                    <div class="col">
                                                                                        <!-- For repling -->
                                                                                        <div class="row">
                                                                                            <div class="col-8">
                                                                                                <div class="mb-3">
                                                                                                    <label for="reply-text-{{commentPk}}" class="form-label">Reply</label>
                                                                                                    <input type="text" class="form-control" id="reply-text-{{commentPk}}" placeholder="Add reply...">
                                                                                                </div>   
                                                                                            </div>
                                                                                            <div class="col-4">
                                                                                                <br>
                                                                                                <button type="button" class="btn btn-success mt-2 ms-5 add-reply" data-comment-id="{{commentPk}}">Reply</button>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                <br>
                                                                                <div id="replies-container-{{commentPk}}">
                                                                                    {% for subCommentPk, subCommentData in post_replies.items %} 
                                                                                        {% if subCommentData.comment_id|stringformat:"%s%s" == commentData.id|stringformat:"%s%s" %}
                                                                                            <div class="card p-1">
                                                                                                <div class="row">
                                                                                                    <div class="col">
                                                                                                        {% for user_key, user_value in post_users.items %}
                                                                                                            {% if user_key|stringformat:"%s%s" == subCommentData.user|stringformat:"%s%s" %}
                                                                                                                <img class="border border-success" src="{{user_value}}" alt="{{subCommentData.user}}'s Profile Picture" style="height:20px; width: 20px; border-radius: 10px;">
                                                                                                                <em>{{ subCommentData.user }}</em>
                                                                                                            {% endif %}
                                                                                                        {% endfor %}
                                                                                                    </div>
                                                                                                </div>
                                                                                                <div class="row">
                                                                                                    <div class="col">
                                                                                                        {{subCommentData.text}}
                                                                                                    </div>
                                                                                                    <div class="col d-flex justify-content-end">
                                                                                                        {% if user_liked_by in subCommentData.liked__by.all %}
                                                                                                            <button type="button" class="btn btn-success border border-success nested-comment-like-button nested-comment-like-button-{{subCommentPk}} d-flex align-items-center pb-3 pt-2" data-comment-id="{{subCommentPk}}" style="height: 25px;">
                                                                                                                <div class="row align-items-center">
                                                                                                                    <div class="col mt-1 d-flex justify-content-end">
                                                                                                                        <i class="bi bi-hand-thumbs-up-fill" id="nested-comment-like-icon-{{subCommentPk}}" style="color: #ffffff;"></i>
                                                                                                                    </div>
                                                                                                                    <div class="col mt-4">
                                                                                                                        <p class="text-white" id="nested-comment-like-text-{{subCommentPk}}">{{subCommentData.likes}}</p>
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                            </button>
                                                                                                        {% else %}
                                                                                                            <button type="button" id="nested-comment-like-button-{{subCommentPk}}" class="btn border border-success nested-commnet-like-button nested-comment-like-button-{{subCommentPk}} d-flex align-items-center pb-3 pt-2" data-comment-id="{{subCommentPk}}" style="height: 25px;">
                                                                                                                <div class="row align-items-center">
                                                                                                                    <div class="col mt-1 d-flex justify-content-end">
                                                                                                                        <i class="bi bi-hand-thumbs-up" id="nested-comment-like-icon-{{subCommentPk}}" style="color: #198754;"></i>
                                                                                                                    </div>
                                                                                                                    <div class="col mt-4">
                                                                                                                        <p class="text-success" id="nested-comment-like-text-{{subCommentPk}}">{{subCommentData.likes}}</p>
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                            </button>
                                                                                                        {% endif %}
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                            <br>
                                                                                        {% endif %}
                                                                                    {% endfor %}
                                                                                </div>
                                                                            </div>
                                                                        </div>   
                                                                    </div>
                                                                {% endif %} 
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div> 
                                        </div>
                                    </div>
                                {% endfor %}
                                <!-- you are all caught up "post" -->
                                {% if all_caught_up %}
                                    {{ all_caught_up|safe }}
                                {% else %}
                                {% endif %}
                                {% for remainingPost in remaining_posts %}
                                <!-- Up to here interms of fixing -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card m-5">
                                            <div class="row">
                                                <div class="col m-2">
                                                    {% for key, value in post_users.items %}
                                                        {% if key|stringformat:"%s%s" == remainingPost.user|stringformat:"%s%s" %}
                                                            <button class="btn btn-light"><img src="{{ value }}" alt="{{remainingPost.user}}'s Profile Picture" onclick='location.href = "/profile/{{remainingPost.user}}"' style="width: 30px; height: 30px;"></button>
                                                        {% else %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col m-2">
                                                    <h6 class="display-6">{{remainingPost.user}}</h6>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col m-2">
                                                    <img src="{{remainingPost.media.url}}" alt="Post: {{remainingPost.title}}'s Media" class="post-no-{{remainingPost.id}}" style="height: 248px; width: 100%;" id="post-{{remainingPost.id}}" data-post-id="{{remainingPost.id}}">
                                                </div>
                                            </div>
                                            <div class="row m-2">
                                                <div class="col">
                                                    <h3 class="display-6">{{remainingPost.title}}</h3>
                                                </div>
                                            </div>
                                            <div class="row m-1">
                                                <div class="col">
                                                    <p class="lead">{{remainingPost.contents}}</p>
                                                </div>
                                            </div>
                                            <div class="row m-1">
                                                <div class="col-6 d-flex justify-content-start">
                                                    <button type="button" class="btn" data-bs-target="#expand-{{remainingPost.id}}" data-bs-toggle="modal"><i class="bi bi-three-dots"></i></button>
                                                </div>
                                                <div class="col-6 d-flex justify-content-end">
                                                    {% if user_liked_by in remainingPost.liked_by.all %}
                                                        <button type="button" class="btn btn-success border border-success like-button like-button-{{remainingPost.id}} d-flex align-items-center pb-3 pt-2" data-post-id="{{remainingPost.id}}" style="height: 25px;">
                                                            <div class="row align-items-center">
                                                                <div class="col mt-1 d-flex justify-content-end">
                                                                    <i class="bi bi-hand-thumbs-up-fill" id="page-like-icon-{{remainingPost.id}}" style="color: #ffffff;"></i>
                                                                </div>
                                                                <div class="col mt-4">
                                                                    <p class="text-white" id="page-like-text-{{remainingPost.id}}">{{remainingPost.likes}}</p>
                                                                </div>
                                                            </div>
                                                        </button>
                                                    {% else %}
                                                        <button type="button" class="btn border border-success like-button like-button-{{remainingPost.id}} d-flex align-items-center pb-3 pt-2" data-post-id="{{remainingPost.id}}" style="height: 25px;">
                                                            <div class="row align-items-center">
                                                                <div class="col mt-1 d-flex justify-content-end">
                                                                    <i class="bi bi-hand-thumbs-up" id="page-like-icon-{{remainingPost.id}}" style="color: #198754;"></i>
                                                                </div>
                                                                <div class="col mt-4">
                                                                    <p class="text-success" id="page-like-text-{{remainingPost.id}}">{{remainingPost.likes}}</p>
                                                                </div>
                                                            </div>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </div>    
                                        </div>
                                    </div>
                                    <!-- modal -->
                                    <div id="expand-{{remainingPost.id}}" class="modal fade">
                                        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    Post
                                                    <button class="btn btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <div class="col m-2">
                                                            {% for key, value in post_users.items %}
                                                                {% if key|stringformat:"%s%s" == remainingPost.user|stringformat:"%s%s" %}
                                                                    <button class="btn btn-light" style="border-radius: 15px; width: fit-content; height: fit-content;"><img src="{{ value }}" alt="{{remainingPost.user}}'s Profile Picture" onclick='location.href = "/profile/{{remainingPost.user}}"' style="width: 30px; height: 30px;"></button>
                                                                {% else %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col m-2">
                                                            <h6 class="display-6">{{remainingPost.user}}</h6>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col m-2">
                                                            <img src="{{remainingPost.media.url}}" alt="Post: {{remainingPost.title}}'s Media" style="height: 248px; width: 100%;">
                                                        </div>
                                                    </div>
                                                    <div class="row m-2">
                                                        <div class="col">
                                                            <h3 class="display-6">{{remainingPost.title}}</h3>
                                                        </div>
                                                    </div>
                                                    <div class="row m-1">
                                                        <div class="col">
                                                            <p class="lead">{{remainingPost.contents}}</p>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-4">
                                                            <a class="btn btn-success" data-bs-toggle="collapse" href="#liked-by-{{remainingPost.id}}" role="button" aria-expanded="false" aria-controls="liked-by-{{remainingPost.id}}">Liked By</a> 
                                                        </div>
                                                        <div class="col-8 d-flex justify-content-end">
                                                            {% if user_liked_by in remainingPost.liked_by.all %}
                                                                <button type="button" class="btn btn-success border border-success like-button like-button-{{remainingPost.id}} d-flex align-items-center pb-3 pt-2" data-post-id="{{remainingPost.id}}" style="height: 25px;">
                                                                    <div class="row align-items-center">
                                                                        <div class="col mt-1 d-flex justify-content-end">
                                                                            <i class="bi bi-hand-thumbs-up-fill" id="modal-like-icon-{{remainingPost.id}}" style="color: #ffffff;"></i>
                                                                        </div>
                                                                        <div class="col mt-4">
                                                                            <p class="text-white" id="modal-like-text-{{remainingPost.id}}">{{remainingPost.likes}}</p>
                                                                        </div>
                                                                    </div>
                                                                </button>
                                                            {% else %}
                                                                <button type="button" class="btn border border-success like-button like-button-{{remainingPost.id}} d-flex align-items-center pb-3 pt-2" data-post-id="{{remainingPost.id}}" style="height: 25px;">
                                                                    <div class="row align-items-center">
                                                                        <div class="col mt-1 d-flex justify-content-end">
                                                                            <i class="bi bi-hand-thumbs-up" id="modal-like-icon-{{remainingPost.id}}" style="color: #198754;"></i>
                                                                        </div>
                                                                        <div class="col mt-4">
                                                                            <p class="text-success" id="modal-like-text-{{remainingPost.id}}">{{remainingPost.likes}}</p>
                                                                        </div>
                                                                    </div>
                                                                </button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col">
                                                            <div class="collapse card m-1" id="liked-by-{{remainingPost.id}}">
                                                                <ul class="list-group list-group-flush">
                                                                    {% for likedby in remainingPost.liked_by.all %}
                                                                        <button type="button" class="btn mb-2 d-inline-flex">
                                                                            <!-- adding profile pictures -->
                                                                            <img src=""  style="width: 30px; height: 30px;">
                                                                            <p class="p-0 m-0 ms-2">{{likedby}}</p>
                                                                        </button>
                                                                    {% endfor %}
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col text-center">
                                                            <p class="lead">Date Created: {{remainingPost.created_at}}</p>
                                                        </div>
                                                    </div>
                                                    <br>
                                                    <div class="row">
                                                        <div class="col">
                                                            <p class="lead text-center">Comments:</p>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col d-flex justify-content-center">
                                                            <!-- Comments form -->
                                                            <div class="row">
                                                                <div class="col-8">
                                                                    <div class="mb-3">
                                                                        <label for="comment-text-{{remainingPost.id}}" class="form-label">Comment</label>
                                                                        <input type="text" class="form-control" id="comment-text-{{remainingPost.id}}" placeholder="Add Comment...">
                                                                    </div>   
                                                                </div>
                                                                <div class="col-4">
                                                                    <br>
                                                                    <button type="button" class="btn btn-success mt-2 ms-5 add-comment" data-post-id="{{remainingPost.id}}">Add</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                
                                                    <!-- comments -->
                                                    <div id="comments-container-{{remainingPost.id}}">
                                                        {% for commentPk, commentData  in post_comments.items %}
                                                            {% if commentData.post_id|stringformat:"%s%s" == remainingPost.id|stringformat:"%s%s" %}
                                                                <div class="row">
                                                                    <div class="col">
                                                                        <div class="card p-3 m-2">
                                                                            <div class="row">
                                                                                <div class="col">
                                                                                    {% for user_key, user_value in post_users.items %}
                                                                                        {% if user_key|stringformat:"%s%s" == commentData.user|stringformat:"%s%s" %}
                                                                                            <img class="border border-success" src="{{user_value}}" alt="{{commentData}}'s Profile Picture" style="height:20px; width: 20px; border-radius: 10px;">
                                                                                            <strong>{{commentData.user}}</strong>
                                                                                        {% endif %}
                                                                                    {% endfor %}
                                                                                </div>
                                                                            </div>
                                                                            <div class="row">
                                                                                <div class="col">
                                                                                    {{ commentData.text }} 
                                                                                </div>
                                                                            </div>
                                                                            <div class="row">
                                                                                <div class="col-4">
                                                                                    <a href="#nested-comments-{{commentPk}}" data-bs-toggle="collapse" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover">Replies</a>
                                                                                </div>
                                                                                <div class="col-8 d-flex justify-content-end">
                                                                                    {% if user_liked_by in subCommentData.liked__by.all %}
                                                                                        <button type="button" class="btn btn-success border border-success comment-like-button comment-like-button-{{commentPk}} d-flex align-items-center pb-3 pt-2" data-comment-id="{{commentPk}}" style="height: 25px;">
                                                                                            <div class="row align-items-center">
                                                                                                <div class="col mt-1 d-flex justify-content-end">
                                                                                                    <i class="bi bi-hand-thumbs-up-fill" id="comment-like-icon-{{commentPk}}" style="color: #ffffff;"></i>
                                                                                                </div>
                                                                                                <div class="col mt-4">
                                                                                                    <p class="text-white" id="comment-like-text-{{commentPk}}">{{commentData.likes}}</p>
                                                                                                </div>
                                                                                            </div>
                                                                                        </button>
                                                                                    {% else %}
                                                                                        <button type="button" class="btn border border-success comment-like-button comment-like-button-{{commentPk}} d-flex align-items-center pb-3 pt-2" data-comment-id="{{commentPk}}" style="height: 25px;">
                                                                                            <div class="row align-items-center">
                                                                                                <div class="col mt-1 d-flex justify-content-end">
                                                                                                    <i class="bi bi-hand-thumbs-up" id="comment-like-icon-{{commentPk}}" style="color: #198754;"></i>
                                                                                                </div>
                                                                                                <div class="col mt-4">
                                                                                                    <p class="text-success" id="comment-like-text-{{commentPk}}">{{commentData.likes}}</p>
                                                                                                </div>
                                                                                            </div>
                                                                                        </button>
                                                                                    {% endif %}
                                                                                </div>
                                                                            </div>
                                                                            <div class="row">
                                                                                <div class="col">
                                                                                    <div class="collapse" id="nested-comments-{{commentPk}}">
                                                                                        <div class="row">
                                                                                            <div class="col">
                                                                                                <!-- For repling -->
                                                                                                <div class="row">
                                                                                                    <div class="col-8">
                                                                                                        <div class="mb-3">
                                                                                                            <label for="reply-text-{{commentPk}}" class="form-label">Reply</label>
                                                                                                            <input type="text" class="form-control" id="reply-text-{{commentPk}}" placeholder="Add reply...">
                                                                                                        </div>   
                                                                                                    </div>
                                                                                                    <div class="col-4">
                                                                                                        <br>
                                                                                                        <button type="button" class="btn btn-success mt-2 ms-5 add-reply" data-comment-id="{{commentPk}}">Reply</button>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                        <br>
                                                                                        <div id="replies-container-{{commentPk}}">
                                                                                            {% for subCommentPk, subCommentData in post_replies.items %} 
                                                                                                {% if subCommentData.comment_id|stringformat:"%s%s" == commentData.id|stringformat:"%s%s" %}
                                                                                                    <div class="card p-1">
                                                                                                        <div class="row">
                                                                                                            <div class="col">
                                                                                                                {% for user_key, user_value in post_users.items %}
                                                                                                                    {% if user_key|stringformat:"%s%s" == subCommentData.user|stringformat:"%s%s" %}
                                                                                                                        <img class="border border-success" src="{{user_value}}" alt="{{subCommentData.user}}'s Profile Picture" style="height:20px; width: 20px; border-radius: 10px;">
                                                                                                                        <em>{{ subCommentData.user }}</em>
                                                                                                                    {% endif %}
                                                                                                                {% endfor %}
                                                                                                            </div>
                                                                                                        </div>
                                                                                                        <div class="row">
                                                                                                            <div class="col">
                                                                                                                {{subCommentData.text}}
                                                                                                            </div>
                                                                                                            <div class="col d-flex justify-content-end">
                                                                                                                {% if user_liked_by in subCommentData.liked__by.all %}
                                                                                                                    <button type="button" class="btn btn-success border border-success nested-comment-like-button nested-comment-like-button-{{subCommentPk}} d-flex align-items-center pb-3 pt-2" data-comment-id="{{subCommentPk}}" style="height: 25px;">
                                                                                                                        <div class="row align-items-center">
                                                                                                                            <div class="col mt-1 d-flex justify-content-end">
                                                                                                                                <i class="bi bi-hand-thumbs-up-fill" id="nested-comment-like-icon-{{subCommentPk}}" style="color: #ffffff;"></i>
                                                                                                                            </div>
                                                                                                                            <div class="col mt-4">
                                                                                                                                <p class="text-white" id="nested-comment-like-text-{{subCommentPk}}">{{subCommentData.likes}}</p>
                                                                                                                            </div>
                                                                                                                        </div>
                                                                                                                    </button>
                                                                                                                {% else %}
                                                                                                                    <button type="button" id="nested-comment-like-button-{{subCommentPk}}" class="btn border border-success nested-comment-like-button nested-comment-like-button-{{subCommentPk}} d-flex align-items-center pb-3 pt-2" data-comment-id="{{subCommentPk}}" style="height: 25px;">
                                                                                                                        <div class="row align-items-center">
                                                                                                                            <div class="col mt-1 d-flex justify-content-end">
                                                                                                                                <i class="bi bi-hand-thumbs-up" id="nested-comment-like-icon-{{subCommentPk}}" style="color: #198754;"></i>
                                                                                                                            </div>
                                                                                                                            <div class="col mt-4">
                                                                                                                                <p class="text-success" id="nested-comment-like-text-{{subCommentPk}}">{{subCommentData.likes}}</p>
                                                                                                                            </div>
                                                                                                                        </div>
                                                                                                                    </button>
                                                                                                                {% endif %}
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <br>
                                                                                                {% endif %}
                                                                                            {% endfor %}
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>   
                                                                </div>
                                                            {% endif %} 
                                                        {% endfor %}            
                                                    </div>
                                                </div>
                                            </div>
                                        </div> 
                                    </div>
                                {% endfor %}
                            </div>
                        </div> 
                    <div class="end-of-posts" data-increment="1" data-catergory="catch-up"></div>
                </div>
                <div class="col-6">
                    <div class="card" style="position: fixed;">
                        <div class="row">
                            <div class="col">
                                <h4 class="display-6 text-center">What do you want to look at?</h4>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col m-2">
                                <div class="card">
                                    <a href="/page/popular|All/1" class="text-center link-success link-offset-2 link-underline-opacity-0">Popular</a>
                                </div>
                            </div>
                            <div class="col m-2">
                                <div class="card">
                                    <a href="/page/recommended|All/1" class="text-center link-success link-offset-2 link-underline-opacity-0">Recommended</a>
                                </div>
                            </div>
                            <div class="col m-2">
                                <div class="card">
                                    <a href="/page/catch_up/1" class="text-center link-success link-offset-2 link-underline-opacity-0">Catch Up</a>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <h6 class="display-6 text-center">Following:</h6>
                            </div>
                        </div>
                        <div class="row d-flex justify-content-center mb-5">
                            {% for follower in user_followers %}
                                <div class="col-4 d-flex justify-content-center">
                                    <button type="button" class="btn mb-2 p-0" onclick="location.href='/profile/{{follower.user.username}}'" style="height:100px; width:100px;">
                                        <img class="border border-success rounded-circle p-0" src="{{follower.pfp.url}}" alt="{{follower.user.username}}'s Profile Picture" style="height:100px; width:100px;">
                                        <p class="lead text-center">{{follower.user.username}}</p>
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- To store notifications -->
        <div class="toast-container position-fixed bottom-0 end-0 p-3" id="inbox"></div>
    </body>
</html>


{% extends 'main/template.html' %}
{% load crispy_forms_tags %} 
{% block title %} 
{{ user.username }} 
{% endblock %}
{% block topsidebar %}
<li class="custom-icon"><div class="fs-4"><i class="bi bi-person" style="color: #787878;"></i></div> <a href="/profile/{{user.username}}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Profile</p></a></li>
{% endblock %}
{% block middlesidebar %}
<li class="custom-icon"><div class="fs-4"><i class="bi bi-gear-wide-connected" style="color: #787878;"></i></div> <a href="/settings/{{user.username}}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Settings</p></a></li>
{% endblock %}
{% block searchBar %}
{{ search_bar|crispy }}
{% endblock %}
{% block body %}
<div class="container">
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <form action="" method="post" id="createChatRoomForm" enctype="multipart/form-data">
                            {% csrf_token %}
                            <p class="lead text-center">Create Chat Room</p>
                            {{chat_room_form|crispy}}
                            <p>Invite Users*</p>
                            <hr>
                            <div class="row">
                                {% for chooseable_user in chooseable_users %}
                                    <div class="col-4">
                                        <div class="card mb-4">
                                            <div class="card-body">
                                                <div class="input-group mb-3 text-center">
                                                    <div class="input-group-text" style=" border-top-left-radius: 25px; border-top-right-radius: 25px; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;">
                                                        <input class="form-check-input mt-0" type="checkbox" name="chosen_user{{chooseable_user.id}}" id="ChosenUser{{chooseable_user.id}}" value="chosen{{chooseable_user.id}}" value aria-label="Checkbox for selecting the user: {{chooseable_user.user.username}}">
                                                    </div>
                                                    <p class="lead mt-3" style="padding-left: 100px;">{{chooseable_user.user.username}}</p>
                                                    <img src="{{chooseable_user.pfp.url}}" alt="" style="margin-left: 15%; max-width: 70%; max-height: 70%;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <br>
                            <div class="col d-flex justify-content-center">
                                {% if increment.previous == 0 %}
                                    <button class="btn btn-outline-success" disabled><i class="bi bi-arrow-left-circle"></i> Previous</button>
                                {% else %}
                                    <button class="btn btn-outline-success" onclick='location.href = "/create_chat_room/{{increment.previous}}"'><i class="bi bi-arrow-left-circle"></i> Previous</button>
                                {% endif %}
                                <p class="lead ps-2 pe-2 mt-2">User List no. {{increment.current}} </p>
                                <button class="btn btn-outline-success" onclick='location.href = "/create_chat_room/{{increment.next}}"'>Next <i class="bi bi-arrow-right-circle"></i></button>
                            </div>
                            <button type="submit" class="btn btn-success"><i class="bi bi-chat-right-text-fill"></i> Create</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Websockets for recieving notifications -->
<script type="text/javascript">
    const notificationSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/brordcast-message/'
    );
    notificationSocket.onopen = function() {
        
    };

    notificationSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log(data)
        $('#inbox').append(data.html_notification);
        var inbox = document.getElementById('inbox');
        inbox.insertAdjacentHTML('afterbegin', data.html_notification);

        var notificationElement = document.getElementById('notification-' + data.notification_id);
        var notification = new bootstrap.Toast(notificationElement);

        // Show the toast
        notification.show();
    };

    notificationSocket.onerror = function(e) {
        console.error('WebSocket encountered an error:', e);
    };

    notificationSocket.onclose = function(e) {
        console.error('WebSocket closed unexpectedly:', e);
    };
</script>
<!-- To store notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="inbox">

</div>
{% endblock %}
{% extends 'messaging/template.html' %}
{% load crispy_forms_tags %}
{% block title %} Messaging {% endblock %}
{% block profile %}
    <li class="custom-icon"><div class="fs-4"><i class="bi bi-person" style="color: #787878;"></i></div> <a href="/profile/{{username}}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Profile</p></a></li>
{% endblock %}
{% block settings %}
    <li class="custom-icon"><div class="fs-4"><i class="bi bi-gear-wide-connected" style="color: #787878;"></i></div> <a href="/settings/{{username}}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Settings</p></a></li>
{% endblock %}
{% block searchBar %}
    {{search_bar| crispy}}
{% endblock %}
{% block notifications %}
        {% for notification in notifications.values %}
            <div id="notification-{{notification.notification_object.pk}}" class="card mb-2" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
                <div class="card-header">
                    <button class="btn p-0" onclick='location.href="/chat/{{notification.notification_object.source.name}}/{{notification.notification_object.source.pk}}"' id="read-notification-{{notification.notification_object.pk}}">
                        <img src="{{notification.notification_object.source.icon.url}}" class="rounded me-2" alt="" style="height: 2.5rem; width: 2.5rem">
                    </button>
                    <button class="btn p-0 pe-2" onclick="location.href='/chat/{{notification.notification_object.source.name}}/{{notification.notification_object.source.pk}}'" id="read-notification-{{notification.notification_object.pk}}">
                        <strong class="me-auto">{{notification.notification_object.source.name}}</strong>
                    </button>
                    <small class="text-muted pe-2">{{notification.notification_object.timestamp}}</small>
                    <button type="button ms-2" class="btn-close" id="close-notification-{{notification.notification_object.pk}}" aria-label="Close"></button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <img src="{{notification.sender_pfp_url}}" class="rounded me-2" alt="" style="height: 2.5rem; width: 2.5rem">
                            <em>{{notification.notification_object.sender}}</em>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col mt-2">
                            <p class="text-truncate ">{{notification.notification_object.contents}}</p>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                $(document).ready(function () {
                    $('#close-notification-{{notification.notification_object.pk}}').click(function () {
                        $.ajax({
                            type: 'POST',
                            url: '/universal/remove-notification/',
                            data: {
                                'receiver': '{{username}}',
                                'type': 'notification-id',
                                'csrfmiddlewaretoken': '{{ csrf_token }}',
                                'notification_id': '{{notification.notification_object.pk}}'
                            },
                            success: function(response) {
                                console.log(response.notification_count, response.notification_counter)
                                var notification = $("#notification-{{notification.notification_object.pk}}")
                                notification.remove();
                                $('#notification-counter').text('');
                                $('#notification-counter').text(response.notification_count);
                                    if (response.notification_count == 0) {
                                        $('#notification-counter').text(response.notification_count).hide();
                                        $('#notification-counter').remove();
                                        $('#bell-icon').removeClass('bi-bell-fill');
                                        $('#bell-icon').addClass('bi-bell');
                                    }
                            }
                        })
                    })
                    $('#read-notification-{{notification.notification_object.pk}}').click(function () {
                        $.ajax({
                            type: 'POST',
                            url: '/universal/remove-notification/',
                            data: {
                                'receiver': '{{username}}',
                                'type': 'notification-id',
                                'csrfmiddlewaretoken': '{{ csrf_token }}',
                                'notification_id': '{{notification.notification_object.pk}}'
                            },
                            success: function(response) {
                                console.log(response.message)
                            }
                        })
                    })
                })
                
            </script>
        {% endfor %}
{% endblock %}
{% block notification_count %}
    <div id="notification-indicatior">
        {% if notification_count == 0 %}
            <script>
                $(document).ready(function () {
                    var notification_count = '{{notification_count}}';
                    var notification_bell = $('#bell-icon');
                    notification_bell.removeClass('bi-bell-fill');
                    notification_bell.addClass('bi-bell');
                })
            </script>
        {% else %}
            <span class="top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notification-counter">{{ notification_count }}
        {% endif %}
    </div>
{% endblock %}
{% block chatrooms %}
    {% for chat_room in chat_rooms %}
    <div class="row">
        <div class="col-3">
            <button class="btn" onclick='location.href="/chat/{{chat_room.name}}/{{chat_room.id}}"'>
                <img src="{{chat_room.icon.url}}" style="max-width: 2.5rem; max-height: 2.5rem; border-radius: 35%;">
            </button>
        </div>
        <div class="col-7">
            <button class="btn" onclick='location.href="/chat/{{chat_room.name}}/{{chat_room.id}}"'>
                <p class="lead">{{chat_room.name}}</p>
            </button>
        </div>
        <br>
    {% endfor %}
{% endblock %}
{% block conversation %}
<div class="container">
    <div class="card p-0" style="height: 630px;" >
        <div class="card-header">
            <div class="row">
                <div class="col-1">
                    <img src="{{room.icon.url}}" alt="" class="p-2 rounded-circle" style="max-height: 4rem; max-width: 4rem;">
                </div>
                <div class="col-11">
                    <p class="lead text-start mt-3">{{room.name}}</p>
                </div>
            </div>
        </div>
        <img src="{{room.room_bg_image.url}}" alt="" style="height: 547px; opacity: 30%; border-bottom-left-radius: 5px;">
        <div class="card-img-overlay" style="overflow-y: auto; margin-top: 80px;" id="conversationFrame">
            <div class="card-body" id="conversation-contents">
                {% for message in messages %}
                    <div class="row">
                        <div class="col">
                            <p id="message-{{message.id}}" class="text-center"><em>{{message.sent_at}}</em></p>
                        </div>
                    </div>
                    <div class="row">
                        {% if message.sender.user.username == username %}
                            {% if message.reply != None %}
                                <div class="col-6">
                                </div>
                                <div class="col-6">
                                    <div class="row">
                                        <div class="col-10 d-flex justify-content-end">
                                            <div class="card p-0 pb-0 text-bg-light" style="width: 85%; border: none; opacity: 70%;">
                                                <div class="card-header" style="border-bottom: none;">
                                                    <a href="#message-{{message.reply.id}}" class="btn p-0"><p class="small m-0"><em>REPLY:</em> {{message.reply.sender}}</p></a>
                                                    <a href="#message-{{message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0">{{message.reply.text}}</p></a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-2">
                                            <p id="message-{{message.id}}" class="d-flex justify-content-start"><strong>You</strong></p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-10 d-flex justify-content-end">
                                            <div class="card pb-0 text-bg-success" style="width: 85%; border: none; opacity: 85%;">
                                                <div class="card-header" style="border-bottom: none;">
                                                    {% if message.text %}
                                                        <p>{{message.text}}</p>
                                                    {% elif message.image %}
                                                        <img src="{{message.image.url}}" alt="">
                                                    {% else %} 
                                                        <video src="{{message.video.url}}" controls></video>
                                                    {% endif %}
                                                    <div class="row">
                                                        <div class="col">
                                                            <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="{{message.text}}" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-1">
                                            <img src="{{message.sender.pfp.url}}" alt="" class="rounded-circle" style="max-width: 2rem; max-height: 2rem;">
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="col-6">
                                </div>
                                <div class="col-6">
                                    <div class="row">
                                        <div class="col-11">
                                            <p class="d-flex justify-content-end"><strong>You</strong></p>
                                        </div>
                                        <div class="col-1">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-10 d-flex justify-content-end">
                                            <div class="card text-bg-success pb-0" style="width: fit-content; border: none; opacity: 85%;">
                                                <div class="card-header" style="border-bottom: none;">
                                                    {% if message.text %}
                                                        <p>{{message.text}}</p>
                                                    {% elif message.image %}
                                                        <img src="{{message.image.url}}" alt="">
                                                    {% else %} 
                                                        <video src="{{message.video.url}}" controls></video>
                                                    {% endif %}
                                                    <div class="row">
                                                        <div class="col">
                                                            <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="{{message.text}}" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-1">
                                            <img src="{{message.sender.pfp.url}}" alt="" class="rounded-circle" style="max-width: 2rem; max-height: 2rem;">
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% else %}
                            {% if message.reply != None %}
                                <div class="col-6">
                                    <div class="row">
                                        <div class="col">
                                            <p class="d-flex justify-content-start"><strong>{{message.sender.user.username}}</strong></p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-2">
                                            <img src="{{message.sender.pfp.url}}" class="rounded-circle" alt="" style="max-width: 2rem; max-height: 2rem;">
                                        </div>
                                        <div class="col-10 d-flex justify-content-start">
                                            <div class="card p-0 pb-0 text-bg-light" style="width: 85%; border: none; opacity: 70%;">
                                                <div class="card-header" style="border-bottom: none;">
                                                    <a href="#message-{{message.reply.id}}" class="btn p-0"><p class="small m-0"><em>REPLY:</em> {{message.reply.sender}}</p></a>
                                                    <a href="#message-{{message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0">{{message.reply.text}}</p></a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-2">
                                        </div>
                                        <div class="col-10 d-flex justify-content-start">
                                            <div class="card pb-0 text-bg-success" style="width: 85%; border: none; opacity: 85%;">
                                                <div class="card-header" style="border-bottom: none;">
                                                    {% if message.text %}
                                                        <p>{{message.text}}</p>
                                                    {% elif message.image %}
                                                        <img src="{{message.image.url}}" alt="">
                                                    {% else %} 
                                                        <video src="{{message.video.url}}" controls></video>
                                                    {% endif %}
                                                    <div class="row">
                                                        <div class="col">
                                                            <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="{{message.text}}" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                </div>
                            {% else %}
                                <div class="col-6">
                                    <div class="row">
                                        <div class="col-10">
                                            <p class="d-flex justify-content-start"><strong>{{message.sender.user.username}}</strong></p>
                                        </div>
                                        <div class="col-2">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-2">
                                            <img src="{{message.sender.pfp.url}}" class="rounded-circle" alt="" style="max-width: 2rem; max-height: 2rem;">
                                        </div>
                                        <div class="col-10">
                                            <div class="card text-bg-success" style="width: fit-content; border: none; opacity: 85%;">
                                                <div class="card-header" style="border-bottom: none;">
                                                    {% if message.text %}
                                                        <p>{{message.text}}</p>
                                                    {% elif message.image %}
                                                        <img src="{{message.image.url}}" alt="">
                                                    {% else %} 
                                                        <video src="{{message.video.url}}" controls></video>
                                                    {% endif %}
                                                    <div class="row">
                                                        <div class="col">
                                                            <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="{{message.text}}" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply" style="color: #ffffff"></i></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <br>
    <form action="" method="post">
        {% csrf_token %}
        <div class="row">
            <div class="col-1">
                <div class="btn-group dropup">
                    <button type="button" class="btn btn-outline-success" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-plus-square" style="font-size:  3vw;"></i></button>
                    <ul class="dropdown-menu p-2 mb-1">
                        <li class="custom-icon"><div class="fs-4"><i class="bi bi-images"></i></div> <p class="lead">Image</p></li>
                        <li class="custom-icon"><div class="fs-4"><i class="bi bi-play-btn"></i></i></div> <p class="lead">Video</p></li>
                    </ul>
                </div>
            </div>
            <div class="col-10" id="message-div">
                <input type="hidden" id="is-reply" value="false">
                <input type="text" id="message" class="form-control p-3 " id="exampleInputEmail1" aria-describedby="emailHelp">
            </div>
            <div class="col-1">
                <div class="card">
                    <button type="button" id="send" class="btn btn-outline-success" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-send-fill" style="font-size: 3vw;"></i></button>
                </div>
            </div>
        </div>
    </form>
    <!-- For conviniance when messaging -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var scrollableContent = document.getElementById("conversationFrame");
            scrollableContent.scrollTop = scrollableContent.scrollHeight;
        });
    </script>
    <!-- Websocket for sending messages -->
    <script type="text/javascript">
        var roomId = "{{ room.id }}";  // Django template variable for chatroom ID
        var roomName = "{{ room.name }}";  // Django template variable for chatroom name
        var reconnectionTime = 5000;
        let messageSocket
        let notificationSocket
        function setupReply(messageId, username, message) {
            const isReply = $('#is-reply');
            const messageDiv = $('#message-div');
            if (isReply.val() === 'false') {
                messageDiv.prepend(`
                    <div class="card mb-2" id="reply-prompt">
                        <div class="card-header">
                            <div class="row">
                                <div class="col">
                                    <p class="lead">Replying to <strong>${username}</strong>:</p>
                                </div>
                                <div id="reply-information-holder" data-message-id="${messageId}"</div>
                                <div class="col">
                                    <p class="text-truncate">${message}</p>
                                </div>
                            </div>
                        </div>
                    </div>`
                );
                isReply.val('true');
                $('html, body').animate({ scrollTop: $(document).height() }, 'fast');
            } else {
                $('#reply-prompt').remove();
                isReply.val('false');
            }
        }

        function connectMessageSocket () {
            messageSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/realtime-message-manager/' + roomId
            );

            messageSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log(data);
                if (data.type === 'incoming_text_message') {
                    if (data.username === '{{username}}') {
                        var newMessageInHtml = `
                            <div class="message">
                                <div class="row">
                                    <div class="col">
                                        <p id="message-` + data.message_id + `" class="text-center"><em>` + data.sent_at + `</em></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                    </div>
                                    <div class="col-6">
                                        <div class="row">
                                            <div class="col-11">
                                                <p class="d-flex justify-content-end"><strong>You</strong></p>
                                            </div>
                                            <div class="col-1">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-10 d-flex justify-content-end">
                                                <div class="card text-bg-success pb-0" style="width: fit-content; border: none; opacity: 85%;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        <p>` + data.message + `</p>
                                                        <div class="row">
                                                            <div class="col">
                                                                <button type="button" class="btn reply" data-message-id="` + data.message_id + `" data-message="` + data.message + `" data-message-sender="` + data.username + `""><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-1">
                                                <img src="` + data.user_pfp_url + `" alt="" class="rounded-circle" style="max-width: 2rem; max-height: 2rem;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                    } 
                    else {
                        var newMessageInHtml = `
                            <div class="message">
                                <div class="row">
                                    <div class="col">
                                        <p id="message-` + data.message_id + `" class="text-center"><em>` + data.sent_at + `</em></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="row">
                                            <div class="col-10">
                                                <p class="d-flex justify-content-start"><strong>` + data.username + `</strong></p>
                                            </div>
                                            <div class="col-2">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-2">
                                                <img src="` + data.user_pfp_url + `" class="rounded-circle" alt="" style="max-width: 2rem; max-height: 2rem;">
                                            </div>
                                            <div class="col-10">
                                                <div class="card text-bg-success" style="width: fit-content; border: none; opacity: 85%;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        <p>` + data.message + `</p>
                                                        <div class="row">
                                                            <div class="col">
                                                                <button type="button" class="btn reply" data-message-id="` + data.message_id +`" data-message="` + data.message + `" data-message-sender="` + data.username + `"><i class="bi bi-reply" style="color: #ffffff"></i></button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <div class="col-6">
                                </div>
                            </div>`;
                    }
                }
                else if (data.type === 'incoming_reply_text_message') {
                    if (data.username === '{{username}}') {
                        var newMessageInHtml = `
                            <div class="message">
                                <div class="row">
                                    <div class="col">
                                        <p id="message-` + data.message_id + `" class="text-center"><em>` + data.sent_at + `</em></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                    </div>
                                    <div class="col-6">
                                        <div class="row">
                                            <div class="col-10 d-flex justify-content-end">
                                                <div class="card p-0 pb-0 text-bg-light" style="width: 85%; border: none; opacity: 70%;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        <a href="#message-` + data.reply_id + `" class="btn p-0"><p class="small m-0"><em>REPLY:</em> ` + data.reply_message_user + `</p></a>
                                                        <a href="#message-` + data.reply_id + `" class="btn p-0"><p class="small text-truncate m-0">` + data.reply_message + `</p></a>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-2">
                                                <p class="d-flex justify-content-start"><strong>You</strong></p>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-10 d-flex justify-content-end">
                                                <div class="card pb-0 text-bg-success" style="width: 85%; border: none; opacity: 85%;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        <p>` + data.message + `</p>
                                                        <div class="row">
                                                            <div class="col">
                                                                <button type="button" class="btn reply" data-message-id="` + data.message_id +`" data-message="` + data.message + `" data-message-sender="` + data.username + `"><i class="bi bi-reply" style="color: #ffffff"></i></button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-1">
                                                <img src="` + data.user_pfp_url + `" alt="" class="rounded-circle" style="max-width: 2rem; max-height: 2rem;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        } else {
                            var newMessageInHtml = `
                                <div class="message">
                                    <div class="row">
                                        <div class="col">
                                            <p id="message-` + data.message_id + `" class="text-center"><em>` + data.sent_at + `</em></p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="row">
                                                <div class="col">
                                                    <p class="d-flex justify-content-start"><strong>` + data.username + `</strong></p>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-2">
                                                    <img src="` + data.user_pfp_url +`" class="rounded-circle" alt="" style="max-width: 2rem; max-height: 2rem;">
                                                </div>
                                                <div class="col-10 d-flex justify-content-start">
                                                    <div class="card p-0 pb-0 text-bg-light" style="width: 85%; border: none; opacity: 70%;">
                                                        <div class="card-header" style="border-bottom: none;">
                                                            <a href="#message-` + data.reply_id + `" class="btn p-0"><p class="small m-0"><em>REPLY:</em> ` + data.reply_message_user + `</p></a>
                                                            <a href="#message-` + data.reply_id + `" class="btn p-0"><p class="small text-truncate m-0">` + data.reply_message + `</p></a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-2">
                                                </div>
                                                <div class="col-10 d-flex justify-content-start">
                                                    <div class="card pb-0 text-bg-success" style="width: 85%; border: none; opacity: 85%;">
                                                        <div class="card-header" style="border-bottom: none;">
                                                            <p>` + data.message + `</p>
                                                            <div class="row">
                                                                <div class="col">
                                                                    <button type="button" class="btn reply" data-message-id="` + data.message_id +`" data-message="` + data.message + `" data-message-sender="` + data.username + `"><i class="bi bi-reply" style="color: #ffffff"></i></button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                        </div>
                                    </div>
                                </div>`;
                        }
                }
                $('#conversation-contents').append(newMessageInHtml);
                var scrollableContent = document.getElementById("conversationFrame");
                scrollableContent.scrollTop = scrollableContent.scrollHeight;
                $.ajax({
                    type: 'POST',
                    url: '/universal/remove-notification/',
                    data: {
                        'type': 'message_id',
                        'message-id': data.message_id,
                        'receiver': '{{username}}',
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        console.log('Notification removed')
                        
                    }
                });
                

            };
            messageSocket.onclose = function (e) {
                console.error('WebSocket closed unexpectedly:', e);
                setTimeout(connectMessageSocket, reconnectionTime);
            }

            messageSocket.onerror = function (e) {
                console.error('WebSocket encountered error:', e);
            }
        }

        function connectNotificationSocket () {
            notificationSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/brordcast-message/'
            );
            notificationSocket.onopen = function(e) {
                console.log('connected:', e )
            };

            notificationSocket.onmessage = function(e) {
                console.log('got a notification')
                const data = JSON.parse(e.data);
                if (data.source_name !== '{{room.name}}') { // if the notifiation come fron the chat room already accessing.
                    console.log('different room')
                    if (data.receiver === '{{username}}') {
                        console.log('correct user')
                        $('#inbox').append(data.html_notification_popup); // adds HTML to the inbox div, which stores notification toasts
                        $('#notification-inbox').prepend(data.stored_html_notification); // adds HTML to the notification div that houses the notifications in the off-canvas
                        
                        // Update notification count
                        var notificationCounter = $('#notification-counter');
                        var newCount = parseInt(notificationCounter.text()) || 0;
                        notificationCounter.text(newCount + 1).show();
                        
                        if ($('#bell-icon').hasClass('bi-bell')) { // if the bell looks like it has 0 notifications
                            $('#bell-icon').removeClass('bi-bell');
                            $('#bell-icon').addClass('bi-bell-fill');
                        }

                        var notificationElement = document.getElementById('popup-notification-' + data.notification_id); // gets the newly created popup notification toast

                        if (notificationElement) {
                            var notification = new bootstrap.Toast(notificationElement); // creates a bootstrap toast
                            // Show the toast
                            notification.show();
                        } else {
                            console.error('Notification element not found:', 'notification-' + data.notification_id);
                        }

                        // Attach event handlers to the newly added notification
                        attachNotificationEventHandlers(data.notification_id, data.receiver);
                    }
                }
                
                // if yes, mute the notification.
                // if no, display the notification.
            };

            notificationSocket.onerror = function(e) {
                console.error('WebSocket encountered an error:', e);
            };

            notificationSocket.onclose = function(e) {
                console.error('WebSocket closed unexpectedly:', e);
                setTimeout(connectNotificationSocket, reconnectionTime);

            };
        }
        
        function attachNotificationEventHandlers(notificationId, receiver) { 
            $(`#close-notification-${notificationId}`).click(function() {
                $.ajax({
                    type: 'POST',
                    url: '/universal/remove-notification/',
                    data: {
                        'receiver': receiver,
                        'type': 'notification-id',
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'notification_id': notificationId,
                    },
                    success: function(response) {
                        console.log(response.message);
                        var notification = $(`#stored-notification-${notificationId}`);
                        notification.remove();
                        var notificationCounter = $('#notification-counter');
                        var newCount = parseInt(notificationCounter.text()) - 1;

                        if (newCount <= 0) {
                            notificationCounter.text('').hide();
                            $('#bell-icon').removeClass('bi-bell-fill').addClass('bi-bell');
                        } else {
                            notificationCounter.text(newCount);
                        }
                    }
                });
            });

            $(`#read-notification-${notificationId}`).click(function() {
                $.ajax({
                    type: 'POST',
                    url: '/universal/remove-notification/',
                    data: {
                        'receiver': receiver,
                        'type': 'notification-id',
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'notification_id': notificationId,
                    },
                    success: function(response) {
                        console.log(response.message);
                    }
                });
            });
        }
        $(document).ready(function() {
            if ('{{ notification_count }}' == '0') {
                var notification_counter = $('#notification-counter');
                notification_counter.text('').hide();
                var notification_bell = $('#bell-icon');
                notification_bell.removeClass('bi-bell-fill').addClass('bi-bell');
            } else {
                var notificationCounter = $('#notification-counter');
                notificationCounter.text('{{ notification_count }}').show();
                $('#bell-icon').removeClass('bi-bell').addClass('bi-bell-fill');
            }
        });
        connectMessageSocket();
        connectNotificationSocket();
    </script>
    <script>
        $(document).ready(function () {
            $('#message').keydown(function (e) {
                if (e.keyCode == 13 ) {
                    e.preventDefault();
                    var message = $('#message').val()
                    let isReply
                    console.log($('#is-reply').val() == 'true')
                    if ($('#is-reply').val() === 'true') {
                        isReply = 'true'
                        replyMessageId = $('#reply-information-holder').data('message-id');
                    }
                    else {
                        replyMessageId = null
                    }
                    console.log(isReply)
                    if (message != '') {
                        $.ajax({
                            type: 'POST',
                            url: '/chat/message-sent-text/',
                            data: {
                                'chat-room-name': '{{room.name}}',
                                'chat-room-id': '{{room.id}}',
                                'text-message': message,
                                'is-reply': isReply,
                                'replying-to-id': replyMessageId,
                                'csrfmiddlewaretoken': '{{ csrf_token }}'
                            },
                            success: function(response) {
                                console.log('text sent and saved.')
                                var scrollableContent = document.getElementById("conversationFrame");
                                scrollableContent.scrollTop = scrollableContent.scrollHeight;
                                $('#message').val('');
                                if ($('#reply-prompt')) {
                                    $('#reply-prompt').remove();
                                }
                                console.log(response.notification_ids)
                                notificationSocket.send(JSON.stringify({
                                    'notification_ids': response.notification_ids,
                                    'csrf_token': '{{csrf_token}}',
                                }));
                                if (response.is_reply === 'true') {
                                    var replyId = response.reply_id;
                                    messageSocket.send(JSON.stringify({
                                        'text': message,
                                        'message_type': 'text',
                                        'message_id': response.message_id,
                                        'is_reply': response.is_reply,
                                        'reply_id': replyId,
                                        'chat_room_id': '{{ room.id }}',
                                        'current_url': encodeURIComponent(window.location.href),
                                        'sender': '{{username}}',
                                        'csrf_token': '{{csrf_token}}',
                                    }));
                                } else {
                                    messageSocket.send(JSON.stringify({
                                        'text': message,
                                        'message_type': 'text',
                                        'message_id': response.message_id,
                                        'is_reply': response.is_reply,
                                        'chat_room_id': '{{ room.id }}',
                                        'current_url': encodeURIComponent(window.location.href),
                                        'sender': '{{username}}',
                                        'csrf_token': '{{csrf_token}}',
                                    }));
                                }
                            }
                        });
                    }
                    else {
                        console.log('invalid message')
                    }
                }
            })
            $('#send').click(function () {
                var message = $('#message').val()
                let isReply
                console.log($('#is-reply').val() == 'true')
                if ($('#is-reply').val() === 'true') {
                    isReply = 'true'
                    replyMessageId = $('#reply-information-holder').data('message-id');
                }
                else {
                    replyMessageId = null
                }
                console.log(replyMessageId, is)
                if (message != '') {
                    $.ajax({
                        type: 'POST',
                        url: '/chat/message-sent-text/',
                        data: {
                            'chat-room-name': '{{room.name}}',
                            'chat-room-id': '{{room.id}}',
                            'text-message': message,
                            'is-reply': isReply,
                            'replying-to-id': replyMessageId,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function(response) {
                            console.log('text sent and saved.')
                            var scrollableContent = document.getElementById("conversationFrame");
                            scrollableContent.scrollTop = scrollableContent.scrollHeight;
                            $('#message').val('');
                            if ($('#reply-prompt')) {
                                $('#reply-prompt').remove();
                            }
                            console.log(response.notification_ids)
                            notificationSocket.send(JSON.stringify({
                                'notification_ids': response.notification_ids,
                            }));
                            if (response.is_reply === 'true') {
                                var replyId = response.reply_id;
                                messageSocket.send(JSON.stringify({
                                    'text': message,
                                    'message_type': 'text',
                                    'message_id': response.message_id,
                                    'is_reply': response.is_reply,
                                    'reply_id': replyId,
                                    'chat_room_id': '{{ room.id }}',
                                    'current_url': encodeURIComponent(window.location.href),
                                    'sender': '{{username}}',
                                    'csrf_token': '{{csrf_token}}',
                                }));
                            } else {
                                messageSocket.send(JSON.stringify({
                                    'text': message,
                                    'message_type': 'text',
                                    'message_id': response.message_id,
                                    'is_reply': response.is_reply,
                                    'chat_room_id': '{{ room.id }}',
                                    'current_url': encodeURIComponent(window.location.href),
                                    'sender': '{{username}}',
                                    'csrf_token': '{{csrf_token}}',
                                }));
                            }
                        }
                    });
                }
                else {
                        console.log('invalid message')
                    }
            });
            $('#conversation-contents').on('click', '.reply', function () {
                messageId = $(this).data('message-id');
                senderUsername = $(this).data('message-sender');
                message = $(this).data('message');
                setupReply(messageId, senderUsername, message);
            })

        });
    </script>
</div>
<!-- To store notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="inbox">

</div>
{% endblock %}

{% extends 'messaging/template.html' %}
{% load crispy_forms_tags %}
{% load filters %}
{% block title %} Messaging {% endblock %}
{% block profile %}
    <li class="custom-icon"><div class="fs-4"><i class="bi bi-person" style="color: #787878;"></i></div> <a href="/profile/{{username}}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Profile</p></a></li>
{% endblock %}
{% block settings %}
    <li class="custom-icon"><div class="fs-4"><i class="bi bi-gear-wide-connected" style="color: #787878;"></i></div> <a href="/settings/{{username}}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Settings</p></a></li>
{% endblock %}
{% block searchBar %}
    {{search_bar| crispy}}
{% endblock %}
{% block notifications %}
        {% for notification in notifications.values %}
            <div id="notification-{{notification.notification_object.pk}}" class="card mb-2" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
                <div class="card-header">
                    <button class="btn p-0" id="read-notification-{{notification.notification_object.pk}}">
                        <img src="{{notification.notification_object.source.icon.url}}" class="rounded me-2" alt="" style="height: 2.5rem; width: 2.5rem">
                    </button>
                    <button class="btn p-0 pe-2" id="read-notification-{{notification.notification_object.pk}}">
                        <strong class="me-auto">{{notification.notification_object.source.name}}</strong>
                    </button>
                    <small class="text-muted pe-2">{{notification.notification_object.timestamp}}</small>
                    <button type="button ms-2" class="btn-close" id="close-notification-{{notification.notification_object.pk}}" aria-label="Close"></button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <img src="{{notification.sender_pfp_url}}" class="rounded me-2" alt="" style="height: 2.5rem; width: 2.5rem">
                            <em>{{notification.notification_object.sender}}</em>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col mt-2">
                            {% if notification.notification_object.relevant_message.text %}
                                <p class="text-truncate">{{notification.notification_object.contents}}</p>
                            {% elif notification.notification_object.relevant_poll %}
                                <p class="text-truncate"><strong>Poll: </strong>{{notification.notification_object.contents}}</p>
                            {% else %}
                                {% if notification.notification_object.relevant_message.reply %}
                                    {% if notification.notification_object.relevant_message.image %}
                                        <p class="text-truncate">({{notification.notification_object.relevant_message.sender.user.username}} Replied to You): <strong>Image</strong></p>
                                    {% elif notification.notification_object.relevent_message.video %}
                                        <p class="text-truncate">({{notification.notification_object.relevant_message.sender.user.username}} Replied to You): <strong>Video</strong></p>
                                    {% elif notification.notification_object.relvevant_message.audio %}
                                        <p class="text-truncate">({{notification.notification_object.relevant_message.sender.user.username}} Replied to You): <strong>Audio</strong></p>
                                    {% else %}
                                    {% endif %}
                                {% else %}
                                <p class="text-truncate"><strong>{{notification.notification_object.contents}}</strong></p>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <script>
                $(document).ready(function () {
                    $('#close-notification-{{notification.notification_object.pk}}').click(function () {
                        $.ajax({
                            type: 'POST',
                            url: '/universal/remove-notification/',
                            data: {
                                'receiver': '{{username}}',
                                'type': 'notification-id',
                                'csrfmiddlewaretoken': '{{ csrf_token }}',
                                'notification_id': '{{notification.notification_object.pk}}'
                            },
                            success: function(response) {
                                console.log(response.notification_count, response.notification_counter)
                                var notification = $("#notification-{{notification.notification_object.pk}}")
                                notification.remove();
                                $('#notification-counter').text('');
                                $('#notification-counter').text(response.notification_count);
                                    if (response.notification_count == 0) {
                                        $('#notification-counter').text(response.notification_count).hide();
                                        $('#notification-counter').remove();
                                        $('#bell-icon').removeClass('bi-bell-fill');
                                        $('#bell-icon').addClass('bi-bell');
                                    }
                            }
                        })
                    })
                    $('#read-notification-{{notification.notification_object.pk}}').click(function () {
                        $.ajax({
                            type: 'POST',
                            url: '/universal/remove-notification/',
                            data: {
                                'receiver': '{{username}}',
                                'type': 'notification-id',
                                'csrfmiddlewaretoken': '{{ csrf_token }}',
                                'notification_id': '{{notification.notification_object.pk}}'
                            },
                            success: function(response) {
                                console.log(response.message)
                                var domain = window.location.origin;
                                var path = '/chat/{{notification.notification_object.source.name}}/{{notification.notification_object.source.pk}}'
                                window.location.href = domain + path
                            }
                        })
                    })
                })
                
            </script>
        {% endfor %}
{% endblock %}
{% block notification_count %}
    <div id="notification-indicatior">
        {% if notification_count == 0 %}
            <script>
                $(document).ready(function () {
                    var notification_count = '{{notification_count}}';
                    var notification_bell = $('#bell-icon');
                    notification_bell.removeClass('bi-bell-fill');
                    notification_bell.addClass('bi-bell');
                })
            </script>
        {% else %}
            <span class="top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notification-counter">{{ notification_count }}
        {% endif %}
    </div>
{% endblock %}
{% block chatrooms %}
    {% for chat_room in chat_rooms %}
    <div class="row">
        <div class="col-3">
            <button class="btn" onclick='location.href="/chat/{{chat_room.name}}/{{chat_room.id}}"'>
                <img src="{{chat_room.icon.url}}" style="max-width: 2.5rem; max-height: 2.5rem; border-radius: 35%;">
            </button>
        </div>
        <div class="col-7">
            <button class="btn" onclick='location.href="/chat/{{chat_room.name}}/{{chat_room.id}}"'>
                <p class="lead">{{chat_room.name}}</p>
            </button>
        </div>
        <br>
    {% endfor %}
{% endblock %}
{% block conversation %}
<div class="container">
    <div class="card p-0" style="height: 630px;" >
        <div class="card-header">
            <div class="row">
                <div class="col-1">
                    <img src="{{room.icon.url}}" alt="" class="p-2 rounded-circle" style="max-height: 4rem; max-width: 4rem;">
                </div>
                <div class="col-10">
                    <p class="lead text-start mt-3">{{room.name}}</p>
                </div>
                <div class="col-1">
                    <button type="button" class="btn mt-2" style="font-size: 2rem;" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                    <div class="btn-group">
                        <ul class="dropdown-menu ps-3" style="background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);"> 
                            <div class="row">
                                <div class="col">
                                    <!-- Redirect to page -->
                                    <button class="btn" type="button" onclick="location.href='/chat_settings/{{room.name}}/{{room.id}}/'"><li class="custom-icon"><i class="bi bi-gear-fill mt-1" style="font-size: 18px;"></i> Settings</li></button>
                                    <!-- Open offcanvas -->
                                    <button class="btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#detailsPage"><li class="custom-icon"><i class="bi bi-question-circle mt-1" style="font-size: 18px;"></i>Details</li></button>
                                    <!-- Open confirmation modal -->
                                    <button class="btn" type="button" id="leave-chatroom"><li class="custom-icon"><i class="bi bi-box-arrow-right mt-1" style="color: #dc3545; font-size: 18px;"></i> <p class="text-danger p-0 m-0">Leave</p></li></button>
                                </div>
                            </div>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- Details offcanvas -->
        <div class="offcanvas offcanvas-end" tabindex="-1" id="detailsPage">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title"></h5>Chatroom Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <div class="row">
                    <div class="col">
                        <p class="lead">Chatroom Members</p>
                        <ul class="custom-icon">
                            {% for user in room.users.all %}
                            <li><button class="btn" onclick="location.href='/profile/{{user.user.username}}'"><img src="{{user.pfp.url}}" alt="{{user.user.username}}'s profile picture" style="max-width: 2rem; max-height: 2rem; border-radius: 1rem;"> {{user.user.username}}</button></li>
                            <br>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal for leaving chatroom -->
        <div class="modal fade" id="leave-chatroom-modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <strong>WARNING</strong>
                    </div>
                    <div class="modal-body">
                        <p class="text-center">Do you wish to leave this chatroom?</p>
                        <p class="small text-center">This cannot be undone.</p>
                        <form method="post">
                            <div class="row">
                                <div class="col-6 d-flex justify-content-start">
                                    <button type="button" id="leave-chatroom-button"  class="btn btn-danger">Leave</button>
                                </div>
                                <div class="col-6 d-flex justify-content-end">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-target="#leave-chatroom-modal">Cancel</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% if room.owner.username == username %}
            <!-- Leave chatroom error modal (admin only) -->
            <div class="modal fade" id="leave-chatroom-error">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <strong>ERROR</strong>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col">
                                    <p class="lead text-center">Cannot Leave Chatroom.</p>
                                    <p class="text-center">Must assign someone to be the new owner of this chatroom first.</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer d-flex justify-content-center">
                            <div class="row">
                                <div class="col-6">
                                    <button type="button" class="btn btn-success" onclick="location.href='/chat_settings/{{room.name}}/{{room.id}}'">Go to settings</button>
                                </div>
                                <div class="col-6">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        <img src="{{room.room_bg_image.url}}" alt="" style="height: 547px; opacity: 30%; border-bottom-left-radius: 5px;">
        <div class="card-img-overlay" style="overflow-y: auto; margin-top: 80px;" id="conversationFrame">
            <div class="card-body" id="conversation-contents">
                {% for message_dict in messages %}
                    <div id="message-{{message_dict.message.id}}">
                        <div class="row">
                            <div class="col">
                                <p id="message-timestamp-{{message_dict.message.id}}" class="text-center"><em>{{message_dict.message.sent_at}}</em></p>
                            </div>
                        </div>
                        <div class="row">
                            {% if message_dict.message.sender.user.username == username %}
                                {% if message_dict.message.reply != None %}
                                    <div class="col-6">
                                    </div>
                                    <div class="col-6">
                                        <div class="row">
                                            <div class="col-10 hidden-options d-flex justify-content-end" data-message-id="{{message_dict.message.id}}" id="message-reply-container-{{message_dict.message.id}}">
                                                <div class="card p-0 pb-0 text-bg-light" style="width: 85%; border: none; opacity: 70%; z-index: 1; position: relative;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        <a href="#message-timestamp-{{message_dict.message.reply.id}}" class="btn p-0"><p class="small m-0"><em>REPLY:</em> {{message_dict.message.reply.sender}}</p></a>
                                                        {% if message_dict.message.reply.text %}
                                                            <a href="#message-timestamp-{{message_dict.message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0">{{message_dict.message.reply.text}}</p></a>
                                                        {% elif message_dict.message.reply.image %}
                                                            <a href="#message-timestamp-{{message_dict.message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0"><strong>Image</strong></p></a>
                                                        {% elif message_dict.message.reply.video %} 
                                                            <a href="#message-timestamp-{{message_dict.message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0"><strong>Video</strong></p></a>
                                                        {% elif message_dict.message.reply.audio %}
                                                            <a href="#message-timestamp-{{message_dict.message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0"><strong>Audio</strong></p></a>
                                                        {% else %}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-2">
                                                <p id="message-timestamp-{{message_dict.message.id}}" class="d-flex justify-content-start"><strong>You</strong></p>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-10 hidden-options d-flex justify-content-end" data-message-id="{{message_dict.message.id}}" id="message-body-container-{{message_dict.message.id}}">
                                                <div class="card text-bg-success" style="width: 85%; border: none; opacity: 85%;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        {% if message_dict.message.edited %}
                                                            <p class="small text-light p-0 m-0"><em>(edited)</em></p>
                                                        {% else %}
                                                        {% endif %}
                                                        {% if message_dict.message.text %}
                                                            <p>{{message_dict.message.text}}</p>
                                                        {% elif message_dict.message.image %}
                                                            <img src="{{message_dict.message.image.url}}" alt="" class="mt-1" style="width: 100%; height:fit-content; border-radius: 5px;">
                                                        {% elif message_dict.message.video %} 
                                                            <video src="{{message_dict.message.video.url}}" controls class="mt-1" style="width: 100%; height: fit-content; border-radius: 5px;"></video>
                                                        {% elif message_dict.message.audio %}
                                                            <audio src="{{message_dict.message.audio.url}}" controls class="mt-1"></audio>
                                                        {% else %}
                                                        {% endif %}
                                                        <div class="row">
                                                            <div class="col">
                                                                {% if message_dict.message.text %}
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="{{message_dict.message.text}}" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                                {% elif message_dict.message.image %}
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="Image" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                                {% elif message_dict.message.video %} 
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="Video" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                                {% elif message_dict.message.audio %}
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="Audio" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>                                                        
                                                                {% else %}
                                                                {% endif %}
                                                            </div>
                                                            <div id="reaction-button-col-{{message_dict.message.id}}" class="col d-flex justify-content-end">
                                                                {% if message_dict.message.reactions.exists %}
                                                                    {% if message_dict.has_reacted %}
                                                                        <button type="button" class="btn has-reacted react-button border-light" data-message-id="{{message_dict.message.id}}" data-number-of-reactions="{{message_dict.message|number_of_reactions}}" data-emoticon="{{message_dict.user_reaction}}">{{message_dict.user_reaction|emoticon|safe}} <p class="m-0 p-0 text-light d-inline-flex">{{message_dict.message|number_of_reactions}}</p></button>
                                                                    {% else %}
                                                                        <button type="button" class="btn react-button" data-message-id="{{message_dict.message.id}}" data-number-of-reactions="{{message_dict.message|number_of_reactions}}" data-popular-reaction="{{message_dict.message|most_popular_reaction}}">{{message_dict.message|most_popular_reaction:"unicode"|safe}} <p class="m-0 p-0 text-light d-inline-flex">{{message_dict.message|number_of_reactions}}</p></button>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <button type="button" class="btn react-button" data-message-id="{{message_dict.message.id}}" data-number-of-reactions="{{message_dict.message|number_of_reactions}}"><i class="bi bi-emoji-smile-fill" style="color: #ffffff;"></i> <p class="m-0 p-0 text-light d-inline-flex">{{message_dict.message|number_of_reactions}}</p></button>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-1">
                                                <img src="{{message_dict.message.sender.pfp.url}}" alt="" class="rounded-circle" style="max-width: 2rem; max-height: 2rem;">
                                            </div>
                                        </div>
                                    </div>
                                    {% if not message_dict.message.text %}
                                        <ul class="dropdown-menu options options-{{message_dict.message.id}} p-2 mb-1" style="width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                            {% if message_dict.message.image %}
                                                <button type="button" class="btn download-message" data-download-url="{{message_dict.message.image.url}}" data-type="image" data-message-id="{{message_dict.message.id}}"><i class="bi bi-download"></i> Download</button>
                                                {% if message_dict.message.reply.text %}
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="image" data-reply-type="text"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% elif message_dict.message.reply.image %}
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="image" data-reply-type="image"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% elif message_dict.message.reply.video %}
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="image" data-reply-type="video"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% elif message_dict.message.reply.audio %}
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="image" data-reply-type="audio"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% else %}
                                                {% endif %}
                                            {% elif message_dict.message.video %}
                                                <button type="button" class="btn download-message" data-download-url="{{message_dict.message.video.url}}" data-type="video" data-message-id="{{message_dict.message.id}}"><i class="bi bi-download"></i> Download</button>
                                                {% if message_dict.message.reply.text %}
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="video" data-reply-type="text"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% elif message_dict.message.reply.image %}
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="video" data-reply-type="image"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% elif message_dict.message.reply.video %}
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="video" data-reply-type="video"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% elif message_dict.message.reply.audio %}
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="video" data-reply-type="audio"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% else %}
                                                {% endif %}
                                            {% elif message_dict.message.audio %}
                                                <button type="button" class="btn download-message" data-download-url="{{message_dict.message.audio.url}}" data-type="audio" data-message-id="{{message_dict.message.id}}"><i class="bi bi-download"></i> Download</button>
                                                {% if message_dict.message.reply.text %}
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="audio" data-reply-type="text"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% elif message_dict.message.reply.image %}
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="audio" data-reply-type="image"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% elif message_dict.message.reply.video %}
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="audio" data-reply-type="video"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% elif message_dict.message.reply.audio %}
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="audio" data-reply-type="audio"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% else %}
                                                {% endif %}
                                            {% else %}
                                            {% endif %}
                                            <button type="button" class="btn delete-message" data-message-id="{{message_dict.message.id}}" data-type="general"><i class="bi bi-trash3-fill"></i> Delete</button>
                                        </ul>
                                    {% else %}
                                        <ul class="dropdown-menu options options-{{message_dict.message.id}} p-2 mb-1" style=" width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                            <button type="button" class="btn copy-message" data-text="{{message_dict.message.text}}"><i class="bi bi-copy"></i> Copy</button>
                                            {% if message_dict.message.reply.text %}
                                                <button type="button" class="btn edit-message" data-text="{{message_dict.message.text}}" data-message-id="{{message_dict.message.id}}" data-type="text" data-reply-type="text" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-reply-text="{{message_dict.message.reply.text}}"><i class="bi bi-pencil-fill"></i> Edit</button>
                                            {% elif message_dict.message.reply.image %}
                                                <button type="button" class="btn edit-message" data-text="{{message_dict.message.text}}" data-message-id="{{message_dict.message.id}}" data-type="text" data-reply-type="image" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}"><i class="bi bi-pencil-fill"></i> Edit</button>
                                            {% elif message_dict.message.reply.video %}
                                                <button type="button" class="btn edit-message" data-text="{{message_dict.message.text}}" data-message-id="{{message_dict.message.id}}" data-type="text" data-reply-type="video" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}"><i class="bi bi-pencil-fill"></i> Edit</button>
                                            {% elif message_dict.message.reply.audio %}
                                                <button type="button" class="btn edit-message" data-text="{{message_dict.message.text}}" data-message-id="{{message_dict.message.id}}" data-type="text" data-reply-type="audio" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}"><i class="bi bi-pencil-fill"></i> Edit</button>
                                            {% else %}
                                            {% endif %}
                                            <button type="button" class="btn delete-message" data-message-id="{{message_dict.message.id}}" data-type="general"><i class="bi bi-trash3-fill"></i> Delete</button>
                                        </ul>
                                    {% endif %}
                                    <ul id="reaction-response-{{message_dict.message.id}}" class="reaction-response dropdown-menu p-2 mb-1" data-message-id="{{message_dict.message.id}}" style=" width:300px; height:100px; overflow-y: auto; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                        <p class="lead text-center"><strong>Reactions</strong></p>
                                        {% for reaction in message_dict.message.reactions.all %}
                                            <button id="user-reaction-button-{{reaction.user.id}}" type="button" class="btn" onclick="location.href='/profile/{{reaction.user.user.username}}'">
                                                <div class="row d-flex justify-content-center">
                                                    <div class="col-2">
                                                        <img src="{{reaction.user.pfp.url}}" alt="" style="height: 40px; width: 40px; border-radius: 20px;">
                                                    </div>
                                                    <div class="col-8">
                                                        <p class="mt-2 ms-2 text-center">{{reaction.user.user.username}}</p>
                                                    </div>
                                                    <div class="col-2">
                                                        <p class="mt-2">{{reaction.reaction|emoticon|safe}}</p>
                                                    </div>
                                                </div>
                                            </button>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <div class="col-6">
                                    </div>
                                    <div class="col-6">
                                        <div class="row">
                                            <div class="col-11">
                                                <p class="d-flex justify-content-end"><strong>You</strong></p>
                                            </div>
                                            <div class="col-1">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-10 hidden-options d-flex justify-content-end" data-message-id="{{message_dict.message.id}}" id="message-body-container-{{message_dict.message.id}}">
                                                <div class="card text-bg-success" style="width: fit-content; border: none; opacity: 85%;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        {% if message_dict.message.edited %}
                                                            <p class="small text-light p-0 m-0"><em>(edited)</em></p>
                                                        {% else %}
                                                        {% endif %}
                                                        {% if message_dict.message.text %}
                                                            <p>{{message_dict.message.text}}</p>
                                                        {% elif message_dict.message.image %}
                                                            <img src="{{message_dict.message.image.url}}" alt="" class="mt-1" style="width: 100%; height:fit-content; border-radius: 5px;">
                                                        {% elif message_dict.message.video %} 
                                                            <video src="{{message_dict.message.video.url}}" controls class="mt-1" style="width: 100%; height: fit-content; border-radius: 5px;"></video>
                                                        {% elif message_dict.message.audio %}
                                                            <audio src="{{message_dict.message.audio.url}}" controls class="mt-1"></audio>
                                                        {% else %}
                                                            {% if message_dict.has_chosen %}
                                                                <div id="poll-message-{{message_dict.message.id}}" style="width: 300px;" data-graded-poll="true">
                                                                    <p class="small text-center">Poll</p>
                                                                    <p id="poll-title-{{message_dict.message.id}}">{{message_dict.message.title}}</p>
                                                                    {% for option_properties in message_dict.option_list %}
                                                                        {% if option_properties.chosen_by_user %}
                                                                            <div id="option-{{option_properties.option.id}}">
                                                                                <p class="m-0 text-start" id="option-{{option_properties.option.id}}-text" style="color: rgb(255, 255, 255);">{{option_properties.option.option}}</p>
                                                                                <div id="option-disribution-{{option_properties.option.id}}" class="progress" role="progressbar" aria-label="Option: {{option_properties.option.option}}" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                                                    <div class="progress-bar poll-progress-bar" id="percent-bar-{{option_properties.option.id}}" style="width: 0%; background-color: #1eff4b;" data-option-id="{{option_properties.option.id}}">
                                                                                        <button type="button" class="m-0 p-0 btn poll-option" id="poll-option-{{option_properties.option.id}}" data-option-id="{{option_properties.option.id}}"  data-hidden-info="<div class='row' id='hidden-info-{{option_properties.option.id}}'><div class='col'>{{option_properties.percent}}% Voted {% for choice in option_properties.option.choices.all %}<div class='row'><div class='col'><i class='bi bi-arrow-right-short'></i>{{choice.voter}}</div></div>{% endfor %}</div></div>">
                                                                                            <p class="m-0 text-start ps-2" id="option-{{option_properties.option.id}}-count" style="color: rgb(0, 0, 0);">{{option_properties.option_votes}}</p>
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                                <br>
                                                                            </div>
                                                                            <script text="text/javascript">
                                                                                $(document).ready(function () {
                                                                                    const progressBar = $('#percent-bar-{{option_properties.option.id}}');
                                                                                    if ('{{option_properties.percent}}' <= 10) {
                                                                                        progressBar.animate({ width: '10%' }, 1000, "easeOutQuad");
                                                                                    } else {
                                                                                        progressBar.animate({ width: "{{option_properties.percent}}%" }, 1000, "easeOutQuad");
                                                                                    }
                                                                                })
                                                                            </script>
                                                                        {% else %}
                                                                            <div id="option-{{option_properties.option.id}}">
                                                                                <p class="m-0 text-start" id="option-{{option_properties.option.id}}-text" style="color: rgb(255, 253, 253);">{{option_properties.option.option}}</p>
                                                                                <div id="option-disribution-{{option_properties.option.id}}" class="progress" role="progressbar" aria-label="Option: {{option_properties.option.option}}" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                                                    <div class="progress-bar poll-progress-bar" id="percent-bar-{{option_properties.option.id}}" style="width: 0%; background-color: #c3c3c3;" data-option-id="{{option_properties.option.id}}">
                                                                                        <button class="m-0 p-0 btn poll-option" id="poll-option-{{option_properties.option.id}}" data-option-id="{{option_properties.option.id}}"  data-hidden-info="<div class='row' id='hidden-info-{{option_properties.option.id}}'><div class='col'>{{option_properties.percent}}% Voted {% for choice in option_properties.option.choices.all %}<div class='row'><div class='col'><i class='bi bi-arrow-right-short'></i>{{choice.voter}}</div></div>{% endfor %}</div></div>">
                                                                                            <p class="m-0 text-start ps-2" id="option-{{option_properties.option.id}}-count" style="color: rgb(0, 0, 0);">{{option_properties.option_votes}}</p>
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                                <br>
                                                                            </div>
                                                                            <script text="text/javascript">
                                                                                $(document).ready(function () {
                                                                                    const progressBar = $('#percent-bar-{{option_properties.option.id}}');
                                                                                    if ('{{option_properties.percent}}' <= 10) {
                                                                                        progressBar.animate({ width: '10%' }, 1000, "easeOutQuad");
                                                                                    } else {
                                                                                        progressBar.animate({ width: "{{option_properties.percent}}%" }, 1000, "easeOutQuad");
                                                                                    }
                                                                                })
                                                                            </script>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                </div>
                                                            {% else %}
                                                                <div id="poll-message-{{message_dict.message.id}}" style="width: 300px;">
                                                                    <p class="small text-center">Poll</p>
                                                                    <p id="poll-title-{{message_dict.message.id}}">{{message_dict.message.title}}</p>
                                                                    {% for option in message_dict.message.options.all %}
                                                                        <div id="option-{{option.id}}">  
                                                                            <button class="btn btn-light poll-option" id="poll-option-{{option.id}}" data-option-id="{{option.id}}" style="width: 100%;">
                                                                                <p class="m-0 text-center" id="option-{{option.id}}-text">{{option.option}}</p>
                                                                            </button>
                                                                        </div>
                                                                        <br>
                                                                    {% endfor %}
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}
                                                        <div class="row">
                                                            <div class="col">
                                                                {% if message_dict.message.text %}
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="{{message_dict.message.text}}" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                                {% elif message_dict.message.image %}
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="Image" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                                {% elif message_dict.message.video %} 
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="Video" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                                {% elif message_dict.message.audio %}
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="Audio" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>                                                        
                                                                {% else %}
                                                                {% endif %}
                                                            </div>
                                                            <div id="reaction-button-col-{{message_dict.message.id}}" class="col d-flex justify-content-end">
                                                                {% if not message_dict.option_list %}
                                                                    {% if message_dict.message.reactions.exists %}
                                                                        {% if message_dict.has_reacted %}
                                                                            <button type="button" class="btn has-reacted react-button border-light" data-message-id="{{message_dict.message.id}}" data-number-of-reactions="{{message_dict.message|number_of_reactions}}" data-emoticon="{{message_dict.user_reaction}}">{{message_dict.user_reaction|emoticon|safe}} <p class="m-0 p-0 text-light d-inline-flex">{{message_dict.message|number_of_reactions}}</p></button>
                                                                        {% else %}
                                                                            <button type="button" class="btn react-button" data-message-id="{{message_dict.message.id}}" data-number-of-reactions="{{message_dict.message|number_of_reactions}}" data-popular-reaction="{{message_dict.message|most_popular_reaction}}">{{message_dict.message|most_popular_reaction:"unicode"|safe}} <p class="m-0 p-0 text-light d-inline-flex">{{message_dict.message|number_of_reactions}}</p></button>
                                                                        {% endif %}
                                                                    {% else %}
                                                                        <button type="button" class="btn react-button" data-message-id="{{message_dict.message.id}}" data-number-of-reactions="{{message_dict.message|number_of_reactions}}"><i class="bi bi-emoji-smile-fill" style="color: #ffffff;"></i> <p class="m-0 p-0 text-light d-inline-flex">{{message_dict.message|number_of_reactions}}</p></button>
                                                                    {% endif %}
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-1">
                                                <img src="{{message_dict.message.sender.pfp.url}}" alt="" class="rounded-circle" style="max-width: 2rem; max-height: 2rem;">
                                            </div>
                                        </div>
                                    </div>
                                    {% if not message_dict.option_list %}
                                        {% if not message_dict.message.text %}
                                            <ul class="dropdown-menu options options-{{message_dict.message.id}} p-2 mb-1" style="width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                                {% if message_dict.message.image %}
                                                    <button type="button" class="btn download-message" data-download-url="{{message_dict.message.image.url}}" data-type="image" data-message-id="{{message_dict.message.id}}"><i class="bi bi-download"></i> Download</button>
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="image"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% elif message_dict.message.video %}
                                                    <button type="button" class="btn download-message" data-download-url="{{message_dict.message.video.url}}" data-type="video" data-message-id="{{message_dict.message.id}}"><i class="bi bi-download"></i> Download</button>
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="video"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% elif message_dict.message.audio %}
                                                    <button type="button" class="btn download-message" data-download-url="{{message_dict.message.audio.url}}" data-type="audio" data-message-id="{{message_dict.message.id}}"><i class="bi bi-download"></i> Download</button>
                                                    <button type="button" class="btn edit-message" data-message-id="{{message_dict.message.id}}" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-type="audio"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                {% else %}
                                                {% endif %}
                                                <button type="button" class="btn delete-message" data-message-id="{{message_dict.message.id}}" data-type="general"><i class="bi bi-trash3-fill"></i> Delete</button>
                                            </ul>
                                        {% else %}
                                            <ul class="dropdown-menu options options-{{message_dict.message.id}} p-2 mb-1" style=" width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                                <button type="button" class="btn copy-message" data-text="{{message_dict.message.text}}" data-type="text"><i class="bi bi-copy"></i> Copy</button>
                                                <button type="button" class="btn edit-message" data-text="{{message_dict.message.text}}" data-message-id="{{message_dict.message.id}}" data-type="text" data-reply-id="{{message_dict.message.reply.id}}" data-reply-sender="{{message_dict.message.reply.sender}}" data-reply-text="{{message_dict.message.reply.text}}"><i class="bi bi-pencil-fill"></i> Edit</button>
                                                <button type="button" class="btn delete-message" data-message-id="{{message_dict.message.id}}" data-type="general"><i class="bi bi-trash3-fill"></i> Delete</button>
                                            </ul>
                                        {% endif %}
                                    {% else %}
                                        <ul class="dropdown-menu options options-{{message_dict.message.id}} p-2 mb-1" style=" width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                            <button type="button" class="btn delete-message" data-message-id="{{message_dict.message.id}}" data-type="poll"><i class="bi bi-trash3-fill"></i> Delete</button>
                                        </ul>
                                    {% endif %}
                                    <ul id="reaction-response-{{message_dict.message.id}}" class="reaction-response dropdown-menu p-2 mb-1" data-message-id="{{message_dict.message.id}}" style=" width:300px; height:100px; overflow-y: auto; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                        <p class="lead text-center"><strong>Reactions</strong></p>
                                        {% for reaction in message_dict.message.reactions.all %}
                                            <button id="user-reaction-button-{{reaction.user.id}}" type="button" class="btn" onclick="location.href='/profile/{{reaction.user.user.username}}'">
                                                <div class="row d-flex justify-content-center">
                                                    <div class="col-2">
                                                        <img src="{{reaction.user.pfp.url}}" alt="" style="height: 40px; width: 40px; border-radius: 20px;">
                                                    </div>
                                                    <div class="col-8">
                                                        <p class="mt-2 ms-2 text-center">{{reaction.user.user.username}}</p>
                                                    </div>
                                                    <div class="col-2">
                                                        <p class="mt-2">{{reaction.reaction|emoticon|safe}}</p>
                                                    </div>
                                                </div>
                                            </button>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            {% else %}
                                {% if message_dict.message.reply != None %}
                                    <div class="col-6">
                                        <div class="row">
                                            <div class="col">
                                                <p class="d-flex justify-content-start"><strong>{{message_dict.message.sender.user.username}}</strong></p>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-2">
                                                <img src="{{message_dict.message.sender.pfp.url}}" class="rounded-circle" alt="" style="max-width: 2rem; max-height: 2rem;">
                                            </div>
                                            <div class="col-10 hidden-options d-flex justify-content-start" data-message-id="{{message_dict.message.id}}" id="message-reply-container-{{message_dict.message.id}}">
                                                <div class="card p-0 pb-0 text-bg-light" style="width: 85%; border: none; opacity: 70%; z-index: 1; position: relative;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        <a href="#message-timestamp-{{message_dict.message.reply.id}}" class="btn p-0"><p class="small m-0"><em>REPLY:</em> {{message_dict.message.reply.sender}}</p></a>
                                                        {% if message_dict.message.reply.text %}
                                                            <a href="#message-timestamp-{{message_dict.message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0">{{message_dict.message.reply.text}}</p></a>
                                                        {% elif message_dict.message.reply.image %}
                                                            <a href="#message-timestamp-{{message_dict.message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0"><strong>Image</strong></p></a>
                                                        {% elif message_dict.message.reply.video %} 
                                                            <a href="#message-timestamp-{{message_dict.message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0"><strong>Video</strong></p></a>
                                                        {% elif message_dict.message.reply.audio %}
                                                            <a href="#message-timestamp-{{message_dict.message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0"><strong>Audio</strong></p></a>
                                                        {% else %}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-2">
                                            </div>
                                            <div class="col-10 hidden-options d-flex justify-content-start" data-message-id="{{message_dict.message.id}}" id="message-body-container-{{message_dict.message.id}}">
                                                <div class="card" style="width: 85%; border: none; opacity: 85%;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        {% if message_dict.message.edited %}
                                                            <p class="small p-0 m-0"><em>(edited)</em></p>
                                                        {% else %}
                                                        {% endif %}
                                                        {% if message_dict.message.text %}
                                                            <p>{{message_dict.message.text}}</p>
                                                        {% elif message_dict.message.image %}
                                                            <img src="{{message_dict.message.image.url}}" alt="" class="mt-1" style="width: 100%; height:fit-content; border-radius: 5px;">
                                                        {% elif message_dict.message.video %} 
                                                            <video src="{{message_dict.message.video.url}}" controls class="mt-1" style="width: 100%; height: fit-content; border-radius: 5px;"></video>
                                                        {% elif message_dict.message.audio %}
                                                            <audio src="{{message_dict.message.audio.url}}" controls class="mt-1"></audio>
                                                        {% else %}
                                                        {% endif %}
                                                        <div class="row">
                                                            <div class="col">
                                                                {% if message_dict.message.text %}
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="{{message_dict.message.text}}" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply"></i></button>
                                                                {% elif message_dict.message.image %}
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="Image" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply"></i></button>
                                                                {% elif message_dict.message.video %} 
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="Video" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply"></i></button>
                                                                {% elif message_dict.message.audio %}
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="Audio" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply"></i></button>                                                        
                                                                {% else %}
                                                                {% endif %}
                                                            </div>
                                                            <div id="reaction-button-col-{{message_dict.message.id}}" class="col d-flex justify-content-end">
                                                                {% if message_dict.message.reactions.exists %}
                                                                    {% if message_dict.has_reacted %}
                                                                        <button type="button" class="btn has-reacted react-button border-dark" data-message-id="{{message_dict.message.id}}" data-number-of-reactions="{{message_dict.message|number_of_reactions}}" data-emoticon="{{message_dict.user_reaction}}">{{message_dict.user_reaction|emoticon|safe}} <p class="m-0 p-0 d-inline-flex">{{message_dict.message|number_of_reactions}}</p></button>
                                                                    {% else %}
                                                                        <button type="button" class="btn react-button" data-message-id="{{message_dict.message.id}}" data-number-of-reactions="{{message_dict.message|number_of_reactions}}" data-popular-reaction="{{message_dict.message|most_popular_reaction}}">{{message_dict.message|most_popular_reaction:"unicode"|safe}} <p class="m-0 p-0 d-inline-flex">{{message_dict.message|number_of_reactions}}</p></button>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <button type="button" class="btn react-button" data-message-id="{{message_dict.message.id}}" data-number-of-reactions="{{message_dict.message|number_of_reactions}}"><i class="bi bi-emoji-smile-fill"></i> <p class="m-0 p-0 d-inline-flex">{{message_dict.message|number_of_reactions}}</p></button>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                    </div>
                                    {% if not message_dict.message.text %}
                                        <ul class="dropdown-menu options options-{{message_dict.message.id}} p-2 mb-1" style="width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                            {% if message_dict.message.image %}
                                                <button type="button" class="btn download-message" data-download-url="{{message_dict.message.image.url}}" data-type="image" data-message-id="{{message_dict.message.id}}"><i class="bi bi-download"></i> Download</button>
                                            {% elif message_dict.message.video %}
                                                <button type="button" class="btn download-message" data-download-url="{{message_dict.message.video.url}}" data-type="video" data-message-id="{{message_dict.message.id}}"><i class="bi bi-download"></i> Download</button>
                                            {% elif message_dict.message.audio %}
                                                <button type="button" class="btn download-message" data-download-url="{{message_dict.message.audio.url}}" data-type="audio" data-message-id="{{message_dict.message.id}}"><i class="bi bi-download"></i> Download</button>
                                            {% else %}
                                            {% endif %}
                                        </ul>
                                    {% else %}
                                        <ul class="dropdown-menu options options-{{message_dict.message.id}} p-2 mb-1" style=" width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                            <li><button type="button" class="btn copy-message" data-text="{{message_dict.message.text}}" data-message-id="{{message_dict.message.id}}"><i class="bi bi-copy"></i> Copy</button></li>
                                        </ul>
                                    {% endif %}
                                    <ul id="reaction-response-{{message_dict.message.id}}" class="reaction-response dropdown-menu p-2 mb-1" data-message-id="{{message_dict.message.id}}" style=" width:300px; height:100px; overflow-y: auto; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                        <p class="lead text-center"><strong>Reactions</strong></p>
                                        {% for reaction in message_dict.message.reactions.all %}
                                            <button id="user-reaction-button-{{reaction.user.id}}" type="button" class="btn" onclick="location.href='/profile/{{reaction.user.user.username}}'">
                                                <div class="row d-flex justify-content-center">
                                                    <div class="col-2">
                                                        <img src="{{reaction.user.pfp.url}}" alt="" style="height: 40px; width: 40px; border-radius: 20px;">
                                                    </div>
                                                    <div class="col-8">
                                                        <p class="mt-2 ms-2 text-center">{{reaction.user.user.username}}</p>
                                                    </div>
                                                    <div class="col-2">
                                                        <p class="mt-2">{{reaction.reaction|emoticon|safe}}</p>
                                                    </div>
                                                </div>
                                            </button>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <div class="col-6">
                                        <div class="row">
                                            <div class="col-10">
                                                <p class="d-flex justify-content-start"><strong>{{message_dict.message.sender.user.username}}</strong></p>
                                            </div>
                                            <div class="col-2">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-2">
                                                <img src="{{message_dict.message.sender.pfp.url}}" class="rounded-circle" alt="" style="max-width: 2rem; max-height: 2rem;">
                                            </div>
                                            <div class="col-10 hidden-options" data-message-id="{{message_dict.message.id}}" id="message-body-container-{{message_dict.message.id}}">
                                                <div class="card" style="width: fit-content; border: none; opacity: 85%;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        {% if message_dict.message.edited %}
                                                            <p class="small p-0 m-0"><em>(edited)</em></p>
                                                        {% else %}
                                                        {% endif %}
                                                        {% if message_dict.message.text %}
                                                            <p>{{message_dict.message.text}}</p>
                                                        {% elif message_dict.message.image %}
                                                            <img src="{{message_dict.message.image.url}}" alt="" class="mt-1" style="width: 100%; height:fit-content; border-radius: 5px;">
                                                        {% elif message_dict.message.video %} 
                                                            <video src="{{message_dict.message.video.url}}" controls class="mt-1" style="width: 100%; height: fit-content; border-radius: 5px;"></video>
                                                        {% elif message_dict.message.audio %}
                                                            <audio src="{{message_dict.message.audio.url}}" controls class="mt-1"></audio>
                                                        {% else %}
                                                            {% if message_dict.has_chosen %}
                                                                <div id="poll-message-{{message_dict.message.id}}" style="width: 300px;" data-graded-poll="true">
                                                                    <p class="small text-center">Poll</p>
                                                                    <p id="poll-title-{{message_dict.message.id}}">{{message_dict.message.title}}</p>
                                                                    {% for option_properties in message_dict.option_list %}
                                                                        {% if option_properties.chosen_by_user %}
                                                                            <div id="option-{{option_properties.option.id}}">
                                                                                <p class="m-0 text-start" id="option-{{option_properties.option.id}}-text" style="color: rgb(0, 0, 0);">{{option_properties.option.option}}</p>
                                                                                <div id="option-disribution-{{option_properties.option.id}}" class="progress" role="progressbar" aria-label="Option: {{option_properties.option.option}}" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                                                    <div class="progress-bar poll-progress-bar" id="percent-bar-{{option_properties.option.id}}" style="width: 0%; background-color: #1eff4b;" data-option-id="{{option_properties.option.id}}">
                                                                                        <button type="button" class="m-0 p-0 btn poll-option" id="poll-option-{{option_properties.option.id}}" data-option-id="{{option_properties.option.id}}"  data-hidden-info="<div class='row' id='hidden-info-{{option_properties.option.id}}'><div class='col'>{{option_properties.percent}}% Voted {% for choice in option_properties.option.choices.all %}<div class='row'><div class='col'><i class='bi bi-arrow-right-short'></i>{{choice.voter}}</div></div>{% endfor %}</div></div>">
                                                                                            <p class="m-0 text-start ps-2" id="option-{{option_properties.option.id}}-count" style="color: rgb(0, 0, 0);">{{option_properties.option_votes}}</p>
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                                <br>
                                                                            </div>
                                                                            <script text="text/javascript">
                                                                                $(document).ready(function () {
                                                                                    const progressBar = $('#percent-bar-{{option_properties.option.id}}');
                                                                                    if ('{{option_properties.percent}}' <= 10) {
                                                                                        progressBar.animate({ width: '10%' }, 1000, "easeOutQuad");
                                                                                    } else {
                                                                                        progressBar.animate({ width: "{{option_properties.percent}}%" }, 1000, "easeOutQuad");
                                                                                    }
                                                                                })
                                                                            </script>
                                                                        {% else %}
                                                                            <div id="option-{{option_properties.option.id}}">
                                                                                <p class="m-0 text-start" id="option-{{option_properties.option.id}}-text" style="color: rgb(0, 0, 0);">{{option_properties.option.option}}</p>
                                                                                <div id="option-disribution-{{option_properties.option.id}}" class="progress" role="progressbar" aria-label="Option: {{option_properties.option.option}}" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                                                    <div class="progress-bar poll-progress-bar" id="percent-bar-{{option_properties.option.id}}" style="width: 0%; background-color: #c3c3c3;" data-option-id="{{option_properties.option.id}}">
                                                                                        <button class="m-0 p-0 btn poll-option" id="poll-option-{{option_properties.option.id}}" data-option-id="{{option_properties.option.id}}"  data-hidden-info="<div class='row' id='hidden-info-{{option_properties.option.id}}'><div class='col'>{{option_properties.percent}}% Voted {% for choice in option_properties.option.choices.all %}<div class='row'><div class='col'><i class='bi bi-arrow-right-short'></i>{{choice.voter}}</div></div>{% endfor %}</div></div>">
                                                                                            <p class="m-0 text-start ps-2" id="option-{{option_properties.option.id}}-count" style="color: rgb(0, 0, 0);">{{option_properties.option_votes}}</p>
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                                <br>
                                                                            </div>
                                                                            <script text="text/javascript">
                                                                                $(document).ready(function () {
                                                                                    const progressBar = $('#percent-bar-{{option_properties.option.id}}');
                                                                                    if ('{{option_properties.percent}}' <= 10) {
                                                                                        progressBar.animate({ width: '10%' }, 1000, "easeOutQuad");
                                                                                    } else {
                                                                                        progressBar.animate({ width: "{{option_properties.percent}}%" }, 1000, "easeOutQuad");
                                                                                    }
                                                                                })
                                                                            </script>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                </div>
                                                            {% else %}
                                                                <div id="poll-message-{{message_dict.message.id}}" style="width: 300px;">
                                                                    <p class="small text-center">Poll</p>
                                                                    <p id="poll-title-{{message_dict.message.id}}">{{message_dict.message.title}}</p>
                                                                    {% for option in message_dict.message.options.all %}
                                                                        <div id="option-{{option.id}}">  
                                                                            <button class="btn btn-dark poll-option" id="poll-option-{{option.id}}" data-option-id="{{option.id}}" style="width: 100%;">
                                                                                <p class="m-0 text-center" id="option-{{option.id}}-text">{{option.option}}</p>
                                                                            </button>
                                                                        </div>
                                                                        <br>
                                                                    {% endfor %}
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}
                                                        <div class="row">
                                                            <div class="col">
                                                                {% if message_dict.message.text %}
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="{{message_dict.message.text}}" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply"></i></button>
                                                                {% elif message_dict.message.image %}
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="Image" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply"></i></button>
                                                                {% elif message_dict.message.video %} 
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="Video" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply"></i></button>
                                                                {% elif message_dict.message.audio %}
                                                                    <button type="button" class="btn reply" data-message-id="{{message_dict.message.id}}" data-message="Audio" data-message-sender="{{message_dict.message.sender.user.username}}" id="reply-button-{{message_dict.message.id}}"><i class="bi bi-reply"></i></button>                                                        
                                                                {% else %}
                                                                {% endif %}
                                                            </div>
                                                            <div id="reaction-button-col-{{message_dict.message.id}}" class="col d-flex justify-content-end">
                                                                {% if not message_dict.option_list %}
                                                                    {% if message_dict.message.reactions.exists %}
                                                                        {% if message_dict.has_reacted %}
                                                                            <button type="button" class="btn has-reacted react-button border-dark" data-message-id="{{message_dict.message.id}}" data-number-of-reactions="{{message_dict.message|number_of_reactions}}" data-emoticon="{{message_dict.user_reaction}}">{{message_dict.user_reaction|emoticon|safe}} <p class="m-0 p-0 d-inline-flex">{{message_dict.message|number_of_reactions}}</p></button>
                                                                        {% else %}
                                                                            <button type="button" class="btn react-button" data-message-id="{{message_dict.message.id}}" data-number-of-reactions="{{message_dict.message|number_of_reactions}}" data-popular-reaction="{{message_dict.message|most_popular_reaction}}">{{message_dict.message|most_popular_reaction:"unicode"|safe}} <p class="m-0 p-0 d-inline-flex">{{message_dict.message|number_of_reactions}}</p></button>
                                                                        {% endif %}
                                                                    {% else %}
                                                                        <button type="button" class="btn react-button" data-message-id="{{message_dict.message.id}}" data-number-of-reactions="{{message_dict.message|number_of_reactions}}"><i class="bi bi-emoji-smile-fill"></i> <p class="m-0 p-0 d-inline-flex">{{message_dict.message|number_of_reactions}}</p></button>
                                                                    {% endif %}
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                    </div>
                                    {% if not message_dict.option_list %}
                                        {% if not message_dict.message.text %}
                                            <ul class="dropdown-menu options options-{{message_dict.message.id}} p-2 mb-1" style="width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                                {% if message_dict.message.image %}
                                                    <button type="button" class="btn download-message" data-download-url="{{message_dict.message.image.url}}" data-type="image" data-message-id="{{message_dict.message.id}}"><i class="bi bi-download"></i> Download</button>
                                                {% elif message_dict.message.video %}
                                                    <button type="button" class="btn download-message" data-download-url="{{message_dict.message.video.url}}" data-type="video" data-message-id="{{message_dict.message.id}}"><i class="bi bi-download"></i> Download</button>
                                                {% elif message_dict.message.audio %}
                                                    <button type="button" class="btn download-message" data-download-url="{{message_dict.message.audio.url}}" data-type="audio" data-message-id="{{message_dict.message.id}}"><i class="bi bi-download"></i> Download</button>
                                                {% else %}
                                                {% endif %}
                                            </ul>
                                        {% else %}
                                            <ul class="dropdown-menu options options-{{message_dict.message.id}} p-2 mb-1" style=" width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                                <button type="button" class="btn copy-message" data-text="{{message_dict.message.text}}"><i class="bi bi-copy"></i> Copy</button>
                                            </ul>
                                        {% endif %}
                                    {% endif %}
                                    <ul id="reaction-response-{{message_dict.message.id}}" class="reaction-response dropdown-menu p-2 mb-1" data-message-id="{{message_dict.message.id}}" style=" width:300px; height:100px; overflow-y: auto; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                        <p class="lead text-center"><strong>Reactions</strong></p>
                                        {% for reaction in message_dict.message.reactions.all %}
                                            <button id="user-reaction-button-{{reaction.user.id}}" type="button" class="btn" onclick="location.href='/profile/{{reaction.user.user.username}}'">
                                                <div class="row d-flex justify-content-center">
                                                    <div class="col-2">
                                                        <img src="{{reaction.user.pfp.url}}" alt="" style="height: 40px; width: 40px; border-radius: 20px;">
                                                    </div>
                                                    <div class="col-8">
                                                        <p class="mt-2 ms-2 text-center">{{reaction.user.user.username}}</p>
                                                    </div>
                                                    <div class="col-2">
                                                        <p class="mt-2">{{reaction.reaction|emoticon|safe}}</p>
                                                    </div>
                                                </div>
                                            </button>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <br>
    <form action="" method="post">
        {% csrf_token %}
        <div class="row">
            <div class="col-1">
                <button type="button" class="btn btn-outline-success" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-plus-square" style="font-size:  3vw;"></i></button>
                <div class="btn-group dropup">
                    <ul class="dropdown-menu p-2 mb-1" style=" width:300px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">
                        <div class="row">
                            <div class="col-4">
                                <p>Messages</p>
                                <button class="btn" id="init-image" type="button"><li class="custom-icon"><div class="fs-4"><i class="bi bi-images"></i></div> Image</li></button>
                                <button class="btn" id="init-video" type="button"><li class="custom-icon"><div class="fs-4"><i class="bi bi-play-btn"></i></i></div> Video</li></button>
                                <button class="btn" id="init-voice" type="button"><li class="custom-icon"><div class="fs-4"><i class="bi bi-mic-fill"></i></div> Audio/Voice</li></button>
                            </div>
                            <div class="col-2">
                            </div>
                            <div class="col-4">
                                <p>Events</p>
                                <button class="btn" type="button" onclick="location.href='/{{room.name}}/{{room.id}}/create_poll/'"><li class="custom-icon"><div class="fs-4"><i class="bi bi-bar-chart-fill"></i></div> Poll</li></button>
                            </div>
                        </div>
                    </ul>
                </div>
            </div>
            <div class="col-10" id="message-div">
                <input type="hidden" id="is-reply" value="false">
                <input type="hidden" id="is-text" value="true">
                <input type="hidden" id="is-image" value="false">
                <input type="hidden" id="is-video" value="false">
                <input type="hidden" id="is-voice" value="false">
                <input type="text" id="message" class="form-control pb-3 p-4">
                <div class="card" id="suggested-response-card" style="display: none; max-height: 167px; overflow-y: auto;">
                    <div class="card-body">
                        <ul id="suggested-response" class="list-group mt-2"></ul>
                    </div>
                </div>
            </div>
            <div class="col-1">
                <div class="card">
                    <button type="button" id="send" class="btn btn-outline-success" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-send-fill" style="font-size: 3vw;"></i></button>
                </div>
            </div>
        </div>
    </form>
    <!-- Reactions popup -->
    <ul id="reactions" class="dropdown-menu p-2 mb-1" style=" width:300px; height:300px; overflow-y: auto; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
        <p class="lead text-center">Reactions</p>
        <div class="row">
            <div class="col d-flex justify-content-center">
                <input type="text" class="form-control popup-clickable" id="reaction-search">
            </div>
        </div>
        <br>
        <div id="emoticons-list" class="row">
            {% for emoticon in emoticon_dict.keys %}
                <div class="col d-flex justify-content-start">
                    <button type="button" class="btn emoticon" data-emoticon="{{emoticon}}">{{ emoticon|emoticon|safe }}</button>
                </div>
            {% endfor %}
        </div>
    </ul>
    <!-- Websocket for sending messages -->
    <script type="text/javascript">
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

        // for conviniance
        function scrollBarAtBottom() {
                var scrollableContent = document.getElementById("conversationFrame");
                scrollableContent.scrollTop = scrollableContent.scrollHeight;
            }
        let intervalId;
        setTimeout(scrollBarAtBottom(), 1000)
        var roomId = "{{ room.id }}";  // Django template variable for chatroom ID
        var roomName = "{{ room.name }}";  // Django template variable for chatroom name
        var reconnectionTime = 5000;
        let messageSocket
        let notificationSocket
        function setupReply(messageId, username, message) {
            const isReply = $('#is-reply'); // hidden input field where the message textfield is. tells us if a reply is being made or not.
            const isImage = $('#is-image');
            const isVideo = $('#is-video');
            const isVoice = $('#is-voice');
            const messageDiv = $('#message-div');

            const replyPromptHtml = `
                <div class="card mt-1" id="reply-prompt" style="border: none;">
                    <div class="card-header" style="border-bottom: none;">
                        <div class="row">
                            <div class="col">
                                <p class="lead">Replying to <strong>${username}</strong>:</p>
                            </div>
                            <div id="reply-information-holder" data-message-id="${messageId}"></div>
                            <div class="col">
                                <p class="text-truncate">${message}</p>
                            </div>
                        </div>
                    </div>
                </div>`;

            if (isReply.val() === 'false') { // if the reply prompt doesn't already exist
                if (isImage.val() === 'false' && isVideo.val() === 'false' && isVoice.val() === 'false') {
                    // Show the reply prompt on the user's screen
                    messageDiv.append(replyPromptHtml);
                    isReply.val('true'); // Set the reply value to true, indicating that a reply is being made.
                    $('html, body').animate({ scrollTop: $(document).height() }, 'fast'); // Animation for better GUI
                } else {
                    if (isImage.val() === 'true') {
                        var mediaInput = $('#image-prompt').detach();
                    } else if (isVideo.val() === 'true') {
                        var mediaInput = $('#video-prompt').detach();
                    } else if (isVoice.val() === 'true') {
                        var mediaInput = $('#voice-prompt').detach();
                    } else {
                        console.log('error')
                    }
                    var mediaInputHtml = mediaInput.prop('outerHTML');
                    messageDiv.append(`
                            <div class="row" id="multi-input-wrapper">
                                <div class="col-6">
                                    ${replyPromptHtml}
                                </div>
                                <div class="col-6">
                                    ${mediaInputHtml}
                                </div>
                            </div>
                        `);
                    isReply.val('true'); // Set the reply value to true, indicating that a reply is being made.
                    $('html, body').animate({ scrollTop: $(document).height() }, 'fast'); // Animation for better GUI
                }
            } else {
                if (isImage.val() === 'false' && isVideo.val() === 'false' && isVoice.val() === 'false') {
                    $('#reply-prompt').remove(); // Remove created HTML
                    isReply.val('false'); // Set the reply value to false, indicating that a reply is not being made.
                } else {
                    if (isImage.val() === 'true') {
                        var mediaInput = $('#image-prompt').detach();
                    } else if (isVideo.val() === 'true') {
                        var mediaInput = $('#video-prompt').detach();
                    } else if (isVoice.val() === 'true') {
                        var mediaInput = $('#voice-prompt').detach();
                    } else {
                        console.log('error')
                    }
                    var mediaInputHtml = mediaInput.prop('outerHTML');
                    $('#multi-input-wrapper').remove();
                    $('#reply-prompt').remove();
                    messageDiv.append(mediaInputHtml);
                    isReply.val('false');
                }
            }
        }

        function connectMessageSocket () {
            messageSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/realtime-message-manager/' + roomId
            );

            messageSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log(data);
                
                if (data.is_editing === 'true') {
                    var contentHtml = data.content_html;
                    var selfReplyButtonHtml = data.self_reply_button_html
                    var otherReplyButtonHtml = data.other_reply_button_html

                    var bodySection = $('#message-body-container-' + data.message_id);
                    var extraSection = $('.options-' + data.message_id)
                    if (data.type === 'incoming_message' || data.type === 'incoming_reply_message') {
                        var copyOption = data.right_click_options['copy_option'];
                        var downloadOption = data.right_click_options['download_option'];
                        if (data.username === '{{username}}') {
                            var editOption = data.right_click_options['edit_option'];
                            var deleteOption = data.right_click_options['delete_option'];

                            var newBodySectionHtml = `
                                <div class="card text-bg-success" style="width: 85%; border: none; opacity: 85%;">
                                    <div class="card-header" style="border-bottom: none;">
                                        <p class="small text-light p-0 m-0"><em>(edited)</em></p>
                                        ${contentHtml}
                                        <div class="row">
                                            <div class="col">
                                                ${selfReplyButtonHtml}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <ul class="dropdown-menu options options-${data.message_id} p-2 mb-1" style=" width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                    ${copyOption}
                                    ${downloadOption}
                                    ${editOption}
                                    ${deleteOption}
                                </ul>
                            `;
                        } else {
                            var newBodySectionHtml = `
                                <div class="card text-bg-light" style="width: 85%; border: none; opacity: 85%;">
                                    <div class="card-header" style="border-bottom: none;">
                                        <p class="small p-0 m-0"><em>(edited)</em></p>
                                        ${contentHtml}
                                        <div class="row">
                                            <div class="col">
                                                ${otherReplyButtonHtml}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <ul class="dropdown-menu options options-${data.message_id} p-2 mb-1" style=" width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                    ${copyOption}
                                    ${downloadOption}
                                </ul>
                            `;
                        }
                        extraSection.remove();

                        bodySection.html('');
                        bodySection.html(newBodySectionHtml)

                        if (data.replied_to_message_count > 0) {
                            for (let i = 1; i < data.replied_to_message_count + 1; i++ ) {
                                var replySection = $('#message-reply-container-' + data.replied_to_changes[i]['id'])
                                var replySectionHtml = `
                                    <div class="card p-0 pb-0 text-bg-light" style="width: 85%; border: none; opacity: 70%;">
                                        <div class="card-header" style="border-bottom: none;">
                                            <a href="#message-timestamp-` + data.message_id + `" class="btn p-0"><p class="small m-0"><em>REPLY:</em> ` + data.replied_to_changes[i]['user'] + `</p></a>
                                            ` + data.replied_to_changes[i]['html'] + `
                                        </div>
                                    </div>
                                `;

                                replySection.html('')
                                replySection.html(replySectionHtml)
                            }
                        }
                    } else {
                        console.log('Invalid message type.')
                    }
                
                } else if (data.type === 'deleting_message') {
                    var message = $('#message-' + data.message_id);
                    message.remove();

                } else if (data.type === 'incoming_new_reaction') {
                    var reaction = data.reaction;
                    var reactionUnicode = data.reaction_unicode;
                    var reactionCount = data.reaction_count;
                    var modeReaction = data.mode_reaction;
                    var modeReactionUnicode = data.mode_reaction_unicode;
                    var reactor = data.reactor;
                    var reactorPFP = data.reactor_pfp;
                    var reactorID = data.reactor_id;
                    var messageID = data.message_id;
                    var messageUser = data.message_user;

                    var reactionButtonWrapper = $('#reaction-button-col-' + messageID);
                    var reactionResponseWrapper = $('#reaction-response-' + messageID);

                    var newReactionButtonHtml;
                    if (reactor === '{{username}}') { // if we reacted
                        if (messageUser === '{{username}}') {// if we reacted to our own message
                            newReactionButtonHtml = `
                                <button type="button" class="btn has-reacted react-button border-light" data-message-id="${messageID}" data-popular-reaction="${modeReaction}" data-number-of-reactions="${reactionCount}" data-emoticon="${reaction}">
                                    ${reactionUnicode}
                                    <p class="m-0 p-0 text-light d-inline-flex">${reactionCount}</p>
                                </button>
                            `;
                        } else { // if we reacted to another message
                            newReactionButtonHtml = `
                                <button type="button" class="btn has-reacted react-button border-dark" data-message-id="${messageID}" data-popular-reaction="${modeReaction}" data-number-of-reactions="${reactionCount}" data-emoticon="${reaction}">
                                    ${reactionUnicode}
                                    <p class="m-0 p-0 d-inline-flex">${reactionCount}</p>
                                </button>
                            `;
                        } 
                    } else { // someone else reacted
                        var reactorsList = data.reactors_list;
                        var reactorsDict = data.reactors_dict;
                        var reactorsCount = data.reactors_count;
                        for (let i=0; i < reactorsCount; i++) { // loops though everyone who has reacted to this message
                            var userReaction = reactorsDict[reactorsList[i]]['reaction'];
                            var userReactionUnicode = reactorsDict[reactorsList[i]]['reaction_unicode'];
                            if (reactorsList[i] === '{{username}}') { // if this user has reacted before
                                if (messageUser === '{{username}}') {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn has-reacted react-button border-light" data-message-id="${messageID}" data-popular-reaction="${modeReaction}" data-number-of-reactions="${reactionCount}" data-emoticon="${userReaction}">
                                            ${userReactionUnicode}
                                            <p class="m-0 p-0 text-light d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                } else {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn has-reacted react-button border-dark" data-message-id="${messageID}" data-popular-reaction="${modeReaction}" data-number-of-reactions="${reactionCount}" data-emoticon="${userReaction}">
                                            ${userReactionUnicode}
                                            <p class="m-0 p-0 d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                }
                            } else { // if this user hasn't reacted before
                                if (messageUser === '{{username}}') {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn react-button" data-message-id="${messageID}" data-popular-reaction="${modeReaction}" data-number-of-reactions="${reactionCount}" data-emoticon="${modeReaction}">
                                            ${modeReactionUnicode}
                                            <p class="m-0 p-0 text-light d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                } else {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn react-button" data-message-id="${messageID}" data-popular-reaction="${modeReaction}" data-number-of-reactions="${reactionCount}" data-emoticon="${modeReaction}">
                                            ${modeReactionUnicode}
                                            <p class="m-0 p-0 d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                }
                            }
                        }
                    }

                    if (newReactionButtonHtml) {
                        reactionButtonWrapper.html(newReactionButtonHtml);
                        var reactionResponseButtonHtml = `
                            <button id="user-reaction-button-${reactorID}" type="button" class="btn" onclick="location.href='/profile/${reactor}'">
                                <div class="row d-flex justify-content-center">
                                    <div class="col-2">
                                        <img src="${reactorPFP}" alt="${reactor}'s Profile Picture" style="height: 40px; width: 40px; border-radius: 20px;">
                                    </div>
                                    <div class="col-8">
                                        <p class="mt-2 ms-2 text-center">${reactor}</p>
                                    </div>
                                    <div class="col-2">
                                        <p class="mt-2">${reactionUnicode}</p>
                                    </div>
                                </div>
                            </button>
                        `;
                        reactionResponseWrapper.append(reactionResponseButtonHtml);
                    }

                } else if (data.type === 'incoming_replace_reaction') {
                    // change reaction button accordingly, remove and add new button contaning a new emoticon for that users reaction.
                    var reaction = data.reaction;
                    var reactionUnicode = data.reaction_unicode;
                    var reactionCount = data.reaction_count;
                    var modeReaction = data.mode_reaction;
                    var modeReactionUnicode = data.mode_reaction_unicode;
                    var reactor = data.reactor;
                    var reactorPFP = data.reactor_pfp;
                    var reactorID = data.reactor_id;
                    var messageID = data.message_id;
                    var messageUser = data.message_user;

                    var reactionButtonWrapper = $('#reaction-button-col-' + messageID);
                    var reactionResponseWrapper = $('#reaction-response-' + messageID);

                    var newReactionButtonHtml;
                    if (reactor === '{{username}}') { // our replacement of the emoticon
                        if (messageUser === '{{username}}') { // if we reacted to ouw own message
                            newReactionButtonHtml = `
                                <button type="button" class="btn has-reacted react-button border-light" data-message-id="${messageID}" data-popular-reaction="${modeReaction}" data-number-of-reactions="${reactionCount}" data-emoticon="${reaction}">
                                    ${reactionUnicode}
                                    <p class="m-0 p-0 text-light d-inline-flex">${reactionCount}</p>
                                </button>
                            `;
                        } else { // if we reacted to another message
                            newReactionButtonHtml = `
                                <button type="button" class="btn has-reacted react-button border-dark" data-message-id="${messageID}" data-popular-reaction="${modeReaction}" data-number-of-reactions="${reactionCount}" data-emoticon="${reaction}">
                                    ${reactionUnicode}
                                    <p class="m-0 p-0 d-inline-flex">${reactionCount}</p>
                                </button>
                            `;
                        } 
                    } else { // someone else's replacement
                        console.log(reactorsDict)
                        for (let i=0; i < reactorsCount; i++) {
                            var userReaction = reactorsDict[reactorsList[i]]['reaction'];
                            var userReactionUnicode = reactorsDict[reactorsList[i]]['reaction_unicode'];
                            if (reactor === '{{username}}') { // you removed the reaction
                                if (messageUser === '{{username}}') {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn react-button" data-message-id="${messageID}" data-number-of-reactions="${reactionCount}" data-emoticon="${modeReaction}">
                                            ${modeReactionUnicode}
                                            <p class="m-0 p-0 text-light d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                } else {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn react-button" data-message-id="${messageID}" data-number-of-reactions="${reactionCount}" data-emoticon="${modeReaction}">
                                            ${modeReactionUnicode}
                                            <p class="m-0 p-0 d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                }
                            } else if (reactorsList[i] === '{{username}}') { // reacted, didn't change their reaction
                                if (messageUser === '{{username}}') {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn react-button has-reacted border-light" data-message-id="${messageID}" data-number-of-reactions="${reactionCount}" data-emoticon="${userReaction}">
                                            ${userReactionUnicode}
                                            <p class="m-0 p-0 text-light d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                } else {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn react-button has-reacted border-dark" data-message-id="${messageID}" data-number-of-reactions="${reactionCount}" data-emoticon="${userReaction}">
                                            ${userReactionUnicode}
                                            <p class="m-0 p-0 d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                }
                            } else { // didn't react at all
                                if (messageUser === '{{username}}') {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn react-button" data-message-id="${messageID}" data-number-of-reactions="${reactionCount}" data-emoticon="${modeReaction}">
                                            ${modeReactionUnicode}
                                            <p class="m-0 p-0 text-light d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                } else {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn react-button" data-message-id="${messageID}" data-number-of-reactions="${reactionCount}" data-emoticon="${modeReaction}">
                                            ${modeReactionUnicode}
                                            <p class="m-0 p-0 d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                }
                            }
                        }
                    }

                    if (newReactionButtonHtml) {
                        reactionButtonWrapper.html(newReactionButtonHtml);
                        reactedButton.remove()
                        var reactionResponseButtonHtml = `
                            <button id="user-reaction-button-${reactorID}" type="button" class="btn" onclick="location.href='/profile/${reactor}'">
                                <div class="row d-flex justify-content-center">
                                    <div class="col-2">
                                        <img src="${reactorPFP}" alt="${reactor}'s Profile Picture" style="height: 40px; width: 40px; border-radius: 20px;">
                                    </div>
                                    <div class="col-8">
                                        <p class="mt-2 ms-2 text-center">${reactor}</p>
                                    </div>
                                    <div class="col-2">
                                        <p class="mt-2">${reactionUnicode}</p>
                                    </div>
                                </div>
                            </button>
                        `;
                        reactionResponseWrapper.append(reactionResponseButtonHtml);
                    }

                } else if (data.type === 'incoming_remove_reaction') {
                    var modeReaction = data.mode_reaction;
                    var modeReactionUnicode = data.mode_reaction_unicode;

                    var reactionCount = data.reaction_count;
                    var reactor = data.reactor;
                    var reactorID = data.reactor_id;
                    var reactorsList = data.reactors_list;
                    var reactorsDict = data.reactors_dict;
                    var reactorsCount = data.reactors_count;

                    var messageID = data.message_id;
                    var messageUser = data.message_user;

                    var reactionButtonWrapper = $('#reaction-button-col-' + messageID);
                    var reactedButton = $('#user-reaction-button-' + reactorID);

                    var newReactionButtonHtml;
                    if (reactionCount === 0) { // no reactions left
                        if (messageUser === '{{username}}') {
                            newReactionButtonHtml = `
                                <button type="button" class="btn react-button" data-message-id="${messageID}" data-number-of-reactions="${reactionCount}">
                                    <i class="bi bi-emoji-smile-fill" style="color:#ffffff;"></i>
                                    <p class="m-0 p-0 text-light d-inline-flex">${reactionCount}</p>
                                </button>
                            `;
                        } else {
                            newReactionButtonHtml = `
                                <button type="button" class="btn react-button" data-message-id="${messageID}" data-number-of-reactions="${reactionCount}">
                                    <i class="bi bi-emoji-smile-fill"></i>
                                    <p class="m-0 p-0 d-inline-flex">${reactionCount}</p>
                                </button>
                            `;
                        }
                    } else { // are reactions left
                        for (let i=0; i < reactorsCount; i++) {
                            var userReaction = reactorsDict[reactorsList[i]]['reaction'];
                            var userReactionUnicode = reactorsDict[reactorsList[i]]['reaction_unicode'];
                            if (reactor === '{{username}}') { // you removed the reaction
                                if (messageUser === '{{username}}') {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn react-button" data-message-id="${messageID}" data-number-of-reactions="${reactionCount}" data-emoticon="${modeReaction}">
                                            ${modeReactionUnicode}
                                            <p class="m-0 p-0 text-light d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                } else {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn react-button" data-message-id="${messageID}" data-number-of-reactions="${reactionCount}" data-emoticon="${modeReaction}">
                                            ${modeReactionUnicode}
                                            <p class="m-0 p-0 d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                }
                            } else if (reactorsList[i] === '{{username}}') { // reacted, didn't delete their reaction
                                if (messageUser === '{{username}}') {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn react-button has-reacted border-light" data-message-id="${messageID}" data-number-of-reactions="${reactionCount}" data-emoticon="${userReaction}">
                                            ${userReactionUnicode}
                                            <p class="m-0 p-0 text-light d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                } else {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn react-button has-reacted border-dark" data-message-id="${messageID}" data-number-of-reactions="${reactionCount}" data-emoticon="${userReaction}">
                                            ${userReactionUnicode}
                                            <p class="m-0 p-0 d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                }
                            } else { // didn't react at all
                                if (messageUser === '{{username}}') {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn react-button" data-message-id="${messageID}" data-number-of-reactions="${reactionCount}" data-emoticon="${modeReaction}">
                                            ${modeReactionUnicode}
                                            <p class="m-0 p-0 text-light d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                } else {
                                    newReactionButtonHtml = `
                                        <button type="button" class="btn react-button" data-message-id="${messageID}" data-number-of-reactions="${reactionCount}" data-emoticon="${modeReaction}">
                                            ${modeReactionUnicode}
                                            <p class="m-0 p-0 d-inline-flex">${reactionCount}</p>
                                        </button>
                                    `;
                                }
                            }
                        }
                    }
                    if (newReactionButtonHtml) {
                        reactionButtonWrapper.html(newReactionButtonHtml);
                        reactedButton.remove()
                    }

                } else {
                    var contentHtml = data.content_html;
                    var selfReplyButtonHtml = data.self_reply_button_html
                    var otherReplyButtonHtml = data.other_reply_button_html

                    var copyOption = data.right_click_options['copy_option'];
                    var downloadOption = data.right_click_options['download_option'];

                    if (data.type === 'incoming_message') { // If the message wasn't a reply
                        if (data.username === '{{username}}') { // Self
                            var editOption = data.right_click_options['edit_option'];
                            var deleteOption = data.right_click_options['delete_option'];

                            var newMessageInHtml = `
                                <div id="message-${data.message_id}">
                                    <div class="row">
                                        <div class="col">
                                            <p id="message-timestamp-${data.message_id}" class="text-center"><em>` + data.sent_at + `</em></p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                        </div>
                                        <div class="col-6">
                                            <div class="row">
                                                <div class="col-11">
                                                    <p class="d-flex justify-content-end"><strong>You</strong></p>
                                                </div>
                                                <div class="col-1">
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-10 hidden-options d-flex justify-content-end" data-message-id="${data.message_id}" id="message-body-container-${data.message_id}">
                                                    <div class="card text-bg-success pb-0" style="width: fit-content; border: none; opacity: 85%;">
                                                        <div class="card-header" style="border-bottom: none;">
                                                            ` + contentHtml + `
                                                            <div class="row">
                                                                <div class="col">
                                                                    ` + selfReplyButtonHtml + `
                                                                </div>
                                                                <div id="reaction-button-col-${data.message_id}" class="col d-flex justify-content-end">
                                                                    <button type="button" class="btn react-button" data-message-id="${data.message_id}" data-number-of-reactions="0"><i class="bi bi-emoji-smile-fill" style="color: #ffffff;"></i> <p class="m-0 p-0 text-light d-inline-flex">0</p></button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-1">
                                                    <img src="` + data.user_pfp_url + `" alt="" class="rounded-circle" style="max-width: 2rem; max-height: 2rem;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <ul class="dropdown-menu options options-${data.message_id} p-2 mb-1" style="width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                        ${copyOption}
                                        ${downloadOption}
                                        ${editOption}
                                        ${deleteOption}
                                    </ul>
                                    <ul id="reaction-response-${data.message_id}" class="reaction-response dropdown-menu p-2 mb-1" data-message-id="${data.message_id}" style=" width:300px; height:100px; overflow-y: auto; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                        <p class="lead text-center"><strong>Reactions</strong></p>
                                    </ul>
                                </div>
                                `;
                        } 
                        else { // other
                            var newMessageInHtml = `
                                <div id="message-${data.message_id}">
                                    <div class="row">
                                        <div class="col">
                                            <p id="message-timestamp-${data.message_id}" class="text-center"><em>` + data.sent_at + `</em></p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="row">
                                                <div class="col-10">
                                                    <p class="d-flex justify-content-start"><strong>` + data.username + `</strong></p>
                                                </div>
                                                <div class="col-2">
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-2">
                                                    <img src="` + data.user_pfp_url + `" class="rounded-circle" alt="" style="max-width: 2rem; max-height: 2rem;">
                                                </div>
                                                <div class="col-10 hidden-options" data-message-id="${data.message_id}"  id="message-body-container-${data.message_id}">
                                                    <div class="card" style="width: fit-content; border: none; opacity: 85%;">
                                                        <div class="card-header" style="border-bottom: none;">
                                                            ` + contentHtml + `
                                                            <div class="row">
                                                                <div class="col">
                                                                    ` + otherReplyButtonHtml + `
                                                                </div>
                                                                <div id="reaction-button-col-${data.message_id}" class="col d-flex justify-content-end">
                                                                    <button type="button" class="btn react-button" data-message-id="${data.message_id}" data-number-of-reactions="0"><i class="bi bi-emoji-smile-fill"></i> <p class="m-0 p-0 text-light d-inline-flex">0</p></button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    <div class="col-6">
                                    </div>
                                    <ul class="dropdown-menu options options-${data.message_id} p-2 mb-1" style="width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                        ${copyOption}
                                        ${downloadOption}
                                    </ul>
                                    <ul id="reaction-response-${data.message_id}" class="reaction-response dropdown-menu p-2 mb-1" data-message-id="${data.message_id}" style=" width:300px; height:100px; overflow-y: auto; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                        <p class="lead text-center"><strong>Reactions</strong></p>
                                    </ul>
                                </div>
                                `;
                        }
                    }
                    else if (data.type === 'incoming_reply_message') { // For replies
                        var replyHtml = data.reply_html; // Get special html for a reply message
                        if (data.username === '{{username}}') { // Self
                            var editOption = data.right_click_options['edit_option'];
                            var deleteOption = data.right_click_options['delete_option'];

                            var newMessageInHtml = `
                                <div id="message-${data.message_id}">
                                    <div class="row">
                                        <div class="col">
                                            <p id="message-timestamp-${data.message_id}" class="text-center"><em>` + data.sent_at + `</em></p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                        </div>
                                        <div class="col-6">
                                            <div class="row">
                                                <div class="col-10 hidden-options d-flex justify-content-end" data-message-id="${data.message_id} id="message-reply-container-${data.message_id}">
                                                    <div class="card p-0 pb-0 text-bg-light" style="width: 85%; border: none; opacity: 70%;">
                                                        <div class="card-header" style="border-bottom: none;">
                                                            <a href="#message-timestamp-` + data.reply_id + `" class="btn p-0"><p class="small m-0"><em>REPLY:</em> ` + data.reply_message_user + `</p></a>
                                                            ` + replyHtml + `
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-2">
                                                    <p class="d-flex justify-content-start"><strong>You</strong></p>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-10 hidden-options d-flex justify-content-end" data-message-id="${data.message_id}" id="message-body-container-${data.message_id}">
                                                    <div class="card pb-0 text-bg-success" style="width: 85%; border: none; opacity: 85%;">
                                                        <div class="card-header" style="border-bottom: none;">
                                                            ` + contentHtml + `
                                                            <div class="row">
                                                                <div class="col">
                                                                    ` + selfReplyButtonHtml + `
                                                                </div>
                                                                <div id="reaction-button-col-${data.message_id}" class="col d-flex justify-content-end">
                                                                    <button type="button" class="btn react-button" data-message-id="${data.message_id}" data-number-of-reactions="0"><i class="bi bi-emoji-smile-fill" style="color: #ffffff;"></i> <p class="m-0 p-0 d-inline-flex">0</p></button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-1">
                                                    <img src="` + data.user_pfp_url + `" alt="" class="rounded-circle" style="max-width: 2rem; max-height: 2rem;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <ul class="dropdown-menu options options-${data.message_id} p-2 mb-1" style="width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                        ${copyOption}
                                        ${downloadOption}
                                        ${editOption}
                                        ${deleteOption}
                                    </ul>
                                    <ul id="reaction-response-${data.message_id}" class="reaction-response dropdown-menu p-2 mb-1" data-message-id="${data.message_id}" style=" width:300px; height:100px; overflow-y: auto; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                        <p class="lead text-center"><strong>Reactions</strong></p>
                                    </ul>
                                </div>
                                `;
                            } else { // Other
                                var newMessageInHtml = `
                                    <div id="message-${data.message_id}">
                                        <div class="row">
                                            <div class="col">
                                                <p id="message-timestamp-${data.message_id}" class="text-center"><em>` + data.sent_at + `</em></p>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="row">
                                                    <div class="col">
                                                        <p class="d-flex justify-content-start"><strong>` + data.username + `</strong></p>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-2">
                                                        <img src="` + data.user_pfp_url +`" class="rounded-circle" alt="" style="max-width: 2rem; max-height: 2rem;">
                                                    </div>
                                                    <div class="col-10 hidden-options d-flex justify-content-start" data-message-id="${data.message_id}" id="message-reply-container-${data.message_id}">
                                                        <div class="card p-0 pb-0 text-bg-light" style="width: 85%; border: none; opacity: 70%;">
                                                            <div class="card-header" style="border-bottom: none;">
                                                                <a href="#message-timestamp-` + data.reply_id + `" class="btn p-0"><p class="small m-0"><em>REPLY:</em> ` + data.reply_message_user + `</p></a>
                                                                ` + replyHtml + `
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-2">
                                                    </div>
                                                    <div class="col-10 d-flex justify-content-start" data-message-id="${data.message_id}" id="message-body-container-${data.message_id}">
                                                        <div class="card pb-0" style="width: 85%; border: none; opacity: 85%;">
                                                            <div class="card-header" style="border-bottom: none;">
                                                                ` + contentHtml + `
                                                                <div class="row">
                                                                    <div class="col">
                                                                        ` + otherReplyButtonHtml + `
                                                                    </div>
                                                                    <div id="reaction-button-col-${data.message_id}" class="col d-flex justify-content-end">
                                                                        <button type="button" class="btn react-button" data-message-id="${data.message_id}" data-number-of-reactions="0"><i class="bi bi-emoji-smile-fill"></i> <p class="m-0 p-0 d-inline-flex">0</p></button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                            </div>
                                        </div>
                                        <ul class="dropdown-menu options options-${data.message_id} p-2 mb-1" style="width:100px; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                            ${copyOption}
                                            ${downloadOption}
                                        </ul>
                                        <ul id="reaction-response-${data.message_id}" class="reaction-response dropdown-menu p-2 mb-1" data-message-id="${data.message_id}" style=" width:300px; height:100px; overflow-y: auto; background: rgba(255, 255, 255, 1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none;">
                                            <p class="lead text-center"><strong>Reactions</strong></p>
                                        </ul>
                                    </div>
                                    `;
                            }
                    }
                    // Add in extra html for the reaction button and the reaction response popup
                    $('#conversation-contents').append(newMessageInHtml);
                    setTimeout(scrollBarAtBottom(), 1000)

                    $.ajax({
                        type: 'POST',
                        url: '/universal/remove-notification/',
                        data: {
                            'type': 'message-id',
                            'message-id': data.message_id,
                            'receiver': '{{username}}',
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function(response) {
                            console.log('Notification removed')
                        }
                    });
                }
            };
            messageSocket.onclose = function (e) {
                console.error('WebSocket closed unexpectedly:', e);
                setTimeout(connectMessageSocket, reconnectionTime);
            }

            messageSocket.onerror = function (e) {
                console.error('WebSocket encountered error:', e);
            }
        }
        
        function connectEventSocket () {
            eventSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/realtime-event-manager/' + roomId
            );
            
            eventSocket.onopen = function(e) {
                console.log('connected', e);
            };

            eventSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                console.log(data)
                if (data.type === 'incoming_poll_message') {
                    if (data.sender === '{{username}}') {
                        let optionsHtml = '';
                        // for loop
                        for (let i = 0; i < data.option_count; i++ ) {
                            var optionHtml = `
                                <div id="option-` + data.options[i].option_id + `">  
                                    <button class="btn btn-light poll-option" id="poll-option-` + data.options[i].option_id + `" data-option-id="` + data.options[i].option_id + `" style="width: 100%;">
                                        <p class="m-0 text-center" id="option-` + data.options[i].option_id + `-text">` + data.options[i].option_name + `</p>
                                    </button>
                                </div>
                                <br>
                            `;
                            optionsHtml += optionHtml
                        } 
                        var newMessageInHtml = `
                            <div class="message">
                                <div class="row">
                                    <div class="col">
                                        <p class="text-center"><em>` + data.poll_sent_at + `</em></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                    </div>
                                    <div class="col-6">
                                        <div class="row">
                                            <div class="col-11">
                                                <p class="d-flex justify-content-end"><strong>You</strong></p>
                                            </div>
                                            <div class="col-1">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-10 d-flex justify-content-end">
                                                <div class="card text-bg-success pb-0" style="width: fit-content; border: none; opacity: 85%;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        <div id="poll-message-{{message_dict.message.id}}" style="width: 300px;">
                                                            <p class="small text-center">Poll</p>
                                                            <p id="poll-title-{{message_dict.message.id}}">` + data.poll_title + `</p>
                                                            ` + optionsHtml + `
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-1">
                                                <img src="` + data.sender_pfp_url + `" alt="" class="rounded-circle" style="max-width: 2rem; max-height: 2rem;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        
                    }
                    else {
                        let optionsHtml = '';
                        // for loop
                        for (let i=0; i < data.option_count; i++ ) {
                            var optionHtml = `
                                <div id="option-` + data.options[i].option_id + `">  
                                    <button class="btn btn-dark poll-option" id="poll-option-` + data.options[i].option_id + `" data-option-id="` + data.options[i].option_id + `" style="width: 100%;">
                                        <p class="m-0 text-center" id="option-` + data.options[i].option_id + `-text">` + data.options[i].option_name + `</p>
                                    </button>
                                </div>
                                <br>
                            `;
                            optionsHtml += optionHtml
                        }
                        var newMessageInHtml = `
                            <div class="message">
                                <div class="row">
                                    <div class="col">
                                        <p class="text-center"><em>` + data.poll_sent_at + `</em></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="row">
                                            <div class="col-11">
                                                <p class="d-flex justify-content-start"><strong>` + data.sender + `</strong></p>
                                            </div>
                                            <div class="col-1">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-1">
                                                <img src="` + data.sender_pfp_url + `" alt="" class="rounded-circle" style="max-width: 2rem; max-height: 2rem;">
                                            </div>
                                            <div class="col-10 d-flex justify-content-start">
                                                <div class="card text-bg-light pb-0" style="width: fit-content; border: none; opacity: 85%;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        <div id="poll-message-{{message_dict.message.id}}" style="width: 300px;">
                                                            <p class="small text-center">Poll</p>
                                                            <p id="poll-title-{{message_dict.message.id}}">` + data.poll_title + `</p>
                                                            ` + optionsHtml + `
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                    </div>
                                </div>
                            </div>`;
                    }
                    $('#conversation-contents').append(newMessageInHtml);
                    setTimeout(scrollBarAtBottom(), 1000);
                    $.ajax({
                        type: 'POST',
                        url: '/universal/remove-notification/',
                        data: {
                            'type': 'poll_message_id',
                            'poll_id': data.poll_id,
                            'receiver': '{{username}}',
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function(response) {
                            console.log('Notification removed')
                        }
                    });
                }
                if (data.type === 'incoming_poll_vote') {
                    if (data.voter === '{{username}}') { // if we made the vote
                        if ($('#poll-message-' + data.poll_id).data('graded-poll')) { // if we have already voted beforehand
                            // change specific things
                            // get relevant HTML elements, change them.
                            for (let i = 0; i < data.option_count; i++) {
                                // getting relevant HTML elements
                                var percentBar = $('#percent-bar-' + data.options[i].option_id);
                                var optionButton = $('#poll-option-' + data.options[i].option_id);
                                var optionCountElement = $('#option-' + data.options[i].option_id + '-count' );
                                
                                // store new information into variables
                                var percent = data.options[i].vote_percent;
                                var optionCount = data.options[i].amount_of_votes;
                                var choicesHtml = '';
                                for (let q = 0; q < data.options[i].amount_of_votes; q++) {
                                    var choiceHtml = `
                                        <div class='row'>
                                            <div class='col'>
                                                <i class='bi bi-arrow-right-short'></i>` + data.options[i].voters[q].voter + `
                                            </div>
                                        </div>
                                    `;
                                    choicesHtml += choiceHtml;
                                }

                                var optionDistributionHtml = `
                                    <div class='row'  id='hidden-info-` + data.options[i].option_id +`'>
                                        <div class='col'>
                                            ` + data.options[i].vote_percent + `% Voted
                                            ` + choicesHtml + `
                                        </div>
                                    </div>
                                `;

                                // change HTML
                                if (percent <= 10) { 
                                    percentBar.animate({width: '10%'}, 1000, 'linear') // changing the progress bar, does not dip below 10% width.
                                } else {
                                    percentBar.animate({width: '' + data.options[i].vote_percent + '%'}, 1000, 'linear') // changing the progress bar
                                }
                                if (data.options[i].option_id == data.voted_for_option_id) { // if this option was the one that the user has voted, not needed in the other 'change specific case' outcome.
                                    percentBar.css( 'background-color', '#1eff4b' ); // green for selected option
                                } else {
                                    percentBar.css( 'background-color', '#c3c3c3' ); // grey for non-selected option
                                }
                                optionButton.data('hidden-info', optionDistributionHtml); // updates the popup
                                optionCountElement.text(optionCount); // updates the counter
                            }
                        }
                        else { // first vote for this poll
                            // recreate the look of the poll message, to graded version.
                            var optionsHtml = ''
                            for (let i = 0; i < data.option_count; i++) {
                                var choicesHtml = ''
                                if (data.options[i].vote_percent <= 10) {
                                    var votePercentDisplay = 10;
                                } else {
                                    var votePercentDisplay = data.options[i].vote_percent;
                                }
                                for (let w = 0; w < data.options[i].amount_of_votes; w++) {
                                    var choiceHtml = `
                                        <div class='row'>
                                            <div class='col'>
                                                <i class='bi bi-arrow-right-short'></i>` + data.options[i].voters[w].voter + `
                                            </div>
                                        </div>
                                    `;
                                    choicesHtml += choiceHtml;
                                }
                                if (data.poll_sender === data.voter) { // if you have voted in your own poll
                                    if (data.options[i].option_id == data.voted_for_option_id) { // you clicked this option
                                        var optionHtml = `
                                            <div id="option-` + data.options[i].option_id +`">
                                                <p class="m-0 text-start" id="option-` + data.options[i].option_id +`-text" style="color: rgb(255, 255, 255);">` + data.options[i].option_name + `</p>
                                                <div id="option-disribution-` + data.options[i].option_id +`" class="progress" role="progressbar" aria-label="Option: ` + data.options[i].option_name + `" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                    <div class="progress-bar poll-progress-bar" id="percent-bar-` + data.options[i].option_id +`" style="width: ` + votePercentDisplay + `%; background-color: #1eff4b;" data-option-id="` + data.options[i].option_id +`">
                                                        <button type="button" class="m-0 p-0 btn poll-option" id="poll-option-` + data.options[i].option_id +`" data-option-id="` + data.options[i].option_id +`"  data-hidden-info="<div class='row' id='hidden-info-` + data.options[i].option_id +`'><div class='col'>` + data.options[i].vote_percent + `% Voted` + choicesHtml + `</div></div>">
                                                            <p class="m-0 text-start ps-2" id="option-` + data.options[i].option_id +`-count" style="color: rgb(0, 0, 0);">` + data.options[i].amount_of_votes + `</p>
                                                        </button>
                                                    </div>
                                                </div>
                                                <br>
                                            </div>
                                        `;
                                    } else { // you did not click this option
                                        var optionHtml = `
                                            <div id="option-` + data.options[i].option_id +`">
                                                <p class="m-0 text-start" id="option-` + data.options[i].option_id +`-text" style="color: rgb(255, 255, 255);">` + data.options[i].option_name + `</p>
                                                <div id="option-disribution-` + data.options[i].option_id +`" class="progress" role="progressbar" aria-label="Option: ` + data.options[i].option_name + `" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                    <div class="progress-bar poll-progress-bar" id="percent-bar-` + data.options[i].option_id +`" style="width: ` + votePercentDisplay + `%; background-color: #c3c3c3;" data-option-id="` + data.options[i].option_id +`">
                                                        <button type="button" class="m-0 p-0 btn poll-option" id="poll-option-` + data.options[i].option_id +`" data-option-id="` + data.options[i].option_id +`"  data-hidden-info="<div class='row' id='hidden-info-` + data.options[i].option_id +`'><div class='col'>` + data.options[i].vote_percent + `% Voted` + choicesHtml + `</div></div>">
                                                            <p class="m-0 text-start ps-2" id="option-` + data.options[i].option_id +`-count" style="color: rgb(0, 0, 0);">` + data.options[i].amount_of_votes + `</p>
                                                        </button>
                                                    </div>
                                                </div>
                                                <br>
                                            </div>
                                        `;
                                    }
                                } else { // votiong on someone else's poll
                                    if (data.options[i].option_id == data.voted_for_option_id) { // you clicked this option
                                        var optionHtml = `
                                            <div id="option-` + data.options[i].option_id +`">
                                                <p class="m-0 text-start" id="option-` + data.options[i].option_id +`-text" style="color: rgb(0, 0, 0);">` + data.options[i].option_name + `</p>
                                                <div id="option-disribution-` + data.options[i].option_id +`" class="progress" role="progressbar" aria-label="Option: ` + data.options[i].option_name + `" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                    <div class="progress-bar poll-progress-bar" id="percent-bar-` + data.options[i].option_id +`" style="width: ` + votePercentDisplay + `%; background-color: #1eff4b;" data-option-id="` + data.options[i].option_id +`">
                                                        <button type="button" class="m-0 p-0 btn poll-option" id="poll-option-` + data.options[i].option_id +`" data-option-id="` + data.options[i].option_id +`"  data-hidden-info="<div class='row' id='hidden-info-` + data.options[i].option_id +`'><div class='col'>` + data.options[i].vote_percent + `% Voted` + choicesHtml + `</div></div>">
                                                            <p class="m-0 text-start ps-2" id="option-` + data.options[i].option_id +`-count" style="color: rgb(0, 0, 0);">` + data.options[i].amount_of_votes + `</p>
                                                        </button>
                                                    </div>
                                                </div>
                                                <br>
                                            </div>
                                        `;
                                    } else { // you did not click this option
                                        var optionHtml = `
                                            <div id="option-` + data.options[i].option_id +`">
                                                <p class="m-0 text-start" id="option-` + data.options[i].option_id +`-text" style="color: rgb(0, 0, 0);">` + data.options[i].option_name + `</p>
                                                <div id="option-disribution-` + data.options[i].option_id +`" class="progress" role="progressbar" aria-label="Option: ` + data.options[i].option_name + `" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                    <div class="progress-bar poll-progress-bar" id="percent-bar-` + data.options[i].option_id +`" style="width: ` + votePercentDisplay + `%; background-color: #c3c3c3;" data-option-id="` + data.options[i].option_id +`">
                                                        <button type="button" class="m-0 p-0 btn poll-option" id="poll-option-` + data.options[i].option_id +`" data-option-id="` + data.options[i].option_id +`"  data-hidden-info="<div class='row' id='hidden-info-` + data.options[i].option_id +`'><div class='col'>` + data.options[i].vote_percent + `% Voted` + choicesHtml + `</div></div>">
                                                            <p class="m-0 text-start ps-2" id="option-` + data.options[i].option_id +`-count" style="color: rgb(0, 0, 0);">` + data.options[i].amount_of_votes + `</p>
                                                        </button>
                                                    </div>
                                                </div>
                                                <br>
                                            </div>
                                        `;
                                    }
                                }
                                optionsHtml += optionHtml
                            }
                            var pollHtml = `
                                <p class="small text-center">Poll</p>
                                <p id="poll-title-` + data.poll_id + `">` + data.poll_title + `</p>
                                ` + optionsHtml + `
                            `;
                            $('#poll-message-' + data.poll_id).html(pollHtml); // replace the inner html with the graded version of the poll
                            $('#poll-message-' + data.poll_id).attr('data-graded-poll', true);
                        }
                    } 
                    else { // if someone else made the vote
                        if ($('#poll-message-' + data.poll_id).data('graded-poll')) { // if we have already voted beforehand
                            // change specific things
                            // get relevant HTML elements, change them.
                            for (let i = 0; i < data.option_count; i++) {
                                // getting relevant HTML elements
                                var percentBar = $('#percent-bar-' + data.options[i].option_id);
                                var optionButton = $('#poll-option-' + data.options[i].option_id);
                                var optionCountElement = $('#option-' + data.options[i].option_id + '-count' );
                                
                                // store new information into variables
                                var percent = data.options[i].vote_percent;
                                var optionCount = data.options[i].amount_of_votes;
                                var choicesHtml = '';
                                for (let q = 0; q < data.options[i].amount_of_votes; q++) {
                                    var choiceHtml = `
                                        <div class='row'>
                                            <div class='col'>
                                                <i class='bi bi-arrow-right-short'></i>` + data.options[i].voters[q].voter + `
                                            </div>
                                        </div>
                                    `;
                                    choicesHtml += choiceHtml;
                                }

                                var optionDistributionHtml = `
                                    <div class='row' id='hidden-info-` + data.options[i].option_id +`'>
                                        <div class='col'>
                                            ` + data.options[i].vote_percent + `% Voted
                                            ` + choicesHtml + `
                                        </div>
                                    </div>
                                `;

                                // change HTML
                                if (percent <= 10) { 
                                    percentBar.animate({width: '10%'}, 1000, 'linear') // changing the progress bar, does not dip below 10% width.
                                } else {
                                    percentBar.animate({width: '' + data.options[i].vote_percent + '%'}, 1000, 'linear') // changing the progress bar
                                }
                                optionButton.data('hidden-info', optionDistributionHtml); // updates the popup
                                optionCountElement.text(optionCount); // updates the counter
                            }
                        }
                        else { // if we haven't interacted with this poll before
                            // do nothing
                            console.log('nothing happend.')
                        }
                    }
                } 
            }

            eventSocket.onclose = function (e) {
                console.error('WebSocket closed unexpectedly:', e);
                setTimeout(connectEventSocket, reconnectionTime);
            }

            eventSocket.onerror = function (e) {
                console.error('WebSocket encountered error:', e);
            }
        }

        function connectNotificationSocket () {
            notificationSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/brordcast-message/'
            );
            notificationSocket.onopen = function(e) {
                console.log('connected:', e )
            };

            notificationSocket.onmessage = function(e) {
                console.log('got a notification')
                const data = JSON.parse(e.data);
                if (data.source_name !== '{{room.name}}') { // if the notifiation come fron the chat room already accessing.
                    console.log('different room')
                    if (data.receiver === '{{username}}') {
                        console.log('correct user')
                        $('#inbox').append(data.html_notification_popup); // adds HTML to the inbox div, which stores notification toasts
                        $('#notification-inbox').prepend(data.stored_html_notification); // adds HTML to the notification div that houses the notifications in the off-canvas
                        
                        // Update notification count
                        var notificationCounter = $('#notification-counter');
                        var newCount = parseInt(notificationCounter.text()) || 0;
                        notificationCounter.text(newCount + 1).show();
                        
                        if ($('#bell-icon').hasClass('bi-bell')) { // if the bell looks like it has 0 notifications
                            $('#bell-icon').removeClass('bi-bell');
                            $('#bell-icon').addClass('bi-bell-fill');
                        }

                        var notificationElement = document.getElementById('popup-notification-' + data.notification_id); // gets the newly created popup notification toast

                        if (notificationElement) {
                            var notification = new bootstrap.Toast(notificationElement); // creates a bootstrap toast
                            // Show the toast
                            notification.show();
                        } else {
                            console.error('Notification element not found:', 'notification-' + data.notification_id);
                        }

                        // Attach event handlers to the newly added notification
                        attachNotificationEventHandlers(data.notification_id, data.receiver);
                    }
                }
                
                // if yes, mute the notification.
                // if no, display the notification.
            };

            notificationSocket.onerror = function(e) {
                console.error('WebSocket encountered an error:', e);
            };

            notificationSocket.onclose = function(e) {
                console.error('WebSocket closed unexpectedly:', e);
                setTimeout(connectNotificationSocket, reconnectionTime);

            };
        }
        
        function attachNotificationEventHandlers(notificationId, receiver) { 
            $(`#close-notification-${notificationId}`).click(function() {
                $.ajax({
                    type: 'POST',
                    url: '/universal/remove-notification/',
                    data: {
                        'receiver': receiver,
                        'type': 'notification-id',
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'notification_id': notificationId,
                    },
                    success: function(response) {
                        console.log(response.message);
                        var notification = $(`#stored-notification-${notificationId}`);
                        notification.remove();
                        var notificationCounter = $('#notification-counter');
                        var newCount = parseInt(notificationCounter.text()) - 1;

                        if (newCount <= 0) {
                            notificationCounter.text('').hide();
                            $('#bell-icon').removeClass('bi-bell-fill').addClass('bi-bell');
                        } else {
                            notificationCounter.text(newCount);
                        }
                    }
                });
            });

            $(`#read-notification-${notificationId}`).click(function() {
                $.ajax({
                    type: 'POST',
                    url: '/universal/remove-notification/',
                    data: {
                        'receiver': receiver,
                        'type': 'notification-id',
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'notification_id': notificationId,
                    },
                    success: function(response) {
                        console.log(response.message);
                        var domain = window.location.origin;
                        var path = `/chat/${response.notification_chatroom_name}/${response.notification_chatroom_id}`
                        window.location.href = domain + path
                    }
                });
            });
        }
        $(document).ready(function() {
            if ('{{ notification_count }}' == '0') {
                var notification_counter = $('#notification-counter');
                notification_counter.text('').hide();
                var notification_bell = $('#bell-icon');
                notification_bell.removeClass('bi-bell-fill').addClass('bi-bell');
            } else {
                var notificationCounter = $('#notification-counter');
                notificationCounter.text('{{ notification_count }}').show();
                $('#bell-icon').removeClass('bi-bell').addClass('bi-bell-fill');
            }
        });
        connectMessageSocket();
        connectEventSocket();
        connectNotificationSocket();
    </script>
    <script>
        $(document).ready(function () {
            $('#message').keydown(function (e) {
                if (e.keyCode == 13 ) {
                    // split this into 3 cases: text, image, and video messages
                    let isReply // initalization of the isReply variable
                    // for text
                    if ($('#is-text').val() === 'true') {
                        var message = $('#message').val() // get the message
                        if ($('#is-reply').val() === 'true') { // if the hidden input containing the state of replying is true
                            isReply = 'true' 
                            replyMessageId = $('#reply-information-holder').data('message-id'); // get the message ID of the message that this user is replying to.
                        }
                        else {
                            isReply = 'false'
                            replyMessageId = null
                        }
                        if (message != '') {
                            $.ajax({
                                type: 'POST',
                                url: '/chat/message-sent-text/',
                                data: {
                                    'chat-room-name': '{{room.name}}',
                                    'chat-room-id': '{{room.id}}',
                                    'text-message': message,
                                    'is-reply': isReply,
                                    'replying-to-id': replyMessageId,
                                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                                },
                                success: function(response) {
                                    $('#message').val('');
                                    if ($('#reply-prompt')) { // remove reply prompt if the user was replying
                                        $('#reply-prompt').remove();
                                        $('#is-reply').val('false');
                                    }
                                    notificationSocket.send(JSON.stringify({
                                        'notification_ids': response.notification_ids,
                                    }));
                                    if (response.is_reply === 'true') { // Send over specific data for the case of a reply.
                                        var replyId = response.reply_id;
                                        messageSocket.send(JSON.stringify({
                                            'text': message,
                                            'message_type': 'text',
                                            'message_id': response.message_id,
                                            'is_reply': response.is_reply,
                                            'reply_id': response.reply_id,
                                        }));
                                    } else {
                                        messageSocket.send(JSON.stringify({
                                            'text': message,
                                            'message_type': 'text',
                                            'message_id': response.message_id,
                                            'is_reply': response.is_reply,
                                        }));
                                    }
                                }
                            })
                        }
                    } 
                    else if ($('#is-image').val() === 'true') { // for image
                        var imageInput = $('#image-file-field')[0];
                        var image = imageInput.files[0];
                        console.log(image)
                        if ($('#is-reply').val() === 'true') { // if the hidden input containing the state of replying is true
                            isReply = 'true' 
                            replyMessageId = $('#reply-information-holder').data('message-id'); // get the message ID of the message that this user is replying to.
                        }
                        else {
                            isReply = 'false'
                            replyMessageId = null
                        }
                        if (image) {
                            var imageFormData = new FormData();

                            imageFormData.append('image', image);
                            imageFormData.append('is_reply', isReply);
                            imageFormData.append('replying_to_id', replyMessageId);
                            imageFormData.append('chat_room_id', '{{room.id}}');
                            imageFormData.append('sender', '{{username}}');
                            imageFormData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                            $.ajax({
                                type: 'POST',
                                url: '/chat/message-sent-image/',
                                processData: false, // Important!
                                contentType: false, // Important!
                                data: imageFormData,
                                success: function(response) {
                                    console.log('message sent and saved!');

                                    // CSS changes in the event of a message being sent
                                    if ($('#reply-prompt')) { // remove reply prompt if the user was replying
                                        $('#reply-prompt').remove();
                                        $('#image-prompt').remove();
                                        $('#multi-input-wrapper').remove();
                                        $('#is-reply').val('false');
                                        $('#is-image').val('false');
                                        $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                        $('#is-text').val('true');
                                    } else {
                                        $('#image-prompt').remove();
                                        $('#is-image').val('false');
                                        $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                        $('#is-text').val('true');
                                    }

                                    // Notification socket
                                    notificationSocket.send(JSON.stringify({
                                        'notification_ids': response.notification_ids,
                                    }));

                                    // Message sockets
                                    if (response.is_reply === 'true') {
                                        messageSocket.send(JSON.stringify({
                                            'message_type': 'image',
                                            'message_id': response.message_id,
                                            'is_reply': response.is_reply,
                                            'reply_id': response.reply_id,
                                        }))
                                    } else {
                                        messageSocket.send(JSON.stringify({
                                            'message_type': 'image',
                                            'message_id': response.message_id,
                                            'is_reply': response.is_reply,
                                        }))
                                    }
                                }
                            })
                        } else {
                            console.log('invalid image');
                        }
                    }
                    else if ($('#is-video').val() === 'true') { // for video
                        var videoInput = $('#video-file-field')[0];
                        var video = videoInput.files[0];
                        console.log(video)
                        if ($('#is-reply').val() === 'true') { // if the hidden input containing the state of replying is true
                            isReply = 'true' 
                            replyMessageId = $('#reply-information-holder').data('message-id'); // get the message ID of the message that this user is replying to.
                        }
                        else {
                            isReply = 'false'
                            replyMessageId = null
                        }
                        if (video) {
                            var videoFormData = new FormData();

                            videoFormData.append('video', video);
                            videoFormData.append('is_reply', isReply);
                            videoFormData.append('replying_to_id', replyMessageId);
                            videoFormData.append('chat_room_id', '{{room.id}}');
                            videoFormData.append('sender', '{{username}}');
                            videoFormData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                            $.ajax({
                                type: 'POST',
                                url: '/chat/message-sent-video/',
                                processData: false, // Important!
                                contentType: false, // Important!
                                data: videoFormData,
                                success: function(response) {
                                    console.log('message sent and saved!');

                                    // CSS changes in the event of a message being sent
                                    if ($('#reply-prompt')) { // remove reply prompt if the user was replying
                                        $('#reply-prompt').remove();
                                        $('#video-prompt').remove();
                                        $('#multi-input-wrapper').remove();
                                        $('#is-reply').val('false');
                                        $('#is-video').val('false');
                                        $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                        $('#is-text').val('true');
                                    } else {
                                        $('#video-prompt').remove();
                                        $('#is-video').val('false');
                                        $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                        $('#is-text').val('true');
                                    }

                                    // Notification socket
                                    notificationSocket.send(JSON.stringify({
                                        'notification_ids': response.notification_ids,
                                    }));

                                    // Message sockets
                                    if (response.is_reply === 'true') {
                                        messageSocket.send(JSON.stringify({
                                            'message_type': 'video',
                                            'message_id': response.message_id,
                                            'is_reply': response.is_reply,
                                            'reply_id': response.reply_id,
                                        }))
                                    } else {
                                        messageSocket.send(JSON.stringify({
                                            'message_type': 'video',
                                            'message_id': response.message_id,
                                            'is_reply': response.is_reply,
                                        }))
                                    }
                                }
                            })
                        } else {
                            console.log('invalid video');
                        }
                    }
                }
            })
            $('#send').click(function () {
                // split this into 3 cases: text, image, and video messages
                let isReply // initalization of the isReply variable
                // for text
                if ($('#is-text').val() === 'true') {
                    var message = $('#message').val() // get the message
                    if ($('#is-reply').val() === 'true') { // if the hidden input containing the state of replying is true
                        isReply = 'true' 
                        replyMessageId = $('#reply-information-holder').data('message-id'); // get the message ID of the message that this user is replying to.
                    }
                    else {
                        isReply = 'false'
                        replyMessageId = null
                    }
                    if (message != '') {
                        $.ajax({
                            type: 'POST',
                            url: '/chat/message-sent-text/',
                            data: {
                                'chat-room-name': '{{room.name}}',
                                'chat-room-id': '{{room.id}}',
                                'text-message': message,
                                'is-reply': isReply,
                                'replying-to-id': replyMessageId,
                                'csrfmiddlewaretoken': '{{ csrf_token }}',
                            },
                            success: function(response) {
                                console.log(response.is_reply)
                                $('#message').val('');
                                if ($('#reply-prompt')) { // remove reply prompt if the user was replying
                                    $('#reply-prompt').remove();
                                    $('#is-reply').val('false');
                                }
                                notificationSocket.send(JSON.stringify({
                                    'notification_ids': response.notification_ids,
                                }));
                                if (response.is_reply === 'true') { // Send over specific data for the case of a reply.
                                    var replyId = response.reply_id;
                                    messageSocket.send(JSON.stringify({
                                        'text': message,
                                        'message_type': 'text',
                                        'action': 'create_message',
                                        'message_id': response.message_id,
                                        'is_reply': response.is_reply,
                                        'is_editing': 'false',
                                        'reply_id': response.reply_id,
                                    }));
                                } else {
                                    messageSocket.send(JSON.stringify({
                                        'text': message,
                                        'message_type': 'text',
                                        'action': 'create_message',
                                        'message_id': response.message_id,
                                        'is_reply': response.is_reply,
                                        'is_editing': 'false',
                                    }));
                                }
                            }
                        })
                    }
                } 
                else if ($('#is-image').val() === 'true') { // for image
                    var imageInput = $('#image-file-field')[0];
                    var image = imageInput.files[0];
                    console.log(image)
                    if ($('#is-reply').val() === 'true') { // if the hidden input containing the state of replying is true
                        isReply = 'true' 
                        replyMessageId = $('#reply-information-holder').data('message-id'); // get the message ID of the message that this user is replying to.
                    }
                    else {
                        isReply = 'false'
                        replyMessageId = null
                    }
                    if (image) {
                        // special data passing for images
                        var imageFormData = new FormData();

                        imageFormData.append('image', image);
                        imageFormData.append('is_reply', isReply);
                        imageFormData.append('replying_to_id', replyMessageId);
                        imageFormData.append('chat_room_id', '{{room.id}}');
                        imageFormData.append('sender', '{{username}}');
                        imageFormData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                        $.ajax({
                            type: 'POST',
                            url: '/chat/message-sent-image/',
                            processData: false, // Important!
                            contentType: false, // Important!
                            data: imageFormData,
                            success: function(response) {
                                console.log('message sent and saved!');

                                // CSS changes in the event of a message being sent
                                if ($('#reply-prompt')) { // remove reply prompt if the user was replying
                                    $('#reply-prompt').remove();
                                    $('#image-prompt').remove();
                                    $('#multi-input-wrapper').remove();
                                    $('#is-reply').val('false');
                                    $('#is-image').val('false');
                                    $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                    $('#is-text').val('true');
                                } else {
                                    $('#image-prompt').remove();
                                    $('#is-image').val('false');
                                    $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                    $('#is-text').val('true');
                                }

                                // Notification socket
                                notificationSocket.send(JSON.stringify({
                                    'notification_ids': response.notification_ids,
                                }));

                                // Message sockets
                                if (response.is_reply === 'true') {
                                    messageSocket.send(JSON.stringify({
                                        'message_type': 'image',
                                        'action': 'create_message',
                                        'message_id': response.message_id,
                                        'is_reply': response.is_reply,
                                        'is_editing': 'false',
                                        'reply_id': response.reply_id,
                                    }))
                                } else {
                                    messageSocket.send(JSON.stringify({
                                        'message_type': 'image',
                                        'action': 'create_message',
                                        'message_id': response.message_id,
                                        'is_reply': response.is_reply,
                                        'is_editing': 'false',
                                    }))
                                }
                            }
                        })
                    } else {
                        console.log('invalid image');
                    }
                }
                else if ($('#is-video').val() === 'true') { // for video
                    var videoInput = $('#video-file-field')[0];
                    var video = videoInput.files[0];
                    console.log(video)
                    if ($('#is-reply').val() === 'true') { // if the hidden input containing the state of replying is true
                        isReply = 'true' 
                        replyMessageId = $('#reply-information-holder').data('message-id'); // get the message ID of the message that this user is replying to.
                    }
                    else {
                        isReply = 'false'
                        replyMessageId = null
                    }
                    if (video) {
                        var videoFormData = new FormData();

                        videoFormData.append('video', video);
                        videoFormData.append('is_reply', isReply);
                        videoFormData.append('replying_to_id', replyMessageId);
                        videoFormData.append('chat_room_id', '{{room.id}}');
                        videoFormData.append('sender', '{{username}}');
                        videoFormData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                        $.ajax({
                            type: 'POST',
                            url: '/chat/message-sent-video/',
                            processData: false, // Important!
                            contentType: false, // Important!
                            data: videoFormData,
                            success: function(response) {
                                console.log('message sent and saved!');

                                // CSS changes in the event of a message being sent
                                if ($('#reply-prompt')) { // remove reply prompt if the user was replying
                                    $('#reply-prompt').remove();
                                    $('#video-prompt').remove();
                                    $('#multi-input-wrapper').remove();
                                    $('#is-reply').val('false');
                                    $('#is-video').val('false');
                                    $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                    $('#is-text').val('true');
                                } else {
                                    $('#video-prompt').remove();
                                    $('#is-video').val('false');
                                    $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                    $('#is-text').val('true');
                                }

                                // Notification socket
                                notificationSocket.send(JSON.stringify({
                                    'notification_ids': response.notification_ids,
                                }));

                                // Message sockets
                                if (response.is_reply === 'true') {
                                    messageSocket.send(JSON.stringify({
                                        'message_type': 'video',
                                        'action': 'create_message',
                                        'message_id': response.message_id,
                                        'is_reply': response.is_reply,
                                        'is_editing': 'false',
                                        'reply_id': replyId,
                                    }))
                                } else {
                                    messageSocket.send(JSON.stringify({
                                        'message_type': 'video',
                                        'action': 'create_message',
                                        'message_id': response.message_id,
                                        'is_reply': response.is_reply,
                                        'is_editing': 'false',
                                    }))
                                }
                            }
                        })
                    } else {
                        console.log('invalid video');
                    }
                }
            });
            $('#conversation-contents').on('click', '.reply', function () { // when the reply button is pressed
                // Get relevant data stored inside of the button's data attributes
                messageId = $(this).data('message-id');
                senderUsername = $(this).data('message-sender');
                message = $(this).data('message');
                setupReply(messageId, senderUsername, message); // call the setupReply function and pass useful information though.
            })
            $('#init-image').click(function () {
                const messageDiv = $('#message-div');
                const isText = $('#is-text');
                const isImage = $('#is-image');
                const isVideo = $('#is-video');
                const isVoice = $('#is-voice');
                const isReply = $('#is-reply');
                const messageTextBox = $('#message');
                const messageInputHtml = `<input type="text" id="message" class="form-control pb-3 p-4">`
                if (isImage.val() === 'false') {
                    if (isReply.val() === 'false') { // if false, display only the image prompt
                        if (isVideo.val() === 'true') {
                            $('#video-prompt').remove(); // can only do either an image or a video at once.
                            isVideo.val('false');
                        }
                        if (isVoice.val() === 'true') {
                            $('#voice-prompt').remove();
                            isVoice.val('false');
                        }
                        messageTextBox.remove(); // no text allowed as well
                        isText.val('false');
                        // image prompt
                        messageDiv.append(`
                            <div class="card mt-1" id="image-prompt" style="border: none;">
                                <div class="card-header pb-4" style="border-bottom: none;">
                                    <div class="row">
                                        <div class="col">
                                            <label for="image-file-field" class="form-label">Place image here</label>
                                            <input class="form-control" type="file" id="image-file-field">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `)
                        isImage.val('true'); // set the hidden element to true
                        $('html, body').animate({ scrollTop: $(document).height() }, 'fast'); // animation for better GUI
                    } else { // display both the image prompt and the reply prompt
                        if (isVideo.val() === 'true') {
                            $('#video-prompt').remove();
                            isVideo.val('false');
                        }
                        if (isVoice.val() === 'true') {
                            $('#voice-prompt').remove();
                            isVoice.val('false');
                        }

                        messageTextBox.remove();
                        isText.val('false');
                        var replyInput = $('#reply-prompt').detach();
                        var replyInputHtml = replyInput.prop('outerHTML');
                        var imageInputHtml = `
                            <div class="card mt-1" id="image-prompt" style="border: none;">
                                <div class="card-header pb-4" style="border-bottom: none;">
                                    <div class="row">
                                        <div class="col">
                                            <label for="image-file-field" class="form-label">Place image here</label>
                                            <input class="form-control" type="file" id="image-file-field">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `
                        // wrapper to nicely format both prompts
                        messageDiv.append(`
                            <div class="row" id='multi-input-wrapper'>
                                <div class="col-6">
                                    ` + replyInputHtml + `
                                </div>
                                <div class="col-6">
                                    ` + imageInputHtml + `
                                </div>
                            </div>
                        `)
                        isImage.val('true');
                        $('html, body').animate({ scrollTop: $(document).height() }, 'fast'); // animation for better GUI
                    }
                } else { // removal of the image prompt
                    if (isReply.val() === 'false') {
                        $('#image-prompt').remove();
                        messageDiv.append(messageInputHtml) // bring back the text box
                        isText.val('true'); 
                        isImage.val('false');
                    } else {
                        var replyInput = $('#reply-prompt').detach();
                        var replyInputHtml = replyInput.prop('outerHTML');
                        $('#multi-input-wrapper').remove();
                        $('#image-prompt').remove();
                        messageDiv.append(messageInputHtml)
                        isText.val('true');
                        messageDiv.append(replyInputHtml);
                        isImage.val('false');
                    }
                }
            })
            $('#init-video').click(function () {
                const messageDiv = $('#message-div');
                const isText = $('#is-text');
                const isImage = $('#is-image');
                const isVideo = $('#is-video');
                const isVoice = $('#is-voice');
                const isReply = $('#is-reply');
                const messageTextBox = $('#message');
                const messageInputHtml = `<input type="text" id="message" class="form-control pb-3 p-4">`
                if (isVideo.val() === 'false') {
                    if (isReply.val() === 'false') {
                        if (isImage.val() === 'true') {
                            $('#image-prompt').remove();
                            isImage.val('false');
                        }
                        if (isVoice.val() === 'true') {
                            $('#voice-prompt').remove();
                            isVoice.val('false');
                        }

                        messageTextBox.remove();
                        isText.val('false');
                        messageDiv.append(`
                            <div class="card mt-1" id="video-prompt" style="border: none;">
                                <div class="card-header pb-4" style="border-bottom: none;">
                                    <div class="row">
                                        <div class="col">
                                            <label for="video-file-field" class="form-label">Place video here</label>
                                            <input class="form-control" type="file" id="video-file-field">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `)
                        isVideo.val('true');
                        $('html, body').animate({ scrollTop: $(document).height() }, 'fast'); // animation for better GUI
                    } else {
                        if (isImage.val() === 'true') {
                            $('#image-prompt').remove();
                            isImage.val('false');
                        }
                        if (isVoice.val() === 'true') {
                            $('#voice-prompt').remove();
                            isVoice.val('false');
                        }

                        messageTextBox.remove();
                        isText.val('false');
                        var replyInput = $('#reply-prompt').detach();
                        var replyInputHtml = replyInput.prop('outerHTML');
                        var videoInputHtml = `
                            <div class="card mt-1" id="video-prompt" style="border: none;">
                                <div class="card-header pb-4" style="border-bottom: none;">
                                    <div class="row">
                                        <div class="col">
                                            <label for="video-file-field" class="form-label">Place video here</label>
                                            <input class="form-control" type="file" id="video-file-field">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `
                        messageDiv.append(`
                            <div class="row" id='multi-input-wrapper'>
                                <div class="col-6">
                                    ` + replyInputHtml + `
                                </div>
                                <div class="col-6">
                                    ` + videoInputHtml + `
                                </div>
                            </div>
                        `)
                        isVideo.val('true');
                        $('html, body').animate({ scrollTop: $(document).height() }, 'fast'); // animation for better GUI
                    }
                } else {
                    if (isReply.val() === 'false') {
                        $('#video-prompt').remove();
                        messageDiv.append(messageInputHtml);
                        isText.val('true');
                        isVideo.val('false');
                    } else {
                        var replyInput = $('#reply-prompt').detach();
                        var replyInputHtml = replyInput.prop('outerHTML');
                        $('#multi-input-wrapper').remove();
                        $('#video-prompt').remove();
                        messageDiv.append(messageInputHtml);
                        isText.val('true');
                        messageDiv.append(replyInputHtml);
                        isVideo.val('false');
                    }
                }
            })
            $('#init-voice').click(function () {
                const messageDiv = $('#message-div');
                const isText = $('#is-text');
                const isImage = $('#is-image');
                const isVideo = $('#is-video');
                const isVoice = $('#is-voice');
                const isReply = $('#is-reply');
                const messageTextBox = $('#message');
                const messageInputHtml = `<input type="text" id="message" class="form-control pb-3 p-4">`
                if (isVoice.val() === 'false') {
                    if (isReply.val() === 'false') {
                        if (isImage.val() === 'true') {
                            $('#image-prompt').remove();
                            isImage.val('false');
                        }
                        if (isVideo.val() === 'true') {
                            $('#video-prompt').remove();
                            isVideo.val('false');
                        }

                        messageTextBox.remove();
                        isText.val('false');
                        messageDiv.append(`
                            <div class="card mt-1" id="voice-prompt" style="border: none;">
                                <div class="card-header" style="border-bottom: none;">
                                    <div class="row">
                                        <div class="col d-flex justify-content-center">
                                            <p id="voice-prompt-text">Press the microphone to start recording voice or upload an audio file.</p>
                                        </div>
                                    </div>
                                    <div class="row" id="voice-control-pannel">
                                        <div class="col d-flex justify-content-center">
                                            <div id="recording-controls">
                                                <button class="btn request-recording" type="button"><i id="mic-icon" class="bi bi-mic"></i></button>
                                                <button type="button" class="btn upload-element" onclick="document.getElementById('audio-upload-field').click();"><i class="bi bi-upload"></i></button>
                                                <input type="file" class="audio-upload upload-element" id="audio-upload-field" style="display: none;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `)
                        isVoice.val('true');
                        $('html, body').animate({ scrollTop: $(document).height() }, 'fast'); // animation for better GUI
                    } else {
                        if (isImage.val() === 'true') {
                            $('#image-prompt').remove();
                            isImage.val('false');
                        }
                        if (isVideo.val() === 'true') {
                            $('#video-prompt').remove();
                            isVideo.val('false');
                        }

                        messageTextBox.remove();
                        isText.val('false');
                        var replyInput = $('#reply-prompt').detach();
                        var replyInputHtml = replyInput.prop('outerHTML');
                        var audioInputHtml = `
                            <div class="card mt-1" id="voice-prompt" style="border: none;">
                                <div class="card-header" style="border-bottom: none;">
                                    <div class="row">
                                        <div class="col d-flex justify-content-center">
                                            <p id="voice-prompt-text">Press the microphone to start recording voice or upload an audio file.</p>
                                        </div>
                                    </div>
                                    <div class="row" id="voice-control-pannel">
                                        <div class="col d-flex justify-content-center">
                                            <div id="recording-controls">
                                                <button class="btn request-recording" type="button"><i id="mic-icon" class="bi bi-mic"></i></button>
                                                <button type="button" class="btn upload-element" onclick="document.getElementById('audio-upload-field').click();"><i class="bi bi-upload"></i></button>
                                                <input type="file" class="audio-upload upload-element" id="audio-upload-field" style="display: none;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `
                        messageDiv.append(`
                            <div class="row" id='multi-input-wrapper'>
                                <div class="col-6">
                                    ` + replyInputHtml + `
                                </div>
                                <div class="col-6">
                                    ` + audioInputHtml + `
                                </div>
                            </div>
                        `)
                        isVoice.val('true');
                        $('html, body').animate({ scrollTop: $(document).height() }, 'fast'); // animation for better GUI
                    }
                } else {
                    if (isReply.val() === 'false') {
                        $('#voice-prompt').remove();
                        messageDiv.append(messageInputHtml);
                        isText.val('true');
                        isVoice.val('false');
                    } else {
                        var replyInput = $('#reply-prompt').detach();
                        var replyInputHtml = replyInput.prop('outerHTML');
                        $('#multi-input-wrapper').remove();
                        $('#voice-prompt').remove();
                        messageDiv.append(messageInputHtml);
                        isText.val('true');
                        messageDiv.append(replyInputHtml);
                        isVoice.val('false');
                    }
                }
            });
            // for the audio file upload
            $('#message-div').on('input', '.audio-upload', function (event) {
                var audioFile = event.target.files[0];
                if (audioFile) {
                    var audioURL = URL.createObjectURL(audioFile);
                    var audioHtml = `
                        <div class="d-inline-flex" id="recording-preview-controls">
                            <button type="button" class="btn confirm-recording"><i class="bi bi-check-lg"></i></button>
                            <button type="button" class="btn deny-recording"><i class="bi bi-x-lg"></i></button>
                            <audio src="${audioURL}" controls></audio>
                        </div>
                        <button class="btn request-recording" type="button"><i id="mic-icon" class="bi bi-mic"></i></button>
                        <button type="button" class="btn upload-element" onclick="document.getElementById('audio-upload-field').click();"><i class="bi bi-upload"></i></button>
                        <input type="file" class="audio-upload upload-element" id="audio-upload-field" style="display: none;">
                    `;
                    $('#recording-controls').html(audioHtml);
                    $('#voice-prompt-text').text('Audio message vaildated.');
                } else {
                    console.log('Error getting audio file.')
                }
            })
            $('#conversation-contents').on('input', '.edit-audio-upload', function (event) {
                var messageID = $(this).data('message-id');
                var audioFile = event.target.files[0];
                
                console.log(messageID)
                console.log(audioFile)
                if (audioFile) {
                    var audioURL = URL.createObjectURL(audioFile);
                    var audioHtml =`
                        <div class="card text-bg-success" style="width: 85%; border: none; opacity: 85%;">
                            <div class="card-header" style="border-bottom: none;">
                                <div class="row">
                                    <div class="col">
                                        <p class="small text-center" id="edit-voice-prompt-text">Upload successful.</p>
                                        <div class="d-flex justify-content-center">
                                            <audio class="edit-recording-preview-controls p-2" src="${audioURL}" controls></audio>
                                        </div>
                                        <div class="d-flex justify-content-center">
                                            <button type="button" class="btn edit-recording-preview-controls confirm-editing" data-message-id="${messageID}" data-type="audio"><i class="bi bi-check-lg" style="color: #ffffff;"></i></button>
                                            <button type="button" class="btn edit-recording-preview-controls deny-editing" data-message-id="${messageID}"><i class="bi bi-x-lg" style="color: #ffffff;"></i></button>
                                            <button class="btn edit-request-recording" type="button" data-message-id="${messageID}"><i id="edit-mic-icon" class="bi bi-mic" style="color: #ffffff;"></i></button>
                                            <button type="button" class="btn edit-upload-element" onclick="document.getElementById('edit-audio-upload-field').click();"><i class="bi bi-upload" style="color: #ffffff;"></i></button>
                                            <input type="file" class="edit-audio-upload edit-upload-element" data-message-id="${messageID}" id="edit-audio-upload-field" style="display: none;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    $('#message-body-container-' + messageID).html(audioHtml)
                }

                // display new data.
            })

            // Permission logic for voice messages
            var awaitingMicrophoneModal = new bootstrap.Modal(document.getElementById('awaiting-microphone-modal'), {
                keyboard: false
            });
            let audioRecorder;
            let audioStream;
            let blob;

            let recordedChunks = [];

            $('#message-div').on('click', '.request-recording, .recording-active, .confirm-recording, .deny-recording', function () {
                // Check if the button has the class 'request-recording' to start recording
                if ($(this).hasClass('request-recording')) {
                    awaitingMicrophoneModal.show();

                    setTimeout(function () {
                        navigator.mediaDevices.getUserMedia({ audio: true })
                            .then(function(stream) {
                                awaitingMicrophoneModal.hide();
                                audioStream = stream
                                console.log('Microphone access granted.');

                                // Change the look of the message div to tell the user that it has begun recording
                                if ($('#recording-preview-controls')) {
                                    $('#recording-preview-controls').remove();
                                    $('.upload-element').remove();
                                }
                                
                                $('.upload-element').remove();
                                $('#mic-icon').removeClass('bi-mic').addClass('bi-mic-fill');
                                $('#mic-icon').css('color', '#dc3545');
                                $('#voice-prompt-text').text('Recording...');
                    
                                audioRecorder = new MediaRecorder(stream);

                                // Logic for sending recorded audio and storing it  
                                audioRecorder.ondataavailable = function(event) {
                                    if (event.data.size > 0) {
                                        recordedChunks.push(event.data);
                                    }
                                };

                                // When recording stops, store the audio in an audio tag
                                audioRecorder.onstop = function() {
                                    blob = new Blob(recordedChunks, { type: 'audio/webm' });
                                    const audioURL = URL.createObjectURL(blob);
                                    var audioHtml;
                
                                    audioHtml = `
                                        <div class="d-inline-flex" id="recording-preview-controls">
                                            <button type="button" class="btn confirm-recording"><i class="bi bi-check-lg"></i></button>
                                            <button type="button" class="btn deny-recording"><i class="bi bi-x-lg"></i></button>
                                            <audio src="${audioURL}" controls></audio>
                                        </div>
                                        <button class="btn request-recording" type="button"><i id="mic-icon" class="bi bi-mic"></i></button>
                                        <button type="button" class="btn upload-element" onclick="document.getElementById('audio-upload-field').click();"><i class="bi bi-upload"></i></button>
                                        <input type="file" class="audio-upload upload-element" id="audio-upload-field" style="display: none;">
                                    `;
                                    $('#recording-controls').html(audioHtml);
                                    $('#voice-prompt-text').text('Audio recording successful.');
                                    
                                    recordedChunks = [];
                                    audioStream.getTracks().forEach(track => track.stop());
                                    audioStream = null; // Clear the stream reference
                                    console.log('Microphone access stopped.');
                                };
                                
                                // Start recording and change button state
                                audioRecorder.start();
                                $('.request-recording').removeClass('request-recording').addClass('recording-active');
                                
                            })
                            .catch(function(err) {
                                console.log('Microphone access denied: ' + err.message);

                                awaitingMicrophoneModal.hide();

                                setTimeout(function () {
                                    var deniedMicrophoneModal = new bootstrap.Modal(document.getElementById('denied-microphone-access'), {
                                        keyboard: false
                                    });
                                    deniedMicrophoneModal.show();
                                }, 1000);  // Adjust the delay if needed
                            });
                    }, 1000)
                }
                // Check if the button has the class 'recording-active' to stop recording
                else if ($(this).hasClass('recording-active')) {
                    if (audioRecorder && audioRecorder.state === 'recording') {
                        audioRecorder.stop();
                    }
                }
                else if ($(this).hasClass('confirm-recording')) {
                    var isReply;
                    var replyMessageId;
                    let audioData = new FormData();
                
                    if ($('#is-reply').val() === 'true') { // if the hidden input containing the state of replying is true
                        isReply = 'true' 
                        replyMessageId = $('#reply-information-holder').data('message-id'); // get the message ID of the message that this user is replying to.
                    }
                    else {
                        isReply = 'false'
                        replyMessageId = null
                    }

                    audioData.append('audio', blob);
                    audioData.append('chatroom_id', '{{room.id}}');
                    audioData.append('is_reply', isReply);
                    audioData.append('replying_to_id', replyMessageId)
                    audioData.append('csrfmiddlewaretoken', '{{csrf_token}}')

                    $.ajax({
                        type: 'POST',
                        url: '/chat/message-sent-audio/',
                        processData: false,
                        contentType: false,
                        data: audioData,
                        success: function (response) {
                            console.log('message sent and saved.')

                            // Removal of voice prompt and recreation of the text input field.
                            $('#voice-prompt').remove();
                            $('#is-voice').val('false');
                            $('#message-div').append('<input type="text" id="message" class="form-control pb-3 p-4">')
                            $('#is-text').val('true');

                            if ($('#is-reply').val() === 'true') { // if the message was a reply message
                                $('#reply-prompt').remove();
                                $('#is-reply').val('false');
                            }

                            // Notification socket
                            notificationSocket.send(JSON.stringify({
                                'notification_ids': response.notification_ids,
                            }));

                            // Message sockets
                            if (response.is_reply === 'true') {
                                messageSocket.send(JSON.stringify({
                                    'message_type': 'audio',
                                    'action': 'create_message',
                                    'message_id': response.message_id,
                                    'is_reply': response.is_reply,
                                    'is_editing': 'false',
                                    'reply_id': response.reply_id,
                                }))
                            } else {
                                messageSocket.send(JSON.stringify({
                                    'message_type': 'audio',
                                    'action': 'create_message',
                                    'message_id': response.message_id,
                                    'is_reply': response.is_reply,
                                    'is_editing': 'false',
                                }))
                            }
                        }
                    })
                }
                else if ($(this).hasClass('deny-recording')) {
                    $('#recording-preview-controls').remove();
                    $('#voice-prompt-text').text('Press the microphone to start recroding voice or upload an audio file.');
                }
            });
            // for editing audio messages
            $('#conversation-contents').on('click', '.edit-request-recording, .edit-recording-active, .confirm-audio-editing', function () {
                // Check if the button has the class 'request-recording' to start recording
                var messageID = $(this).data('message-id');

                console.log('clicked')
                if ($(this).hasClass('edit-request-recording')) {
                    awaitingMicrophoneModal.show();

                    setTimeout(function () {
                        navigator.mediaDevices.getUserMedia({ audio: true })
                            .then(function(stream) {
                                awaitingMicrophoneModal.hide();
                                audioStream = stream
                                console.log('Microphone access granted.');

                                // Change the look of the message div to tell the user that it has begun recording
                                if ($('.edit-recording-preview-controls')) {
                                    $('.edit-recording-preview-controls').remove();
                                    $('.edit-upload-element').remove();
                                }
                                
                                $('.edit.upload-element').remove();
                                $('#edit-mic-icon').removeClass('bi-mic').addClass('bi-mic-fill');
                                $('#edit-mic-icon').css('color', '#dc3545');
                                $('#edit-voice-prompt-text').text('Recording...');
                                
                                audioRecorder = new MediaRecorder(stream);

                                // Logic for sending recorded audio and storing it  
                                audioRecorder.ondataavailable = function(event) {
                                    if (event.data.size > 0) {
                                        recordedChunks.push(event.data);
                                    }
                                };

                                // When recording stops, store the audio in an audio tag
                                audioRecorder.onstop = function() {
                                    blob = new Blob(recordedChunks, { type: 'audio/webm' });
                                    const audioURL = URL.createObjectURL(blob);
                                    var audioHtml;
                                    
                                    audioHtml = `
                                        <audio class="edit-recording-preview-controls p-2" src="${audioURL}" controls></audio>
                                        <div class="d-flex justify-content-center">
                                            <button type="button" class="btn edit-recording-preview-controls confirm-audio-editing" data-message-id="${messageID}" data-type="audio"><i class="bi bi-check-lg" style="color: #ffffff;"></i></button>
                                            <button type="button" class="btn edit-recording-preview-controls deny-editing" data-message-id="${messageID}"><i class="bi bi-x-lg" style="color: #ffffff;"></i></button>
                                            <button class="btn edit-request-recording" type="button" data-message-id="${messageID}"><i id="edit-mic-icon" class="bi bi-mic" style="color: #ffffff;"></i></button>
                                            <button type="button" class="btn edit-upload-element" onclick="document.getElementById('edit-audio-upload-field').click();"><i class="bi bi-upload" style="color: #ffffff;"></i></button>
                                            <input type="file" class="edit-audio-upload edit-upload-element" data-message-id="${messageID}" id="edit-audio-upload-field" style="display: none;">
                                        </div>
                                    `; 
                                    $('#edit-recording-controls').html(audioHtml);
                                    $('#edit-voice-prompt-text').text('Audio recording successful.');
                                    
                                    recordedChunks = [];
                                    audioStream.getTracks().forEach(track => track.stop());
                                    audioStream = null; // Clear the stream reference
                                    console.log('Microphone access stopped.');
                                };
                                
                                // Start recording and change button state
                                audioRecorder.start();
                                $('.edit-request-recording').removeClass('edit-request-recording').addClass('edit-recording-active');
                                

                            })
                            .catch(function(err) {
                                console.log('Microphone access denied: ' + err.message);

                                awaitingMicrophoneModal.hide();

                                setTimeout(function () {
                                    var deniedMicrophoneModal = new bootstrap.Modal(document.getElementById('denied-microphone-access'), {
                                        keyboard: false
                                    });
                                    deniedMicrophoneModal.show();
                                }, 1000);  // Adjust the delay if needed
                            });
                    }, 1000)
                }
                // Check if the button has the class 'recording-active' to stop recording
                else if ($(this).hasClass('edit-recording-active')) {
                    if (audioRecorder && audioRecorder.state === 'recording') {
                        audioRecorder.stop();
                    }
                }
                else if ($(this).hasClass('confirm-audio-editing')) {
                    var messageID = $(this).data('message-id');
                    var messageType = $(this).data('type');

                    let audioData = new FormData();

                    audioData.append('message_id', messageID);
                    audioData.append('type', messageType);
                    audioData.append('content', blob);
                    audioData.append('csrfmiddlewaretoken', '{{csrf_token}}');

                    $.ajax({
                        type: 'POST',
                        url: '/chat/edit-message/',
                        processData: false,
                        contentType: false,
                        data: audioData,
                        success: function (response) {
                            
                            messageSocket.send(JSON.stringify({
                                'message_type': response.message_type,
                                'action': 'edit_message',
                                'message_id': response.message_id,
                                'is_reply': 'false', // dosen't matter
                                'is_editing': 'true',
                            }));
                        }
                    })

                    
                }
            });
            // for polling
            $('#conversation-contents').on('click', '.poll-option', function () {
                var optionID = $(this).data('option-id');
                $.ajax({
                    type: 'POST',
                    url: '/polls/vote-for-poll/',
                    data: {
                        'option_id': optionID,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        eventSocket.send(JSON.stringify({
                            'event_type': 'vote_for_poll',
                            'option_id': response.option_id,
                        }))
                    }
                })
            })
            // for seeing who voted
            $('#conversation-contents').on('mouseenter', '.poll-option', function () {
                var optionID = $(this).data('option-id');
                var optionDiv = $('#option-' + optionID);
                var hiddenInfo = $(this).data('hidden-info');
                var begunHovering = true
                intervalId = setInterval(function() {
                    if (begunHovering) {
                        optionDiv.append(hiddenInfo);
                        begunHovering = false
                    }
                }, 500);
            })
            $('#conversation-contents').on('mouseleave', '.poll-option', function () {
                var optionID = $(this).data('option-id');
                var optionDiv = $('#option-' + optionID);
                var hiddenInfo = $('#hidden-info-' + optionID);
                clearInterval(intervalId);
                hiddenInfo.remove();
            })
            var leaveChatroomModal = new bootstrap.Modal(document.getElementById('leave-chatroom-modal'), {
                keyboard: false
            });
            $('#leave-chatroom').click(function () {
                leaveChatroomModal.show();
            })
            $('#leave-chatroom-button').click(function () {
                if ('{{username}}' === '{{room.owner.username}}') {
                    console.log('cannot leave room, must assign a new owner first.')

                    leaveChatroomModal.hide();

                    setTimeout(function() {
                    var errorModal = new bootstrap.Modal(document.getElementById('leave-chatroom-error'), {
                        keyboard: false
                    });
                    errorModal.show();
                    }, 500)
                    

                } else {
                    $.ajax({
                    type: 'POST',
                    url: '/chat_settings/leave-chatroom/',
                    data: {
                        'chat_room_id': '{{room.id}}',
                        'csrfmiddlewaretoken': '{{csrf_token}}',
                    },
                    success: function (response) {
                        var isSuccessful = response.successful;
                        if (isSuccessful) {
                            location.href = '/chat/';
                        } else {
                            console.log('removal insuccessful.')
                        }
                    }

                })
                }
            })
            // Deactivation of the context-menu when a left-click is registered.
            
            $(document).on("click", function(e) {
                $('.options').fadeOut(200);
            });

            // For activating the context-menu, so that a user can edit, delete, download, or copy a message.
            $('#conversation-contents').on('contextmenu', '.hidden-options', function (e) {
                e.preventDefault();

                $('.options').fadeOut(200);

                var messageID = $(this).data('message-id');
                console.log(messageID)
                var optionsPage = $('.options-' + messageID);

                setTimeout(function () {
                    optionsPage.css({
                        display: "block",
                        position: "fixed",
                        zIndex: 10000,
                        left: e.pageX,
                        top: e.pageY,
                    });
                }, 300)
                
            });
            $('#conversation-contents').on('click', '.copy-message', function () {
                var text = $(this).data('text')
                console.log(text)
                if (text) {
                    var tempInput = $('<input>');
                    $('body').append(tempInput);
                    tempInput.val(text).select();

                    document.execCommand("copy");

                    tempInput.remove();
                } else {
                    console.log('text not found.');
                }
            })

            $('#conversation-contents').on('click', '.download-message', function () {
                var url = $(this).data('download-url');
                var messageType = $(this).data('type');
                if (url && messageType) {
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'file' // Must be defined or the file dosen't download.
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }
            })
            var oldMessageStorage = {};
            $('#conversation-contents').on('click', '.edit-message', function () {
                var messageType = $(this).data('type');
                var messageID = $(this).data('message-id');

                var replySection = $('#message-reply-container-' + messageID);
                var bodySection = $('#message-body-container-' + messageID);

                // get old message and store it whilst editing
                var oldMessageReply = replySection.children().detach()
                var oldMessageBody = bodySection.children().detach()
                oldMessageStorage[messageID] = {
                    'is_reply': replySection.length,
                    'reply': oldMessageReply,
                    'body': oldMessageBody,
                };

                if (replySection) {
                    var replyID = $(this).data('reply-id');
                    var replyType = $(this).data('reply-type');
                    var replySender = $(this).data('reply-sender');
                    var replyText = $(this).data('reply-text');

                    var replyATag;
                    switch (replyType){
                        case 'text':
                            replyATag = `<a href="#message-timestamp-${replyID}" class="btn p-0"><p class="small text-truncate m-0">${replyText}</p></a>`;
                            break;

                        case 'image':
                            replyATag = `<a href="#message-timestamp-${replyID}" class="btn p-0"><p class="small text-truncate m-0">Image</p></a>`;
                            break;

                        case 'video':
                            replyATag = `<a href="#message-timestamp-${replyID}" class="btn p-0"><p class="small text-truncate m-0">Video</p></a>`;
                            break;

                        case 'audio':
                            replyATag = `<a href="#message-timestamp-${replyID}" class="btn p-0"><p class="small text-truncate m-0">Audio</p></a>`;
                            break;
                    }

                    var replySectionHtml = `
                        <div class="col-10 hidden-options d-flex justify-content-start" data-message-id="${messageID}" id="message-reply-container-${messageID}">
                            <div class="card p-0 pb-0 text-bg-light" style="width: 85%; border: none; opacity: 70%; z-index: 1; position: relative;">
                                <div class="card-header" style="border-bottom: none;">
                                    <a href="#message-timestamp-${replyID}" class="btn p-0"><p class="small m-0"><em>REPLY:</em> ${replySender}</p></a>
                                    ` + replyATag + `
                                </div>
                            </div>
                        </div>
                    `;
                    replySection.html('');
                    replySection.html(replySectionHtml);
                }


                var editPromptHtml;
                switch (messageType){
                    
                    case 'text':
                        var oldText = $(this).data('text');
                        editPromptHtml = `
                            <div class="d-flex justify-content-center">
                                <textarea id="edit-text-box-${messageID}" class="edit-text" data-message-id="${messageID}">${oldText}</textarea>
                            </div>
                            <div class="d-flex justify-content-center">
                                <button type="button" class="btn confirm-editing" data-message-id="${messageID}" data-type="text"><i class="bi bi-check2" style="color: #ffffff;"></i></button>
                                <button type="button" class="btn deny-editing" data-message-id="${messageID}"><i class="bi bi-x-lg" style="color: #ffffff;"></i></button>
                            </div>
                        `;
                        break;

                    case 'image':
                        editPromptHtml = `
                            <label for="image-file-field" class="form-label">Place image here</label>
                            <input id="edit-image-${messageID}" class="form-control" type="file">
                            <div class="d-flex justify-content-center">
                                <button type="button" class="btn confirm-editing" data-message-id="${messageID}" data-type="image"><i class="bi bi-check2" style="color: #ffffff;"></i></button>
                                <button type="button" class="btn deny-editing" data-message-id="${messageID}"><i class="bi bi-x-lg" style="color: #ffffff;"></i></button>
                            </div>
                        `;
                        break;

                    case 'video':
                        editPromptHtml = `
                            <label for="video-file-field" class="form-label">Place video here</label>
                            <input id="edit-video-${messageID}" class="form-control" type="file">
                            <div class="d-flex justify-content-center">
                                <button type="button" class="btn confirm-editing" data-message-id="${messageID}" data-type="video"><i class="bi bi-check2" style="color: #ffffff;"></i></button>
                                <button type="button" class="btn deny-editing" data-message-id="${messageID}"><i class="bi bi-x-lg" style="color: #ffffff;"></i></button>
                            </div>
                        `;
                        break;

                    case 'audio':
                        editPromptHtml = `
                            <p class="small text-center" id="edit-voice-prompt-text">Press the microphone to start recording voice or upload an audio file.</p>
                            <div class="d-flex justify-content-center">
                                <div id="edit-recording-controls">
                                    <button class="btn edit-request-recording" type="button" data-message-id="${messageID}"><i id="edit-mic-icon" class="bi bi-mic" style="color: #ffffff;"></i></button>
                                    <button type="button" class="btn edit-upload-element" onclick="document.getElementById('edit-audio-upload-field').click();"><i class="bi bi-upload" style="color: #ffffff;"></i></button>
                                    <button type="button" class="btn edit-recording-preview-controls deny-editing" data-message-id="${messageID}"><i class="bi bi-x-lg" style="color: #ffffff;"></i></button>
                                    <input type="file" class="edit-audio-upload edit-upload-element" data-message-id="${messageID}" id="edit-audio-upload-field" style="display: none;">
                                </div>
                            </div>
                            
                        `;
                        break;
                }
                var bodySectionHtml = `
                    <div class="card text-bg-success" style="width: 85%; border: none; opacity: 85%;">
                        <div class="card-header" style="border-bottom: none;">
                            <div class="row">
                                <div class="col">
                                    ` + editPromptHtml + `
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                bodySection.html('');
                bodySection.html(bodySectionHtml);

            })
            $('#conversation-contents').on('click', '.confirm-editing', function () {
                var messageID = $(this).data('message-id');

                var messageType = $(this).data('type');
                
                var content;
                switch (messageType) {
                    case 'text':
                        content = $('#edit-text-box-' + messageID).val();
                        break;

                    case 'image':
                        content = $('#edit-image-' + messageID)[0].files[0];       
                        break;
                    
                    case 'video':
                        content = $('#edit-video-' + messageID)[0].files[0];
                        break;
                }   
            console.log(content)
            editMessageData = new FormData()

            editMessageData.append('type', messageType);
            editMessageData.append('content', content);
            editMessageData.append('message_id', messageID);
            editMessageData.append('csrfmiddlewaretoken', '{{csrf_token}}');

            $.ajax({
                type: 'POST',
                url: '/chat/edit-message/',
                processData: false, // Important!
                contentType: false, // Important!
                data: editMessageData,

                success: function (response) {
                    console.log('message edited');

                    messageSocket.send(JSON.stringify({
                        'message_type': response.message_type,
                        'action': 'edit_message',
                        'message_id': response.message_id,
                        'is_reply': 'false', // dosen't matter
                        'is_editing': 'true',
                    }));
                }
            })
                
            })
            $('#conversation-contents').on('click', '.deny-editing', function () {
                var messageID = $(this).data('message-id');

                console.log(messageID);

                console.log(oldMessageStorage);

                if (oldMessageStorage[messageID]['is_reply'] !== 0) {
                    var oldMessageReply = oldMessageStorage[messageID]['reply'];
                    var replySection = $('#message-reply-container-' + messageID);

                    replySection.html('');
                    replySection.html(oldMessageReply);

                }
                
                var oldMessageBody = oldMessageStorage[messageID]['body'];
                var bodySection = $('#message-body-container-' + messageID);

                bodySection.html('');
                bodySection.html(oldMessageBody);

            })
            $('#conversation-contents').on('click', '.delete-message', function () {
                var messageID = $(this).data('message-id');
                var messageType = $(this).data('type');

                console.log(messageID)
                $.ajax({
                    type: 'POST',
                    url: '/chat/delete-message/',
                    data: {
                        'message_id': messageID,
                        'message_type': messageType,
                        'csrfmiddlewaretoken': '{{csrf_token}}'
                    },
                    success: function(response) {
                        console.log('Message deleted.')

                        messageSocket.send(JSON.stringify({
                            'message_id': response.message_id,
                            'action': 'delete_message',
                        }))
                    }
                })

            })

            // Reactions: Single click
            var reactionMessageID;
            $('#conversation-contents').on('click', '.react-button', function (e) {
                var numberOfReactions = $(this).data('number-of-reactions');
                reactionMessageID = $(this).data('message-id');
                
                $('.options').fadeOut(200);
                console.log(numberOfReactions)
                if (numberOfReactions == 0) {
                    var reactions = $('#reactions');
                    reactions.fadeOut(200);

                    setTimeout(function () {
                        reactions.css({
                            display: "block",
                            position: "fixed",
                            zIndex: 9000,
                            left: e.pageX - 150,
                            top: e.pageY + 20,
                        });
                    }, 300)
                } else {
                    var hasReacted = $(this).hasClass('has-reacted');
                    if (hasReacted) {
                        // logic to unreact from a message 
                        var emoticon = $(this).data('emoticon')
                        var messageID = reactionMessageID;

                        $.ajax({
                            type: 'POST',
                            url: '/chat/reactions/',
                            data: {
                                'emoticon': emoticon,
                                'message_id': messageID,
                                'csrfmiddlewaretoken': '{{csrf_token}}'
                            },
                            success: function (response) {
                                console.log('reacted to message')
                                
                                messageSocket.send(JSON.stringify({
                                    'action': 'reaction',
                                    'sub_action': response.reaction_result,
                                    'reaction': response.reaction,
                                    'reactor': response.reactor,
                                    'reaction_id': response.reaction_id,
                                    'message_id': response.message_id,
                                }))
                            }
                        })
                    } else {
                        var popularReaction = $(this).data('popular-reaction');
                        var messageID = reactionMessageID;

                        $.ajax({
                            type: 'POST',
                            url: '/chat/reactions/',
                            data: {
                                'emoticon': popularReaction,
                                'message_id': messageID,
                                'csrfmiddlewaretoken': '{{csrf_token}}'
                            },
                            success: function (response) {
                                console.log('reacted to message')
                                
                                messageSocket.send(JSON.stringify({
                                    'action': 'reaction',
                                    'sub_action': response.reaction_result,
                                    'reaction': response.reaction,
                                    'reactor': response.reactor,
                                    'reaction_id': response.reaction_id,
                                    'message_id': response.message_id,
                                }))
                            }
                        })
                    }
                }
            })
            $('#reaction-search').on('input', function () {
                var query = $(this).val();
                if (query !== '') {
                    $.ajax({
                        type: 'POST',
                        url: '/universal/realtime-suggestions-manager/',
                        data: {
                            'query': query,
                            'type': 'search',
                            'answer_catergory': 'Emoticons',
                            'csrfmiddlewaretoken': '{{csrf_token}}'
                        },
                        success: function (response) {
                            var suggestionsHtml = '';
                            var suggestionHtml;
                            for (let i = 0; i < response.solutions.length; i++) {
                                suggestionHtml = `
                                    <div class="col d-flex justify-content-start">
                                        <button type="button" class="btn emoticon" data-emoticon="${response.solutions[i]['name']}">${response.solutions[i]['unicode']}</button>
                                    </div>
                                `;
                                suggestionsHtml += suggestionHtml
                            }
                            $('#emoticons-list').html('')
                            $('#emoticons-list').html(suggestionsHtml)
                        } 
                    })
                } else {
                    var suggestionsHtml = `
                        {% for emoticon in emoticon_dict.keys %}
                            <div class="col d-flex justify-content-start">
                                <button type="button" class="btn emoticon" data-emoticon="{{emoticon}}">{{ emoticon|emoticon|safe }}</button>
                            </div>
                        {% endfor %}
                    `;

                    $('#emoticons-list').html('')
                    $('#emoticons-list').html(suggestionsHtml)
                }
                
            })
            $('#reactions').on('click', '.emoticon', function () {
                var emoticon = $(this).data('emoticon')
                var messageID = reactionMessageID;

                $.ajax({
                    type: 'POST',
                    url: '/chat/reactions/',
                    data: {
                        'emoticon': emoticon,
                        'message_id': messageID,
                        'csrfmiddlewaretoken': '{{csrf_token}}'
                    },
                    success: function (response) {
                        console.log('reacted to message')
                        // send data over to message socket
                        messageSocket.send(JSON.stringify({
                            'action': 'reaction',
                            'sub_action': response.reaction_result,
                            'reaction': response.reaction,
                            'reactor': response.reactor,
                            'reaction_id': response.reaction_id,
                            'message_id': response.message_id,
                        }))
                    }
                })
            })
            // Reactions: Hover
            var reactionHoverIntervalID;
            var reactionHoverTimer;
            $('.reaction-response').on('mouseenter', function () { // stops the removal of the reaction response popup
                clearTimeout(reactionHoverTimer)
            })
            $('#conversation-contents').on('mouseenter', '.react-button', function (e) { // initiates the reaction responce popup
                // Show the users and what they have reacted with
                var messageID = $(this).data('message-id');
                var reactionResponsePopup = $('#reaction-response-' + messageID);
                var begunHovering = true
                reactionHoverIntervalID = setInterval(function() {
                    if (begunHovering) {
                        begunHovering = false
                        setTimeout(function () {
                            reactionResponsePopup.css({
                                display: "block",
                                position: "fixed",
                                zIndex: 9000,
                                left: e.pageX - 150,
                                top: e.pageY + 20,
                            });
                        }, 500);
                    }
                }, 500);
                
            })
            $('#conversation-contents').on('mouseleave', '.react-button', function (e) { // begins to remove the reaction response popup. can be interupted if hovered over
                var messageID = $(this).data('message-id');
                var reactionResponsePopup = $('#reaction-response-' + messageID);
                
                clearInterval(reactionHoverIntervalID)
                reactionHoverTimer = setTimeout(function () {
                    reactionResponsePopup.fadeOut(200)
                }, 500)

            })
            $('.reaction-response').on('mouseleave', function (e) {
                var messageID = $(this).data('message-id');
                var reactionResponsePopup = $('#reaction-response-' + messageID);

                reactionResponsePopup.fadeOut(200)

            })
            // Reactions: Hold
            var reactionHoldTimer
            $('#conversation-contents').on('mousedown', '.react-button', function (e) { // initiates the reactions popup on a hold
                var reactions = $('#reactions');
                reactionMessageID = $(this).data('message-id');
                
                reactionHoldTimer = setTimeout(function () {
                    reactions.css({
                        display: "block",
                        position: "fixed",
                        zIndex: 9000,
                        left: e.pageX - 150,
                        top: e.pageY + 10,
                    });
                }, 300)
                
            })
            $('#conversation-contents').on('mouseup', '.react-button', function () {
                clearTimeout(reactionHoldTimer)
            })
            var reactionRemovalTimer;
            $('#reactions').on('mouseenter', function () { // interupts the removal of the reactioms popup
                clearTimeout(reactionRemovalTimer)
            })
            $('#reactions').on('mouseleave', function () { // begins to remove the reaction popup, stops if the popup is hovered over
                var reactions = $('#reactions');
                reactionRemovalTimer = setTimeout(function () {
                    reactions.fadeOut(200);
                }, 300)
            })
            $('#conversation-contents').on('mouseleave', '.react-button', function () {
                var reactions = $('#reactions');
                reactionRemovalTimer = setTimeout(function () {
                    reactions.fadeOut(200);
                }, 300)
            })
            $('#message').focus(function () {
                var suggestedResponseCard = $('#suggested-response-card');
                var suggestedResponseList = $('#suggested-response');

                if (suggestedResponseCard.css('display') === 'none') {
                    suggestedResponseCard.css('display', 'block');

                    var suggestedResponseHtml = `
                        <p class="lead text-center">Awaiting Suggested Response...</p>
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border" role="status"></div>
                        </div>
                    `;
                    suggestedResponseList.html(suggestedResponseHtml);

                    $.ajax({
                        type: 'POST',
                        url: '/chat/message-suggestions/',
                        data: {
                            'username': '{{username}}',
                            'chatroom-id': '{{room.id}}',
                            'csrfmiddlewaretoken': '{{csrf_token}}'
                        },
                        success: function (response) {
                            var suggestions = response.responses;
                            console.log(suggestions)

                            var suggestionsHtml = '';
                            var suggestionHtml;
                            for (let i = 0; i < suggestions.length; i++) {
                                suggestionHtml = `
                                    <div class="col d-flex justify-content-center">
                                        <button type="button" class="btn btn-light rounded-pill"><p class="text-center text-success m-0 p-0">${suggestions[i]}</p></button>
                                    </div>
                                `;
                                suggestionsHtml += suggestionHtml
                            }
                            
                            var suggestedResponseHtml = `
                                <div class="row">
                                    <p class="lead text-center">Recommendations</p>
                                </div>
                                <div class="row">
                                    ${suggestionsHtml}
                                </div>
                            `;

                            $('#suggested-response').html('');
                            $('#suggested-response').html(suggestedResponseHtml);
                        }
                    })
                }

                // #suggested-response-card, #suggested-response
                // popup the suggested response, await ai recommendation
            })
            $('#message').blur(function () {
                var suggestedResponseCard = $('#suggested-response-card');
                if (suggestedResponseCard.css('display') === 'block') {
                    setTimeout(function () {
                        suggestedResponseCard.fadeOut(300);
                    }, 400)
                    // don't remove suggested response, until new message has been sent.
                }
            })
        });
    </script>
</div>
<!-- To store notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="inbox">
</div>

<!-- For requesting microphone permissions -->
<div class="modal fade" id="awaiting-microphone-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row">
                    <div class="col">
                        <p class="lead text-center">Awaiting microphone permissions</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col d-flex justify-content-center">
                        <div class="spinner-border text-dark" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Denied microphone access -->
<div class="modal fade" id="denied-microphone-access">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <strong>ERROR</strong>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col">
                        <p class="lead text-center">Microphone permissions denied. To create voice messages, please allow microphone permissions on your web browser</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col d-flex justify-content-center">
                        <i class="bi bi-mic-mute-fill" style="font-size: 2.5rem; color: #198754;"></i>
                    </div>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

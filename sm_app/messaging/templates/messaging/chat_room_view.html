{% extends 'messaging/template.html' %}
{% load crispy_forms_tags %}
{% block title %} Messaging {% endblock %}
{% block profile %}
    <li class="custom-icon"><div class="fs-4"><i class="bi bi-person" style="color: #787878;"></i></div> <a href="/profile/{{username}}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Profile</p></a></li>
{% endblock %}
{% block settings %}
    <li class="custom-icon"><div class="fs-4"><i class="bi bi-gear-wide-connected" style="color: #787878;"></i></div> <a href="/settings/{{username}}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover"><p class="lead">Settings</p></a></li>
{% endblock %}
{% block searchBar %}
    {{search_bar| crispy}}
{% endblock %}
{% block notifications %}
        {% for notification in notifications.values %}
            <div id="notification-{{notification.notification_object.pk}}" class="card mb-2" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
                <div class="card-header">
                    <button class="btn p-0" id="read-notification-{{notification.notification_object.pk}}">
                        <img src="{{notification.notification_object.source.icon.url}}" class="rounded me-2" alt="" style="height: 2.5rem; width: 2.5rem">
                    </button>
                    <button class="btn p-0 pe-2" id="read-notification-{{notification.notification_object.pk}}">
                        <strong class="me-auto">{{notification.notification_object.source.name}}</strong>
                    </button>
                    <small class="text-muted pe-2">{{notification.notification_object.timestamp}}</small>
                    <button type="button ms-2" class="btn-close" id="close-notification-{{notification.notification_object.pk}}" aria-label="Close"></button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <img src="{{notification.sender_pfp_url}}" class="rounded me-2" alt="" style="height: 2.5rem; width: 2.5rem">
                            <em>{{notification.notification_object.sender}}</em>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col mt-2">
                            {% if notification.notification_object.relevant_message.text %}
                                <p class="text-truncate">{{notification.notification_object.contents}}</p>
                            {% else %}
                                {% if notification.notification_object.relevant_message.reply %}
                                    {% if notification.notification_object.relevant_message.image %}
                                        <p class="text-truncate">({{notification.notification_object.relevant_message.sender.user.username}} Replied to You): <strong>Image</strong></p>
                                    {% else %}
                                        <p class="text-truncate">({{notification.notification_object.relevant_message.sender.user.username}} Replied to You): <strong>Video</strong></p>
                                    {% endif %}
                                {% else %}
                                <p class="text-truncate"><strong>{{notification.notification_object.contents}}</strong></p>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <script>
                $(document).ready(function () {
                    $('#close-notification-{{notification.notification_object.pk}}').click(function () {
                        $.ajax({
                            type: 'POST',
                            url: '/universal/remove-notification/',
                            data: {
                                'receiver': '{{username}}',
                                'type': 'notification-id',
                                'csrfmiddlewaretoken': '{{ csrf_token }}',
                                'notification_id': '{{notification.notification_object.pk}}'
                            },
                            success: function(response) {
                                console.log(response.notification_count, response.notification_counter)
                                var notification = $("#notification-{{notification.notification_object.pk}}")
                                notification.remove();
                                $('#notification-counter').text('');
                                $('#notification-counter').text(response.notification_count);
                                    if (response.notification_count == 0) {
                                        $('#notification-counter').text(response.notification_count).hide();
                                        $('#notification-counter').remove();
                                        $('#bell-icon').removeClass('bi-bell-fill');
                                        $('#bell-icon').addClass('bi-bell');
                                    }
                            }
                        })
                    })
                    $('#read-notification-{{notification.notification_object.pk}}').click(function () {
                        $.ajax({
                            type: 'POST',
                            url: '/universal/remove-notification/',
                            data: {
                                'receiver': '{{username}}',
                                'type': 'notification-id',
                                'csrfmiddlewaretoken': '{{ csrf_token }}',
                                'notification_id': '{{notification.notification_object.pk}}'
                            },
                            success: function(response) {
                                console.log(response.message)
                                var domain = window.location.origin;
                                var path = '/chat/{{notification.notification_object.source.name}}/{{notification.notification_object.source.pk}}'
                                window.location.href = domain + path
                            }
                        })
                    })
                })
                
            </script>
        {% endfor %}
{% endblock %}
{% block notification_count %}
    <div id="notification-indicatior">
        {% if notification_count == 0 %}
            <script>
                $(document).ready(function () {
                    var notification_count = '{{notification_count}}';
                    var notification_bell = $('#bell-icon');
                    notification_bell.removeClass('bi-bell-fill');
                    notification_bell.addClass('bi-bell');
                })
            </script>
        {% else %}
            <span class="top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notification-counter">{{ notification_count }}
        {% endif %}
    </div>
{% endblock %}
{% block chatrooms %}
    {% for chat_room in chat_rooms %}
    <div class="row">
        <div class="col-3">
            <button class="btn" onclick='location.href="/chat/{{chat_room.name}}/{{chat_room.id}}"'>
                <img src="{{chat_room.icon.url}}" style="max-width: 2.5rem; max-height: 2.5rem; border-radius: 35%;">
            </button>
        </div>
        <div class="col-7">
            <button class="btn" onclick='location.href="/chat/{{chat_room.name}}/{{chat_room.id}}"'>
                <p class="lead">{{chat_room.name}}</p>
            </button>
        </div>
        <br>
    {% endfor %}
{% endblock %}
{% block conversation %}
<div class="container">
    <div class="card p-0" style="height: 630px;" >
        <div class="card-header">
            <div class="row">
                <div class="col-1">
                    <img src="{{room.icon.url}}" alt="" class="p-2 rounded-circle" style="max-height: 4rem; max-width: 4rem;">
                </div>
                <div class="col-11">
                    <p class="lead text-start mt-3">{{room.name}}</p>
                </div>
            </div>
        </div>
        <img src="{{room.room_bg_image.url}}" alt="" style="height: 547px; opacity: 30%; border-bottom-left-radius: 5px;">
        <div class="card-img-overlay" style="overflow-y: auto; margin-top: 80px;" id="conversationFrame">
            <div class="card-body" id="conversation-contents">
                {% for message in messages %}
                    <div class="row">
                        <div class="col">
                            <p id="message-{{message.id}}" class="text-center"><em>{{message.sent_at}}</em></p>
                        </div>
                    </div>
                    <div class="row">
                        {% if message.sender.user.username == username %}
                            {% if message.reply != None %}
                                <div class="col-6">
                                </div>
                                <div class="col-6">
                                    <div class="row">
                                        <div class="col-10 d-flex justify-content-end">
                                            <div class="card p-0 pb-0 text-bg-light" style="width: 85%; border: none; opacity: 70%;">
                                                <div class="card-header" style="border-bottom: none;">
                                                    <a href="#message-{{message.reply.id}}" class="btn p-0"><p class="small m-0"><em>REPLY:</em> {{message.reply.sender}}</p></a>
                                                    {% if message.reply.text %}
                                                        <a href="#message-{{message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0">{{message.reply.text}}</p></a>
                                                    {% elif message.reply.image %}
                                                        <a href="#message-{{message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0"><strong>Image</strong></p></a>
                                                    {% elif message.reply.video %} 
                                                        <a href="#message-{{message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0"><strong>Video</strong></p></a>
                                                    {% else %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-2">
                                            <p id="message-{{message.id}}" class="d-flex justify-content-start"><strong>You</strong></p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-10 d-flex justify-content-end">
                                            <div class="card text-bg-success" style="width: 85%; border: none; opacity: 85%;">
                                                <div class="card-header" style="border-bottom: none;">
                                                    {% if message.text %}
                                                        <p>{{message.text}}</p>
                                                    {% elif message.image %}
                                                        <img src="{{message.image.url}}" alt="" class="mt-1" style="width: 100%; height:88%; border-radius: 5px;">
                                                    {% else %} 
                                                        <video src="{{message.video.url}}" controls class="mt-1" style="width: 100%; height:88%; border-radius: 5px;"></video>
                                                    {% endif %}
                                                    <div class="row">
                                                        <div class="col">
                                                            {% if message.text %}
                                                                <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="{{message.text}}" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                            {% elif message.image %} 
                                                                <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="Image" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                            {% else %} 
                                                                <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="Video" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-1">
                                            <img src="{{message.sender.pfp.url}}" alt="" class="rounded-circle" style="max-width: 2rem; max-height: 2rem;">
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="col-6">
                                </div>
                                <div class="col-6">
                                    <div class="row">
                                        <div class="col-11">
                                            <p class="d-flex justify-content-end"><strong>You</strong></p>
                                        </div>
                                        <div class="col-1">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-10 d-flex justify-content-end">
                                            <div class="card text-bg-success" style="width: fit-content; border: none; opacity: 85%;">
                                                <div class="card-header" style="border-bottom: none;">
                                                    {% if message.text %}
                                                        <p>{{message.text}}</p>
                                                    {% elif message.image %}
                                                        <img src="{{message.image.url}}" alt="" class="mt-1" style="width: 100%; height:88%; border-radius: 5px;">
                                                    {% else %} 
                                                        <video src="{{message.video.url}}" controls class="mt-1" style="width: 100%; height:88%; border-radius: 5px;"></video>
                                                    {% endif %}
                                                    <div class="row">
                                                        <div class="col">
                                                            {% if message.text %}
                                                                <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="{{message.text}}" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                            {% elif message.image %}
                                                                <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="Image" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                            {% else %} 
                                                                <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="Video" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply" style="color: #ffffff;"></i></button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-1">
                                            <img src="{{message.sender.pfp.url}}" alt="" class="rounded-circle" style="max-width: 2rem; max-height: 2rem;">
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% else %}
                            {% if message.reply != None %}
                                <div class="col-6">
                                    <div class="row">
                                        <div class="col">
                                            <p class="d-flex justify-content-start"><strong>{{message.sender.user.username}}</strong></p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-2">
                                            <img src="{{message.sender.pfp.url}}" class="rounded-circle" alt="" style="max-width: 2rem; max-height: 2rem;">
                                        </div>
                                        <div class="col-10 d-flex justify-content-start">
                                            <div class="card p-0 pb-0 text-bg-light" style="width: 85%; border: none; opacity: 70%;">
                                                <div class="card-header" style="border-bottom: none;">
                                                    <a href="#message-{{message.reply.id}}" class="btn p-0"><p class="small m-0"><em>REPLY:</em> {{message.reply.sender}}</p></a>
                                                    {% if message.reply.text %}
                                                        <a href="#message-{{message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0">{{message.reply.text}}</p></a>
                                                    {% elif message.reply.image %}
                                                        <a href="#message-{{message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0"><strong>Image</strong></p></a>
                                                    {% elif message.reply.video %} 
                                                        <a href="#message-{{message.reply.id}}" class="btn p-0"><p class="small text-truncate m-0"><strong>Video</strong></p></a>
                                                    {% else %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-2">
                                        </div>
                                        <div class="col-10 d-flex justify-content-start">
                                            <div class="card" style="width: 85%; border: none; opacity: 85%;">
                                                <div class="card-header" style="border-bottom: none;">
                                                    {% if message.text %}
                                                        <p>{{message.text}}</p>
                                                    {% elif message.image %}
                                                        <img src="{{message.image.url}}" alt="" class="mt-1" style="width: 100%; height:88%; border-radius: 5px;">
                                                    {% else %} 
                                                        <video src="{{message.video.url}}" controls class="mt-1" style="width: 100%; height:88%; border-radius: 5px;"></video>
                                                    {% endif %}
                                                    <div class="row">
                                                        <div class="col">
                                                            {% if message.text %}
                                                                <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="{{message.text}}" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply"></i></button>
                                                            {% elif message.image %}
                                                                <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="Image" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply"></i></button>
                                                            {% else %} 
                                                                <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="Video" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply"></i></button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                </div>
                            {% else %}
                                <div class="col-6">
                                    <div class="row">
                                        <div class="col-10">
                                            <p class="d-flex justify-content-start"><strong>{{message.sender.user.username}}</strong></p>
                                        </div>
                                        <div class="col-2">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-2">
                                            <img src="{{message.sender.pfp.url}}" class="rounded-circle" alt="" style="max-width: 2rem; max-height: 2rem;">
                                        </div>
                                        <div class="col-10">
                                            <div class="card" style="width: fit-content; border: none; opacity: 85%;">
                                                <div class="card-header" style="border-bottom: none;">
                                                    {% if message.text %}
                                                        <p>{{message.text}}</p>
                                                    {% elif message.image %}
                                                        <img src="{{message.image.url}}" alt="" class="mt-1" style="width: 100%; height:88%; border-radius: 5px;">
                                                    {% else %} 
                                                        <video src="{{message.video.url}}" controls class="mt-1" style="width: 100%; height:88%; border-radius: 5px;"></video>
                                                    {% endif %}
                                                    <div class="row">
                                                        <div class="col">
                                                            {% if message.text %}
                                                                <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="{{message.text}}" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply"></i></button>
                                                            {% elif message.image %} 
                                                                <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="Image" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply"></i></button>
                                                            {% else %} 
                                                                <button type="button" class="btn reply" data-message-id="{{message.id}}" data-message="Video" data-message-sender="{{message.sender.user.username}}" id="reply-button-{{message.id}}"><i class="bi bi-reply"></i></button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <br>
    <form action="" method="post">
        {% csrf_token %}
        <div class="row">
            <div class="col-1">
                <button type="button" class="btn btn-outline-success" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-plus-square" style="font-size:  3vw;"></i></button>
                <div class="btn-group dropup">
                    <ul class="dropdown-menu p-2 mb-1" style="width: 300px">
                        <div class="row">
                            <div class="col-4">
                                <p>Messages</p>
                                <button class="btn" id="init-image" type="button"><li class="custom-icon"><div class="fs-4"><i class="bi bi-images"></i></div> Image</li></button>
                                <button class="btn" id="init-video" type="button"><li class="custom-icon"><div class="fs-4"><i class="bi bi-play-btn"></i></i></div> Video</li></button>
                            </div>
                            <div class="col-2">
                            </div>
                            <div class="col-4">
                                <p>Events</p>
                                <button class="btn" type="button" onclick="location.href='/create_poll/'"><li class="custom-icon"><div class="fs-4"><i class="bi bi-bar-chart-fill"></i></div> Poll</li></button>
                            </div>
                        </div>
                    </ul>
                </div>
            </div>
            <div class="col-10" id="message-div">
                <input type="hidden" id="is-reply" value="false">
                <input type="hidden" id="is-text" value="true">
                <input type="hidden" id="is-image" value="false">
                <input type="hidden" id="is-video" value="false">
                <input type="text" id="message" class="form-control pb-3 p-4">
            </div>
            <div class="col-1">
                <div class="card">
                    <button type="button" id="send" class="btn btn-outline-success" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-send-fill" style="font-size: 3vw;"></i></button>
                </div>
            </div>
        </div>
    </form>
    <!-- Websocket for sending messages -->
    <script type="text/javascript">
        // for conviniance
        function scrollBarAtBottom() {
                var scrollableContent = document.getElementById("conversationFrame");
                scrollableContent.scrollTop = scrollableContent.scrollHeight;
            }
        setTimeout(scrollBarAtBottom(), 1000)
        var roomId = "{{ room.id }}";  // Django template variable for chatroom ID
        var roomName = "{{ room.name }}";  // Django template variable for chatroom name
        var reconnectionTime = 5000;
        let messageSocket
        let notificationSocket
        function setupReply(messageId, username, message) {
            const isReply = $('#is-reply'); // hidden input field where the message textfield is. tells us if a reply is being made or not.
            const isImage = $('#is-image');
            const isVideo = $('#is-video');
            const messageDiv = $('#message-div');

            const replyPromptHtml = `
                <div class="card mt-1" id="reply-prompt" style="border: none;">
                    <div class="card-header" style="border-bottom: none;">
                        <div class="row">
                            <div class="col">
                                <p class="lead">Replying to <strong>${username}</strong>:</p>
                            </div>
                            <div id="reply-information-holder" data-message-id="${messageId}"></div>
                            <div class="col">
                                <p class="text-truncate">${message}</p>
                            </div>
                        </div>
                    </div>
                </div>`;

            if (isReply.val() === 'false') { // if the reply prompt doesn't already exist
                if (isImage.val() === 'false') {
                    // Show the reply prompt on the user's screen
                    messageDiv.append(replyPromptHtml);
                    isReply.val('true'); // Set the reply value to true, indicating that a reply is being made.
                    $('html, body').animate({ scrollTop: $(document).height() }, 'fast'); // Animation for better GUI
                } else {
                    if (isVideo.val() === 'false') {
                        var mediaInput = $('#image-prompt').detach();
                    } else {
                        var mediaInput = $('#video-prompt').detatch();
                    }
                    var mediaInputHtml = mediaInput.prop('outerHTML');
                    messageDiv.append(`
                            <div class="row" id="multi-input-wrapper">
                                <div class="col-6">
                                    ${replyPromptHtml}
                                </div>
                                <div class="col-6">
                                    ${mediaInputHtml}
                                </div>
                            </div>
                        `);
                    isReply.val('true'); // Set the reply value to true, indicating that a reply is being made.
                    $('html, body').animate({ scrollTop: $(document).height() }, 'fast'); // Animation for better GUI
                }
            } else {
                if (isImage.val() === 'false') {
                    $('#reply-prompt').remove(); // Remove created HTML
                    isReply.val('false'); // Set the reply value to false, indicating that a reply is not being made.
                } else {
                    if (isVideo.val() === 'false') {
                        var mediaInput = $('#image-prompt').detach();
                    } else {
                        var mediaInput = $('#video-input').detach();
                    }
                    var mediaInputHtml = mediaInput.prop('outerHTML');
                    $('#multi-input-wrapper').remove();
                    $('#reply-prompt').remove();
                    messageDiv.append(mediaInputHtml);
                    isReply.val('false');
                }
            }
        }

        function connectMessageSocket () {
            messageSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/realtime-message-manager/' + roomId
            );

            messageSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log(data);
                var contentHtml = data.content_html;
                var selfReplyButtonHtml = data.self_reply_button_html
                var otherReplyButtonHtml = data.other_reply_button_html
                if (data.type === 'incoming_message') { // If the message wasn't a reply
                    if (data.username === '{{username}}') { // Self
                        var newMessageInHtml = `
                            <div class="message">
                                <div class="row">
                                    <div class="col">
                                        <p id="message-` + data.message_id + `" class="text-center"><em>` + data.sent_at + `</em></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                    </div>
                                    <div class="col-6">
                                        <div class="row">
                                            <div class="col-11">
                                                <p class="d-flex justify-content-end"><strong>You</strong></p>
                                            </div>
                                            <div class="col-1">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-10 d-flex justify-content-end">
                                                <div class="card text-bg-success pb-0" style="width: fit-content; border: none; opacity: 85%;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        ` + contentHtml + `
                                                        <div class="row">
                                                            <div class="col">
                                                                ` + selfReplyButtonHtml + `
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-1">
                                                <img src="` + data.user_pfp_url + `" alt="" class="rounded-circle" style="max-width: 2rem; max-height: 2rem;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                    } 
                    else { // other
                        var newMessageInHtml = `
                            <div class="message">
                                <div class="row">
                                    <div class="col">
                                        <p id="message-` + data.message_id + `" class="text-center"><em>` + data.sent_at + `</em></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="row">
                                            <div class="col-10">
                                                <p class="d-flex justify-content-start"><strong>` + data.username + `</strong></p>
                                            </div>
                                            <div class="col-2">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-2">
                                                <img src="` + data.user_pfp_url + `" class="rounded-circle" alt="" style="max-width: 2rem; max-height: 2rem;">
                                            </div>
                                            <div class="col-10">
                                                <div class="card" style="width: fit-content; border: none; opacity: 85%;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        ` + contentHtml + `
                                                        <div class="row">
                                                            <div class="col">
                                                                ` + otherReplyButtonHtml + `
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <div class="col-6">
                                </div>
                            </div>`;
                    }
                }
                else if (data.type === 'incoming_reply_message') { // For replies
                    var replyHtml = data.reply_html; // Get special html for a reply message
                    if (data.username === '{{username}}') { // Self
                        var newMessageInHtml = `
                            <div class="message">
                                <div class="row">
                                    <div class="col">
                                        <p id="message-` + data.message_id + `" class="text-center"><em>` + data.sent_at + `</em></p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                    </div>
                                    <div class="col-6">
                                        <div class="row">
                                            <div class="col-10 d-flex justify-content-end">
                                                <div class="card p-0 pb-0 text-bg-light" style="width: 85%; border: none; opacity: 70%;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        <a href="#message-` + data.reply_id + `" class="btn p-0"><p class="small m-0"><em>REPLY:</em> ` + data.reply_message_user + `</p></a>
                                                        ` + replyHtml + `
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-2">
                                                <p class="d-flex justify-content-start"><strong>You</strong></p>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-10 d-flex justify-content-end">
                                                <div class="card pb-0 text-bg-success" style="width: 85%; border: none; opacity: 85%;">
                                                    <div class="card-header" style="border-bottom: none;">
                                                        ` + contentHtml + `
                                                        <div class="row">
                                                            <div class="col">
                                                                ` + selfReplyButtonHtml + `
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-1">
                                                <img src="` + data.user_pfp_url + `" alt="" class="rounded-circle" style="max-width: 2rem; max-height: 2rem;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        } else { // Other
                            var newMessageInHtml = `
                                <div class="message">
                                    <div class="row">
                                        <div class="col">
                                            <p id="message-` + data.message_id + `" class="text-center"><em>` + data.sent_at + `</em></p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="row">
                                                <div class="col">
                                                    <p class="d-flex justify-content-start"><strong>` + data.username + `</strong></p>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-2">
                                                    <img src="` + data.user_pfp_url +`" class="rounded-circle" alt="" style="max-width: 2rem; max-height: 2rem;">
                                                </div>
                                                <div class="col-10 d-flex justify-content-start">
                                                    <div class="card p-0 pb-0 text-bg-light" style="width: 85%; border: none; opacity: 70%;">
                                                        <div class="card-header" style="border-bottom: none;">
                                                            <a href="#message-` + data.reply_id + `" class="btn p-0"><p class="small m-0"><em>REPLY:</em> ` + data.reply_message_user + `</p></a>
                                                            ` + replyHtml + `
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-2">
                                                </div>
                                                <div class="col-10 d-flex justify-content-start">
                                                    <div class="card pb-0" style="width: 85%; border: none; opacity: 85%;">
                                                        <div class="card-header" style="border-bottom: none;">
                                                            ` + contentHtml + `
                                                            <div class="row">
                                                                <div class="col">
                                                                    ` + otherReplyButtonHtml + `
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                        </div>
                                    </div>
                                </div>`;
                        }
                }
                $('#conversation-contents').append(newMessageInHtml);
                setTimeout(scrollBarAtBottom(), 1000)

                $.ajax({
                    type: 'POST',
                    url: '/universal/remove-notification/',
                    data: {
                        'type': 'message_id',
                        'message-id': data.message_id,
                        'receiver': '{{username}}',
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        console.log('Notification removed')
                    }
                });

            };
            messageSocket.onclose = function (e) {
                console.error('WebSocket closed unexpectedly:', e);
                setTimeout(connectMessageSocket, reconnectionTime);
            }

            messageSocket.onerror = function (e) {
                console.error('WebSocket encountered error:', e);
            }
        }

        function connectNotificationSocket () {
            notificationSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/brordcast-message/'
            );
            notificationSocket.onopen = function(e) {
                console.log('connected:', e )
            };

            notificationSocket.onmessage = function(e) {
                console.log('got a notification')
                const data = JSON.parse(e.data);
                if (data.source_name !== '{{room.name}}') { // if the notifiation come fron the chat room already accessing.
                    console.log('different room')
                    if (data.receiver === '{{username}}') {
                        console.log('correct user')
                        $('#inbox').append(data.html_notification_popup); // adds HTML to the inbox div, which stores notification toasts
                        $('#notification-inbox').prepend(data.stored_html_notification); // adds HTML to the notification div that houses the notifications in the off-canvas
                        
                        // Update notification count
                        var notificationCounter = $('#notification-counter');
                        var newCount = parseInt(notificationCounter.text()) || 0;
                        notificationCounter.text(newCount + 1).show();
                        
                        if ($('#bell-icon').hasClass('bi-bell')) { // if the bell looks like it has 0 notifications
                            $('#bell-icon').removeClass('bi-bell');
                            $('#bell-icon').addClass('bi-bell-fill');
                        }

                        var notificationElement = document.getElementById('popup-notification-' + data.notification_id); // gets the newly created popup notification toast

                        if (notificationElement) {
                            var notification = new bootstrap.Toast(notificationElement); // creates a bootstrap toast
                            // Show the toast
                            notification.show();
                        } else {
                            console.error('Notification element not found:', 'notification-' + data.notification_id);
                        }

                        // Attach event handlers to the newly added notification
                        attachNotificationEventHandlers(data.notification_id, data.receiver);
                    }
                }
                
                // if yes, mute the notification.
                // if no, display the notification.
            };

            notificationSocket.onerror = function(e) {
                console.error('WebSocket encountered an error:', e);
            };

            notificationSocket.onclose = function(e) {
                console.error('WebSocket closed unexpectedly:', e);
                setTimeout(connectNotificationSocket, reconnectionTime);

            };
        }
        
        function attachNotificationEventHandlers(notificationId, receiver) { 
            $(`#close-notification-${notificationId}`).click(function() {
                $.ajax({
                    type: 'POST',
                    url: '/universal/remove-notification/',
                    data: {
                        'receiver': receiver,
                        'type': 'notification-id',
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'notification_id': notificationId,
                    },
                    success: function(response) {
                        console.log(response.message);
                        var notification = $(`#stored-notification-${notificationId}`);
                        notification.remove();
                        var notificationCounter = $('#notification-counter');
                        var newCount = parseInt(notificationCounter.text()) - 1;

                        if (newCount <= 0) {
                            notificationCounter.text('').hide();
                            $('#bell-icon').removeClass('bi-bell-fill').addClass('bi-bell');
                        } else {
                            notificationCounter.text(newCount);
                        }
                    }
                });
            });

            $(`#read-notification-${notificationId}`).click(function() {
                $.ajax({
                    type: 'POST',
                    url: '/universal/remove-notification/',
                    data: {
                        'receiver': receiver,
                        'type': 'notification-id',
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'notification_id': notificationId,
                    },
                    success: function(response) {
                        console.log(response.message);
                        var domain = window.location.origin;
                        var path = `/chat/${response.notification_chatroom_name}/${response.notification_chatroom_id}`
                        window.location.href = domain + path
                    }
                });
            });
        }
        $(document).ready(function() {
            if ('{{ notification_count }}' == '0') {
                var notification_counter = $('#notification-counter');
                notification_counter.text('').hide();
                var notification_bell = $('#bell-icon');
                notification_bell.removeClass('bi-bell-fill').addClass('bi-bell');
            } else {
                var notificationCounter = $('#notification-counter');
                notificationCounter.text('{{ notification_count }}').show();
                $('#bell-icon').removeClass('bi-bell').addClass('bi-bell-fill');
            }
        });
        connectMessageSocket();
        connectNotificationSocket();
    </script>
    <script>
        $(document).ready(function () {
            $('#message').keydown(function (e) {
                if (e.keyCode == 13 ) {
                    // split this into 3 cases: text, image, and video messages
                    let isReply // initalization of the isReply variable
                    // for text
                    if ($('#is-text').val() === 'true') {
                        var message = $('#message').val() // get the message
                        if ($('#is-reply').val() === 'true') { // if the hidden input containing the state of replying is true
                            isReply = 'true' 
                            replyMessageId = $('#reply-information-holder').data('message-id'); // get the message ID of the message that this user is replying to.
                        }
                        else {
                            isReply = 'false'
                            replyMessageId = null
                        }
                        if (message != '') {
                            $.ajax({
                                type: 'POST',
                                url: '/chat/message-sent-text/',
                                data: {
                                    'chat-room-name': '{{room.name}}',
                                    'chat-room-id': '{{room.id}}',
                                    'text-message': message,
                                    'is-reply': isReply,
                                    'replying-to-id': replyMessageId,
                                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                                },
                                success: function(response) {
                                    $('#message').val('');
                                    if ($('#reply-prompt')) { // remove reply prompt if the user was replying
                                        $('#reply-prompt').remove();
                                        $('#is-reply').val('false');
                                    }
                                    notificationSocket.send(JSON.stringify({
                                        'notification_ids': response.notification_ids,
                                    }));
                                    if (response.is_reply === 'true') { // Send over specific data for the case of a reply.
                                        var replyId = response.reply_id;
                                        messageSocket.send(JSON.stringify({
                                            'text': message,
                                            'message_type': 'text',
                                            'message_id': response.message_id,
                                            'is_reply': response.is_reply,
                                            'reply_id': response.reply_id,
                                        }));
                                    } else {
                                        messageSocket.send(JSON.stringify({
                                            'text': message,
                                            'message_type': 'text',
                                            'message_id': response.message_id,
                                            'is_reply': response.is_reply,
                                        }));
                                    }
                                }
                            })
                        }
                    } 
                    else if ($('#is-image').val() === 'true') { // for image
                        var imageInput = $('#image-file-field')[0];
                        var image = imageInput.files[0];
                        console.log(image)
                        if ($('#is-reply').val() === 'true') { // if the hidden input containing the state of replying is true
                            isReply = 'true' 
                            replyMessageId = $('#reply-information-holder').data('message-id'); // get the message ID of the message that this user is replying to.
                        }
                        else {
                            isReply = 'false'
                            replyMessageId = null
                        }
                        if (image) {
                            var imageFormData = new FormData();

                            imageFormData.append('image', image);
                            imageFormData.append('is_reply', isReply);
                            imageFormData.append('replying_to_id', replyMessageId);
                            imageFormData.append('chat_room_id', '{{room.id}}');
                            imageFormData.append('sender', '{{username}}');
                            imageFormData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                            $.ajax({
                                type: 'POST',
                                url: '/chat/message-sent-image/',
                                processData: false, // Important!
                                contentType: false, // Important!
                                data: imageFormData,
                                success: function(response) {
                                    console.log('message sent and saved!');

                                    // CSS changes in the event of a message being sent
                                    if ($('#reply-prompt')) { // remove reply prompt if the user was replying
                                        $('#reply-prompt').remove();
                                        $('#image-prompt').remove();
                                        $('#multi-input-wrapper').remove();
                                        $('#is-reply').val('false');
                                        $('#is-image').val('false');
                                        $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                        $('#is-text').val('true');
                                    } else {
                                        $('#image-prompt').remove();
                                        $('#is-image').val('false');
                                        $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                        $('#is-text').val('true');
                                    }

                                    // Notification socket
                                    notificationSocket.send(JSON.stringify({
                                        'notification_ids': response.notification_ids,
                                    }));

                                    // Message sockets
                                    if (response.is_reply === 'true') {
                                        messageSocket.send(JSON.stringify({
                                            'message_type': 'image',
                                            'message_id': response.message_id,
                                            'is_reply': response.is_reply,
                                            'reply_id': response.reply_id,
                                        }))
                                    } else {
                                        messageSocket.send(JSON.stringify({
                                            'message_type': 'image',
                                            'message_id': response.message_id,
                                            'is_reply': response.is_reply,
                                        }))
                                    }
                                }
                            })
                        } else {
                            console.log('invalid image');
                        }
                    }
                    else if ($('#is-video').val() === 'true') { // for video
                        var videoInput = $('#video-file-field')[0];
                        var video = videoInput.files[0];
                        console.log(video)
                        if ($('#is-reply').val() === 'true') { // if the hidden input containing the state of replying is true
                            isReply = 'true' 
                            replyMessageId = $('#reply-information-holder').data('message-id'); // get the message ID of the message that this user is replying to.
                        }
                        else {
                            isReply = 'false'
                            replyMessageId = null
                        }
                        if (video) {
                            var videoFormData = new FormData();

                            videoFormData.append('video', video);
                            videoFormData.append('is_reply', isReply);
                            videoFormData.append('replying_to_id', replyMessageId);
                            videoFormData.append('chat_room_id', '{{room.id}}');
                            videoFormData.append('sender', '{{username}}');
                            videoFormData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                            $.ajax({
                                type: 'POST',
                                url: '/chat/message-sent-video/',
                                processData: false, // Important!
                                contentType: false, // Important!
                                data: videoFormData,
                                success: function(response) {
                                    console.log('message sent and saved!');

                                    // CSS changes in the event of a message being sent
                                    if ($('#reply-prompt')) { // remove reply prompt if the user was replying
                                        $('#reply-prompt').remove();
                                        $('#video-prompt').remove();
                                        $('#multi-input-wrapper').remove();
                                        $('#is-reply').val('false');
                                        $('#is-video').val('false');
                                        $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                        $('#is-text').val('true');
                                    } else {
                                        $('#video-prompt').remove();
                                        $('#is-video').val('false');
                                        $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                        $('#is-text').val('true');
                                    }

                                    // Notification socket
                                    notificationSocket.send(JSON.stringify({
                                        'notification_ids': response.notification_ids,
                                    }));

                                    // Message sockets
                                    if (response.is_reply === 'true') {
                                        messageSocket.send(JSON.stringify({
                                            'message_type': 'video',
                                            'message_id': response.message_id,
                                            'is_reply': response.is_reply,
                                            'reply_id': response.reply_id,
                                        }))
                                    } else {
                                        messageSocket.send(JSON.stringify({
                                            'message_type': 'video',
                                            'message_id': response.message_id,
                                            'is_reply': response.is_reply,
                                        }))
                                    }
                                }
                            })
                        } else {
                            console.log('invalid video');
                        }
                    }
                }
            })
            $('#send').click(function () {
                // split this into 3 cases: text, image, and video messages
                let isReply // initalization of the isReply variable
                // for text
                if ($('#is-text').val() === 'true') {
                    var message = $('#message').val() // get the message
                    if ($('#is-reply').val() === 'true') { // if the hidden input containing the state of replying is true
                        isReply = 'true' 
                        replyMessageId = $('#reply-information-holder').data('message-id'); // get the message ID of the message that this user is replying to.
                    }
                    else {
                        isReply = 'false'
                        replyMessageId = null
                    }
                    if (message != '') {
                        $.ajax({
                            type: 'POST',
                            url: '/chat/message-sent-text/',
                            data: {
                                'chat-room-name': '{{room.name}}',
                                'chat-room-id': '{{room.id}}',
                                'text-message': message,
                                'is-reply': isReply,
                                'replying-to-id': replyMessageId,
                                'csrfmiddlewaretoken': '{{ csrf_token }}',
                            },
                            success: function(response) {
                                console.log(response.is_reply)
                                $('#message').val('');
                                if ($('#reply-prompt')) { // remove reply prompt if the user was replying
                                    $('#reply-prompt').remove();
                                    $('#is-reply').val('false');
                                }
                                notificationSocket.send(JSON.stringify({
                                    'notification_ids': response.notification_ids,
                                }));
                                if (response.is_reply === 'true') { // Send over specific data for the case of a reply.
                                    var replyId = response.reply_id;
                                    messageSocket.send(JSON.stringify({
                                        'text': message,
                                        'message_type': 'text',
                                        'message_id': response.message_id,
                                        'is_reply': response.is_reply,
                                        'reply_id': response.reply_id,
                                    }));
                                } else {
                                    messageSocket.send(JSON.stringify({
                                        'text': message,
                                        'message_type': 'text',
                                        'message_id': response.message_id,
                                        'is_reply': response.is_reply,
                                    }));
                                }
                            }
                        })
                    }
                } 
                else if ($('#is-image').val() === 'true') { // for image
                    var imageInput = $('#image-file-field')[0];
                    var image = imageInput.files[0];
                    console.log(image)
                    if ($('#is-reply').val() === 'true') { // if the hidden input containing the state of replying is true
                        isReply = 'true' 
                        replyMessageId = $('#reply-information-holder').data('message-id'); // get the message ID of the message that this user is replying to.
                    }
                    else {
                        isReply = 'false'
                        replyMessageId = null
                    }
                    if (image) {
                        // special data passing for images
                        var imageFormData = new FormData();

                        imageFormData.append('image', image);
                        imageFormData.append('is_reply', isReply);
                        imageFormData.append('replying_to_id', replyMessageId);
                        imageFormData.append('chat_room_id', '{{room.id}}');
                        imageFormData.append('sender', '{{username}}');
                        imageFormData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                        $.ajax({
                            type: 'POST',
                            url: '/chat/message-sent-image/',
                            processData: false, // Important!
                            contentType: false, // Important!
                            data: imageFormData,
                            success: function(response) {
                                console.log('message sent and saved!');

                                // CSS changes in the event of a message being sent
                                if ($('#reply-prompt')) { // remove reply prompt if the user was replying
                                    $('#reply-prompt').remove();
                                    $('#image-prompt').remove();
                                    $('#multi-input-wrapper').remove();
                                    $('#is-reply').val('false');
                                    $('#is-image').val('false');
                                    $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                    $('#is-text').val('true');
                                } else {
                                    $('#image-prompt').remove();
                                    $('#is-image').val('false');
                                    $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                    $('#is-text').val('true');
                                }

                                // Notification socket
                                notificationSocket.send(JSON.stringify({
                                    'notification_ids': response.notification_ids,
                                }));

                                // Message sockets
                                if (response.is_reply === 'true') {
                                    messageSocket.send(JSON.stringify({
                                        'message_type': 'image',
                                        'message_id': response.message_id,
                                        'is_reply': response.is_reply,
                                        'reply_id': response.reply_id,
                                    }))
                                } else {
                                    messageSocket.send(JSON.stringify({
                                        'message_type': 'image',
                                        'message_id': response.message_id,
                                        'is_reply': response.is_reply,
                                    }))
                                }
                            }
                        })
                    } else {
                        console.log('invalid image');
                    }
                }
                else if ($('#is-video').val() === 'true') { // for video
                    var videoInput = $('#video-file-field')[0];
                    var video = videoInput.files[0];
                    console.log(video)
                    if ($('#is-reply').val() === 'true') { // if the hidden input containing the state of replying is true
                        isReply = 'true' 
                        replyMessageId = $('#reply-information-holder').data('message-id'); // get the message ID of the message that this user is replying to.
                    }
                    else {
                        isReply = 'false'
                        replyMessageId = null
                    }
                    if (video) {
                        var videoFormData = new FormData();

                        videoFormData.append('video', video);
                        videoFormData.append('is_reply', isReply);
                        videoFormData.append('replying_to_id', replyMessageId);
                        videoFormData.append('chat_room_id', '{{room.id}}');
                        videoFormData.append('sender', '{{username}}');
                        videoFormData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                        $.ajax({
                            type: 'POST',
                            url: '/chat/message-sent-video/',
                            processData: false, // Important!
                            contentType: false, // Important!
                            data: videoFormData,
                            success: function(response) {
                                console.log('message sent and saved!');

                                // CSS changes in the event of a message being sent
                                if ($('#reply-prompt')) { // remove reply prompt if the user was replying
                                    $('#reply-prompt').remove();
                                    $('#video-prompt').remove();
                                    $('#multi-input-wrapper').remove();
                                    $('#is-reply').val('false');
                                    $('#is-video').val('false');
                                    $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                    $('#is-text').val('true');
                                } else {
                                    $('#video-prompt').remove();
                                    $('#is-video').val('false');
                                    $('#message-div').append(`<input type="text" id="message" class="form-control pb-3 p-4">`);
                                    $('#is-text').val('true');
                                }

                                // Notification socket
                                notificationSocket.send(JSON.stringify({
                                    'notification_ids': response.notification_ids,
                                }));

                                // Message sockets
                                if (response.is_reply === 'true') {
                                    messageSocket.send(JSON.stringify({
                                        'message_type': 'video',
                                        'message_id': response.message_id,
                                        'is_reply': response.is_reply,
                                        'reply_id': replyId,
                                    }))
                                } else {
                                    messageSocket.send(JSON.stringify({
                                        'message_type': 'video',
                                        'message_id': response.message_id,
                                        'is_reply': response.is_reply,
                                    }))
                                }
                            }
                        })
                    } else {
                        console.log('invalid video');
                    }
                }
            });
            $('#conversation-contents').on('click', '.reply', function () { // when the reply button is pressed
                // Get relevant data stored inside of the button's data attributes
                messageId = $(this).data('message-id');
                senderUsername = $(this).data('message-sender');
                message = $(this).data('message');
                setupReply(messageId, senderUsername, message); // call the setupReply function and pass useful information though.
            })
            $('#init-image').click(function () {
                const messageDiv = $('#message-div');
                const isText = $('#is-text');
                const isImage = $('#is-image');
                const isVideo = $('#is-video');
                const isReply = $('#is-reply');
                const messageTextBox = $('#message');
                const messageInputHtml = `<input type="text" id="message" class="form-control pb-3 p-4">`
                if (isImage.val() === 'false') {
                    if (isReply.val() === 'false') { // if false, display only the image prompt
                        if (isVideo.val() === 'true') {
                            $('#video-prompt').remove(); // can only do either an image or a video at once.
                            isVideo.val('false');
                        }
                        messageTextBox.remove(); // no text allowed as well
                        isText.val('false');
                        // image prompt
                        messageDiv.append(`
                            <div class="card mt-1" id="image-prompt" style="border: none;">
                                <div class="card-header pb-4" style="border-bottom: none;">
                                    <div class="row">
                                        <div class="col">
                                            <label for="image-file-field" class="form-label">Place image here</label>
                                            <input class="form-control" type="file" id="image-file-field">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `)
                        isImage.val('true'); // set the hidden element to true
                        $('html, body').animate({ scrollTop: $(document).height() }, 'fast'); // animation for better GUI
                    } else { // display both the image prompt and the reply prompt
                        if (isVideo.val() === 'true') {
                            $('#video-prompt').remove();
                            isVideo.val('false');
                        }
                        messageTextBox.remove();
                        isText.val('false');
                        var replyInput = $('#reply-prompt').detach();
                        var replyInputHtml = replyInput.prop('outerHTML');
                        var imageInputHtml = `
                            <div class="card mt-1" id="image-prompt" style="border: none;">
                                <div class="card-header pb-4" style="border-bottom: none;">
                                    <div class="row">
                                        <div class="col">
                                            <label for="image-file-field" class="form-label">Place image here</label>
                                            <input class="form-control" type="file" id="image-file-field">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `
                        // wrapper to nicely format both prompts
                        messageDiv.append(`
                            <div class="row" id='multi-input-wrapper'>
                                <div class="col-6">
                                    ` + replyInputHtml + `
                                </div>
                                <div class="col-6">
                                    ` + imageInputHtml + `
                                </div>
                            </div>
                        `)
                        isImage.val('true');
                        $('html, body').animate({ scrollTop: $(document).height() }, 'fast'); // animation for better GUI
                    }
                } else { // removal of the image prompt
                    if (isReply.val() === 'false') {
                        $('#image-prompt').remove();
                        messageDiv.append(messageInputHtml) // bring back the text box
                        isText.val('true'); 
                        isImage.val('false');
                    } else {
                        var replyInput = $('#reply-prompt').detach();
                        var replyInputHtml = replyInput.prop('outerHTML');
                        $('#multi-input-wrapper').remove();
                        $('#image-prompt').remove();
                        messageDiv.append(messageInputHtml)
                        isText.val('true');
                        messageDiv.append(replyInputHtml);
                        isImage.val('false');
                    }
                }
            })
            $('#init-video').click(function () {
                const messageDiv = $('#message-div');
                const isText = $('#is-text');
                const isImage = $('#is-image');
                const isVideo = $('#is-video');
                const isReply = $('#is-reply');
                const messageTextBox = $('#message');
                const messageInputHtml = `<input type="text" id="message" class="form-control pb-3 p-4">`
                if (isVideo.val() === 'false') {
                    if (isReply.val() === 'false') {
                        if (isImage.val() === 'true') {
                            $('#image-prompt').remove();
                            isImage.val('false');
                        }
                        messageTextBox.remove();
                        isText.val('false');
                        messageDiv.append(`
                            <div class="card mt-1" id="video-prompt" style="border: none;">
                                <div class="card-header pb-4" style="border-bottom: none;">
                                    <div class="row">
                                        <div class="col">
                                            <label for="video-file-field" class="form-label">Place video here</label>
                                            <input class="form-control" type="file" id="video-file-field">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `)
                        isVideo.val('true');
                        $('html, body').animate({ scrollTop: $(document).height() }, 'fast'); // animation for better GUI
                    } else {
                        if (isImage.val() === 'true') {
                            $('#image-prompt').remove();
                            isImage.val('false');
                        }
                        messageTextBox.remove();
                        isText.val('false');
                        var replyInput = $('#reply-prompt').detach();
                        var replyInputHtml = replyInput.prop('outerHTML');
                        var videoInputHtml = `
                            <div class="card mt-1" id="video-prompt" style="border: none;">
                                <div class="card-header pb-4" style="border-bottom: none;">
                                    <div class="row">
                                        <div class="col">
                                            <label for="video-file-field" class="form-label">Place video here</label>
                                            <input class="form-control" type="file" id="video-file-field">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `
                        messageDiv.append(`
                            <div class="row" id='multi-input-wrapper'>
                                <div class="col-6">
                                    ` + replyInputHtml + `
                                </div>
                                <div class="col-6">
                                    ` + videoInputHtml + `
                                </div>
                            </div>
                        `)
                        isVideo.val('true');
                        $('html, body').animate({ scrollTop: $(document).height() }, 'fast'); // animation for better GUI
                    }
                } else {
                    if (isReply.val() === 'false') {
                        $('#video-prompt').remove();
                        messageDiv.append(messageInputHtml);
                        isText.val('true');
                        isVideo.val('false');
                    } else {
                        var replyInput = $('#reply-prompt').detach();
                        var replyInputHtml = replyInput.prop('outerHTML');
                        $('#multi-input-wrapper').remove();
                        $('#video-prompt').remove();
                        messageDiv.append(messageInputHtml);
                        isText.val('true');
                        messageDiv.append(replyInputHtml);
                        isVideo.val('false');
                    }
                }
            })
        });
    </script>
</div>
<!-- To store notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="inbox">

</div>

{% endblock %}
